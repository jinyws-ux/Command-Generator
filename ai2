import streamlit as st
from abc import ABC, abstractmethod
from typing import List, Dict, Any
from jinja2 import Template
import shlex

# ==========================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šå®šä¹‰â€œå‘½ä»¤ç”Ÿæˆå™¨â€çš„æ ‡å‡† (åŸºç±»)
# ==========================================
class CommandStrategy(ABC):
    @property
    @abstractmethod
    def name(self) -> str:
        """ä¸‹æ‹‰èœå•é‡Œæ˜¾ç¤ºçš„åå­—"""
        pass

    @property
    @abstractmethod
    def description(self) -> str:
        """åŠŸèƒ½æè¿°"""
        pass

    @abstractmethod
    def get_params_schema(self) -> List[Dict[str, Any]]:
        """å®šä¹‰è¡¨å•é•¿ä»€ä¹ˆæ ·"""
        pass

    @abstractmethod
    def generate(self, params: Dict[str, Any]) -> str:
        """æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆå‘½ä»¤"""
        pass

# ==========================================
# ç¬¬äºŒéƒ¨åˆ†ï¼šå…·ä½“å®ç°çš„å‘½ä»¤ (Linux & SQL ç¤ºä¾‹)
# ==========================================

# ç¤ºä¾‹ 1: Linux æŸ¥æ‰¾å¤§æ–‡ä»¶
class FindLargeFilesCommand(CommandStrategy):
    name = "Linux: æŸ¥æ‰¾å¤§æ–‡ä»¶"
    description = "åœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾è¶…è¿‡ç‰¹å®šå¤§å°çš„æ–‡ä»¶ï¼Œæ”¯æŒåˆ é™¤æˆ–æ‰“å°ã€‚"

    def get_params_schema(self):
        return [
            {"name": "path", "label": "æœç´¢è·¯å¾„", "type": "text", "default": "/var/log", "help": "ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ /home/user"},
            {"name": "size_mb", "label": "æœ€å°ä½“ç§¯(MB)", "type": "number", "default": 100},
            {"name": "file_type", "label": "æ–‡ä»¶åç¼€", "type": "text", "default": ".log", "help": "ä¾‹å¦‚: .log (ç•™ç©ºåˆ™åŒ¹é…æ‰€æœ‰)"},
            {"name": "action", "label": "æ‰§è¡ŒåŠ¨ä½œ", "type": "select", "options": ["åªæ˜¾ç¤º (print)", "åˆ é™¤ (delete)", "è¯¦æƒ… (ls -lh)"]}
        ]

    def generate(self, params):
        # ä½¿ç”¨ Jinja2 æ¨¡æ¿å¤„ç†é€»è¾‘
        template_str = """
find {{ path }} -type f -size +{{ size }}M
{%- if file_type %} -name "*{{ file_type }}" {% endif -%}
{%- if action == 'åˆ é™¤ (delete)' %} -delete
{%- elif action == 'è¯¦æƒ… (ls -lh)' %} -exec ls -lh {} +
{%- else %} -print
{%- endif -%}
        """
        
        # å®‰å…¨å¤„ç†è·¯å¾„ï¼Œé˜²æ­¢ rm -rf / è¿™ç§æ³¨å…¥
        safe_path = shlex.quote(params.get("path", "."))
        
        t = Template(template_str)
        return t.render(
            path=safe_path,
            size=params.get("size_mb"),
            file_type=params.get("file_type", "").strip(),
            action=params.get("action")
        ).strip().replace('\n', ' ') # å»æ‰æ¢è¡Œï¼Œå˜æˆå•è¡Œå‘½ä»¤

# ç¤ºä¾‹ 2: Oracle æ•°æ®æ³µå¯¼å‡º (æ¨¡æ‹Ÿ SQL/DBA åœºæ™¯)
class OracleExpdpCommand(CommandStrategy):
    name = "Oracle: æ•°æ®æ³µå¯¼å‡º (expdp)"
    description = "ç”Ÿæˆ Oracle expdp æ•°æ®å¯¼å‡ºå‘½ä»¤ã€‚"

    def get_params_schema(self):
        return [
            {"name": "user", "label": "ç”¨æˆ·å", "type": "text", "default": "system"},
            {"name": "pwd", "label": "å¯†ç ", "type": "text", "default": "oracle"},
            {"name": "schemas", "label": "å¯¼å‡ºæ¨¡å¼(Schema)", "type": "text", "default": "SCOTT,HR", "help": "å¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”"},
            {"name": "parallel", "label": "å¹¶è¡Œåº¦", "type": "number", "default": 4},
            {"name": "compression", "label": "å¼€å¯å‹ç¼©", "type": "checkbox", "default": True}
        ]
    
    def generate(self, params):
        template_str = """
expdp {{ user }}/{{ pwd }} \
schemas={{ schemas }} \
directory=DATA_PUMP_DIR \
dumpfile=exp_%U.dmp \
logfile=exp.log \
parallel={{ parallel }} \
{%- if compression %} compression=ALL {% endif -%}
        """
        t = Template(template_str)
        return t.render(
            user=params.get("user"),
            pwd=params.get("pwd"),
            schemas=params.get("schemas"),
            parallel=params.get("parallel"),
            compression=params.get("compression")
        ).strip()

# ==========================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸»ç¨‹åº UI
# ==========================================
def main():
    st.set_page_config(page_title="Ops Generator", layout="wide")
    st.title("ğŸ› ï¸ è¿ç»´å‘½ä»¤ç”Ÿæˆå™¨")

    # --- 1. æ³¨å†Œä½ çš„å‘½ä»¤ ---
    # åœ¨è¿™é‡ŒæŠŠä¸Šé¢çš„ç±»å®ä¾‹åŒ–ï¼Œæ”¾è¿›åˆ—è¡¨é‡Œ
    available_commands = [
        FindLargeFilesCommand(),
        OracleExpdpCommand()
    ]
    
    # è½¬æ¢ä¸ºå­—å…¸æ–¹ä¾¿æŸ¥æ‰¾: {"Linux...": instance, "Oracle...": instance}
    cmd_map = {cmd.name: cmd for cmd in available_commands}

    # --- 2. ä¾§è¾¹æ é€‰æ‹© ---
    with st.sidebar:
        st.header("æ§åˆ¶å°")
        selected_name = st.selectbox("é€‰æ‹©åŠŸèƒ½æ¨¡æ¿", options=cmd_map.keys())
        st.markdown("---")
        st.markdown("**æç¤º**ï¼š\nç”Ÿæˆåè¯·ä»”ç»†æ ¸å¯¹å‘½ä»¤ï¼Œé˜²æ­¢è¯¯æ“ä½œã€‚")

    # --- 3. åŠ¨æ€æ¸²æŸ“åŒºåŸŸ ---
    if selected_name:
        strategy = cmd_map[selected_name]
        
        st.subheader(f"ğŸ“ {selected_name}")
        st.caption(strategy.description)
        st.markdown("---")

        # è·å–è¯¥å‘½ä»¤éœ€è¦çš„è¡¨å•ç»“æ„
        schema = strategy.get_params_schema()
        user_inputs = {}

        # åŠ¨æ€åˆ›å»ºè¡¨å•
        with st.form("gen_form"):
            col1, col2 = st.columns(2)
            
            for idx, field in enumerate(schema):
                # ç®€å•çš„äº¤æ›¿æ’ç‰ˆ
                current_col = col1 if idx % 2 == 0 else col2
                
                ftype = field.get("type")
                label = field.get("label")
                key = field.get("name")
                default = field.get("default")
                help_txt = field.get("help", "")

                if ftype == "text":
                    user_inputs[key] = current_col.text_input(label, value=default, help=help_txt)
                elif ftype == "number":
                    user_inputs[key] = current_col.number_input(label, value=default or 0, step=1, help=help_txt)
                elif ftype == "select":
                    user_inputs[key] = current_col.selectbox(label, options=field.get("options"), help=help_txt)
                elif ftype == "checkbox":
                    user_inputs[key] = current_col.checkbox(label, value=default or False, help=help_txt)

            st.markdown("<br>", unsafe_allow_html=True)
            submitted = st.form_submit_button("âš¡ ç”Ÿæˆå‘½ä»¤", use_container_width=True)

        # --- 4. ç»“æœè¾“å‡º ---
        if submitted:
            try:
                result_cmd = strategy.generate(user_inputs)
                st.success("ç”Ÿæˆå®Œæ¯•")
                st.code(result_cmd, language="bash")
            except Exception as e:
                st.error(f"ç”Ÿæˆå‡ºé”™: {e}")

if __name__ == "__main__":
    main()

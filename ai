æ²¡é—®é¢˜ï¼Œè¿™æ˜¯v6.0 æœ€ç»ˆå®Œæ•´ç‰ˆçš„ä»£ç ã€‚è¿™ä¸€ç‰ˆé›†æˆäº†ä½ è¦æ±‚çš„æ‰€æœ‰åŠŸèƒ½ï¼š
 * Grafana é£æ ¼æ ‡ç­¾ç³»ç»Ÿï¼šç»´åº¦ï¼ˆKeyï¼‰+ å€¼ï¼ˆValueï¼‰+ è¯­ä¹‰åŒ–é¢œè‰²ã€‚
 * é«˜çº§æ ‡ç­¾ç®¡ç†å™¨ï¼šå·¦ä¾§ç®¡ç†ç»´åº¦ï¼Œå³ä¾§æ‰¹é‡ç¼–è¾‘å€¼ï¼Œå¸¦å®æ—¶é¢„è§ˆã€‚
 * å¸ƒå±€é‡æ„ï¼šç´§å‡‘ã€å¯¹é½ã€å•†ä¸šçº§ UIã€‚
 * å…¨å…¼å®¹ä¿®å¤ï¼šç§»é™¤äº†æ‰€æœ‰å¯¼è‡´æŠ¥é”™çš„å‚æ•°ï¼ŒåŠ å…¥äº†ç¯å¢ƒè·¯å¾„è‡ªåŠ¨ä¿®å¤ã€‚
è¯·å®Œå…¨æ¸…ç©ºä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼ˆä¿ç•™ requirements.txtï¼‰ï¼Œç„¶åæŒ‰é¡ºåºæ–°å»ºè¿™ 4 ä¸ªæ–‡ä»¶ã€‚
ğŸ“‚ 1. core/config_manager.py
(è´Ÿè´£é…ç½®çš„ç»å¯¹è·¯å¾„è¯»å–ã€åŒåº“åˆå¹¶ã€å¼ºåˆ¶æ ‡è®°æ¥æº)
import json
import os

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        # å¼ºåˆ¶ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œè§£å†³ IDE æ‰§è¡Œè·¯å¾„ä¸ä¸€è‡´å¯¼è‡´çš„è¯»å–å¤±è´¥
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.team_path = os.path.join(base_dir, team_path)
        self.user_path = os.path.join(base_dir, user_path)
        
        self._init_file(self.team_path)
        self._init_file(self.user_path)

    def _init_file(self, path):
        if not os.path.exists(path):
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump({}, f)
            except: pass

    def _load_json(self, path: str):
        if not os.path.exists(path): return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except: return {}

    def _save_json(self, path: str, data):
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except Exception as e:
            print(f"Save Error: {e}")

    def get_all_templates(self):
        merged = {}
        # 1. Team Config
        for k, v in self._load_json(self.team_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'team'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        # 2. User Config
        for k, v in self._load_json(self.user_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'personal'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        return merged

    def save_template(self, tid, data, target_source):
        path = self.team_path if target_source == 'team' else self.user_path
        curr = self._load_json(path)
        
        curr[tid] = {
            "name": data.get("name"),
            "desc": data.get("desc", ""),
            "tags": data.get("tags", []),
            "template": data.get("template", ""),
            "params": data.get("params", []),
            "updated_at": "now"
        }
        self._save_json(path, curr)

ğŸ“‚ 2. core/tag_manager.py
(è´Ÿè´£æ ‡ç­¾æ•°æ®ç»“æ„ã€ç»´åº¦æå–ã€é‡å‘½å)
import json
import os

class TagManager:
    def __init__(self, tag_file="tags.json"):
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.file_path = os.path.join(base_dir, tag_file)
        
        if not os.path.exists(self.file_path):
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({}, f)

    def get_all_tags(self):
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except: return {}

    def save_all_tags(self, tags_dict):
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(tags_dict, f, indent=4, ensure_ascii=False)

    def get_dimensions(self):
        """æå–æ‰€æœ‰ç»´åº¦ (Category)"""
        tags = self.get_all_tags()
        # å³ä½¿æ²¡æœ‰æ ‡ç­¾ï¼Œä¹Ÿé»˜è®¤è¿”å› General
        dims = set(t.get('category', 'General') for t in tags.values())
        return sorted(list(dims)) if dims else ['General']
    
    def rename_dimension(self, old_name, new_name):
        """é‡å‘½åç»´åº¦"""
        tags = self.get_all_tags()
        changed = False
        for t in tags.values():
            if t.get('category') == old_name:
                t['category'] = new_name
                changed = True
        if changed: self.save_all_tags(tags)

ğŸ“‚ 3. main.py
(å…¥å£æ–‡ä»¶ï¼ŒåŒ…å«æ ·å¼é¢„è®¾ã€å·¦ä¾§å¯¼èˆªã€æ ‡ç­¾ç®¡ç†å™¨ v6.0)
import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app
import pandas as pd
import uuid

# ==========================================
# ğŸ¨ 1. è¯­ä¹‰åŒ–è‰²ç›˜ä¸å…¨å±€é…ç½®
# ==========================================
# Grafana é£æ ¼é¢„è®¾
COLOR_MAP = {
    "ğŸ”´ Critical (é«˜å±)": "#ff4d4f",
    "ğŸŸ  Warning (è­¦å‘Š)": "#faad14",
    "ğŸŸ¡ Caution (æ³¨æ„)": "#fadb14",
    "ğŸŸ¢ Success (æ­£å¸¸)": "#52c41a",
    "ğŸ”µ Info (ä¿¡æ¯)": "#1890ff",
    "ğŸŸ£ Discovery (å‘ç°)": "#722ed1",
    "ğŸŸ¦ Geom (è“ç»¿)": "#13c2c2",
    "âšª Neutral (ç°)": "#8c8c8c",
    "âš« Dark (é»‘)": "#262626",
}
HEX_TO_LABEL = {v: k for k, v in COLOR_MAP.items()}

st.set_page_config(layout="wide", page_title="Ops Console", page_icon="âš¡")

st.markdown("""
<style>
    .stApp { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .block-container { padding-top: 1.5rem; }
    [data-testid="stSidebar"] { background-color: #f8f9fa; border-right: 1px solid #e5e5e5; }
    [data-testid="stDataFrame"] { border: 1px solid #e0e0e0; border-radius: 6px; }
    /* éšè—é»˜è®¤èœå• */
    #MainMenu {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

# ==========================================
# ğŸš€ 2. ä¸»ç¨‹åºå…¥å£
# ==========================================
def main():
    cfg_mgr = ConfigManager("team_config.json", "user_config.json")
    tag_mgr = TagManager("tags.json")

    with st.sidebar:
        st.subheader("âš¡ Ops Platform")
        # ç§»é™¤ key å‚æ•°ä»¥å…¼å®¹æ—§ç‰ˆ SAC
        menu = sac.menu([
            sac.MenuItem('å·¥ä½œå°', icon='columns-gap', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('é…ç½®ä¸­å¿ƒ', icon='sliders', children=[
                sac.MenuItem('æ ‡ç­¾ä½“ç³»', icon='tags'),
            ]),
        ], color='indigo', open_all=True)

    # è·¯ç”±åˆ†å‘
    if menu == 'å‘½ä»¤ç”Ÿæˆå™¨':
        cmd_app.render(cfg_mgr, tag_mgr)
        
    elif menu == 'æ ‡ç­¾ä½“ç³»':
        render_tag_system(tag_mgr)
        
    else:
        st.info("Select a module to start.")

# ==========================================
# ğŸ·ï¸ 3. æ ‡ç­¾è®¾è®¡ç³»ç»Ÿ (Tag Design System)
# ==========================================
def render_tag_system(tag_mgr):
    st.title("ğŸ·ï¸ æ ‡ç­¾è®¾è®¡ç³»ç»Ÿ")
    st.caption("åœ¨æ­¤ç»Ÿä¸€ç®¡ç†å¹³å°çš„åˆ†ç±»ç»´åº¦ä¸æ ‡ç­¾æ ·å¼ã€‚")

    all_tags = tag_mgr.get_all_tags()
    dimensions = tag_mgr.get_dimensions()
    
    # å¸ƒå±€ï¼šå·¦ä¾§ç»´åº¦å¯¼èˆª | å³ä¾§æ ‡ç­¾å·¥ä½œåŒº
    c_nav, c_work = st.columns([1, 4], gap="large")

    # === å·¦ä¾§ï¼šç»´åº¦ç®¡ç† ===
    with c_nav:
        st.subheader("ç»´åº¦ (Dimension)")
        st.caption("å³æ ‡ç­¾çš„åˆ†ç±» (Key)")
        
        # çŠ¶æ€ä¿æŒ
        if 'curr_dim' not in st.session_state: st.session_state['curr_dim'] = dimensions[0]
        if st.session_state['curr_dim'] not in dimensions: st.session_state['curr_dim'] = dimensions[0]

        # ç»´åº¦é€‰æ‹©
        selected_dim = st.radio("é€‰æ‹©ç»´åº¦", dimensions, label_visibility="collapsed")
        st.session_state['curr_dim'] = selected_dim
        
        st.divider()
        
        # ç»´åº¦æ“ä½œåŒº
        with st.expander("âš™ï¸ ç®¡ç†ç»´åº¦", expanded=False):
            new_dim_name = st.text_input("æ–°å»ºç»´åº¦å", placeholder="å¦‚: Database")
            if st.button("â• æ·»åŠ ç»´åº¦", use_container_width=True):
                if new_dim_name and new_dim_name not in dimensions:
                    # åˆ›å»ºå ä½æ ‡ç­¾
                    tag_mgr.save_all_tags({**all_tags, str(uuid.uuid4())[:8]: {"name": "Default", "category": new_dim_name, "color": "#8c8c8c"}})
                    st.toast(f"ç»´åº¦ {new_dim_name} å·²åˆ›å»º")
                    st.rerun()
            
            st.caption("é‡å‘½åå½“å‰ç»´åº¦")
            rename_val = st.text_input("æ–°åç§°", value=selected_dim)
            if st.button("é‡å‘½å", use_container_width=True):
                if rename_val and rename_val != selected_dim:
                    tag_mgr.rename_dimension(selected_dim, rename_val)
                    st.session_state['curr_dim'] = rename_val
                    st.rerun()

    # === å³ä¾§ï¼šæ ‡ç­¾å·¥ä½œåŒº ===
    with c_work:
        dim = st.session_state['curr_dim']
        
        # A. é¢„è§ˆåŒº
        current_tags = {tid: t for tid, t in all_tags.items() if t.get('category', 'General') == dim}
        
        r1, r2 = st.columns([3, 1])
        r1.markdown(f"### `{dim}` ä¸‹çš„æ ‡ç­¾")
        
        with st.container(border=True):
            st.caption("è§†è§‰é¢„è§ˆ (Preview)")
            if current_tags:
                preview_badges = []
                for t in current_tags.values():
                    preview_badges.append(sac.Tag(label=t['name'], color=t.get('color', '#888'), bordered=False))
                sac.tags(preview_badges, align='start')
            else:
                st.info("æš‚æ— æ ‡ç­¾")

        st.markdown("#### æ‰¹é‡ç®¡ç† (Batch Edit)")
        
        # B. æ•°æ®å‡†å¤‡
        data_list = []
        for tid, t in current_tags.items():
            hex_c = t.get('color', '#8c8c8c')
            style_name = HEX_TO_LABEL.get(hex_c, "âšª Neutral (ç°)")
            data_list.append({"id": tid, "name": t['name'], "style": style_name})
        
        if not data_list:
            data_list = [{"id": str(uuid.uuid4())[:8], "name": "", "style": "âšª Neutral (ç°)"}]
            
        df = pd.DataFrame(data_list)

        # C. ç¼–è¾‘å™¨
        edited_df = st.data_editor(
            df,
            column_config={
                "id": None,
                "name": st.column_config.TextColumn("æ ‡ç­¾å€¼ (Value)", required=True, width="medium"),
                "style": st.column_config.SelectboxColumn("æ ·å¼ (Color)", options=list(COLOR_MAP.keys()), required=True, width="medium")
            },
            num_rows="dynamic",
            use_container_width=True,
            hide_index=True,
            key=f"editor_{dim}"
        )
        
        # D. ä¿å­˜
        if st.button("ğŸ’¾ ä¿å­˜å˜æ›´", type="primary"):
            final_tags = {k: v for k, v in all_tags.items() if v.get('category', 'General') != dim}
            
            for _, row in edited_df.iterrows():
                if not row['name']: continue
                tid = row.get('id')
                if not tid or pd.isna(tid): tid = str(uuid.uuid4())[:8]
                
                final_tags[tid] = {
                    "name": row['name'],
                    "category": dim,
                    "color": COLOR_MAP.get(row['style'], "#8c8c8c")
                }
            
            tag_mgr.save_all_tags(final_tags)
            st.success(f"ç»´åº¦ `{dim}` å·²æ›´æ–°")
            st.rerun()

if __name__ == "__main__":
    main()

ğŸ“‚ 4. modules/cmd_generator/app.py
(ç´§å‡‘å¸ƒå±€ï¼ŒGrafana é£æ ¼æ ‡ç­¾å±•ç¤ºï¼Œä¿®å¤æ‰€æœ‰å…¼å®¹æ€§é—®é¢˜)
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid

def render(cfg_mgr, tag_mgr):
    # ==========================
    # 1. é¡¶éƒ¨ Header (æ¥æºåˆ‡æ¢)
    # ==========================
    c_head, c_tab = st.columns([1, 2])
    c_head.subheader("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    # å…¼å®¹å¤„ç† Segmented
    try:
        tab_label = sac.segmented(
            items=[sac.SegmentedItem(label='å›¢é˜Ÿå…¬å…±åº“', icon='buildings'), sac.SegmentedItem(label='æˆ‘çš„ç§æœ‰åº“', icon='person-lock')],
            align='end', size='sm', color='indigo'
        )
    except:
        tab_label = st.radio("Source", ['å›¢é˜Ÿå…¬å…±åº“', 'æˆ‘çš„ç§æœ‰åº“'], horizontal=True)

    source_code = 'team' if 'å›¢é˜Ÿ' in tab_label else 'personal'

    # ==========================
    # 2. ç´§å‡‘ Toolbar
    # ==========================
    with st.container(border=True):
        c1, c2, c3, c4 = st.columns([2, 2, 1, 1])
        
        all_templates = cfg_mgr.get_all_templates()
        all_tags = tag_mgr.get_all_tags()
        
        # æœç´¢
        search = c1.text_input("Search", placeholder="æœç´¢æ¨¡ç‰ˆ...", label_visibility="collapsed")
        
        # æ ‡ç­¾ç­›é€‰ (Format: Category: Name)
        tag_opts = {tid: f"{t.get('category','Gen')}: {t['name']}" for tid, t in all_tags.items()}
        sel_tags = c2.multiselect("Tags", options=tag_opts.keys(), format_func=lambda x: tag_opts[x], label_visibility="collapsed", placeholder="æŒ‰æ ‡ç­¾ç­›é€‰")
        
        # è§†å›¾
        view = c3.radio("View", ["ç½‘æ ¼", "åˆ—è¡¨"], horizontal=True, label_visibility="collapsed")
        
        # æ–°å»º
        if c4.button("â• æ–°å»º", type="primary", use_container_width=True):
            open_editor(cfg_mgr, tag_mgr, "NEW", source_code)

    # ==========================
    # 3. æ•°æ®å¤„ç†
    # ==========================
    filtered = []
    # è¿‡æ»¤ Source
    raw_list = {k: v for k, v in all_templates.items() if v.get('source') == source_code}
    
    for tid, t in raw_list.items():
        # è¿‡æ»¤ Search
        if search and search.lower() not in t['name'].lower(): continue
        
        # è¿‡æ»¤ Tags
        t_tags = t.get('tags', [])
        if sel_tags and not set(sel_tags).intersection(set(t_tags)): continue
        
        # æ„å»º Display Objects
        display_tag_objs = []
        for tg in t_tags:
            if tg in all_tags:
                meta = all_tags[tg]
                display_tag_objs.append({
                    "label": f"{meta.get('category','Gen')}: {meta['name']}", 
                    "color": meta.get('color', '#888')
                })
                
        filtered.append({
            "id": tid, "name": t['name'], "desc": t.get('desc', ''), 
            "tags": display_tag_objs, "raw": t
        })

    if not filtered:
        st.info("æš‚æ— æ•°æ®")
        return

    # ==========================
    # 4. æ¸²æŸ“è§†å›¾
    # ==========================
    if view == "åˆ—è¡¨": render_list(filtered, cfg_mgr)
    else: render_grid(filtered, cfg_mgr)

# --- è§†å›¾ç»„ä»¶ ---
def render_grid(items, cfg_mgr):
    cols = st.columns(3)
    for idx, item in enumerate(items):
        with cols[idx % 3]:
            with st.container(border=True):
                h1, h2 = st.columns([4, 1])
                h1.markdown(f"**{item['name']}**")
                if h2.button("â–¶", key=f"r_{item['id']}"): open_runner(cfg_mgr, item['id'])
                
                st.caption(item['desc'][:40])
                
                # æ¸²æŸ“ Grafana èƒ¶å›Š
                if item['tags']:
                    try:
                        sac.tags([sac.Tag(label=t['label'], color=t['color'], bordered=False) for t in item['tags'][:3]], size='xs')
                    except: pass
                
                if st.button("è®¾ç½®", key=f"e_{item['id']}", use_container_width=True):
                    open_editor(cfg_mgr, None, item['id'], item['raw']['source'])

def render_list(items, cfg_mgr):
    df_data = [{"ID": x['id'], "åç§°": x['name'], "æ ‡ç­¾": [t['label'] for t in x['tags']], "æè¿°": x['desc']} for x in items]
    df = pd.DataFrame(df_data)
    
    try: col_t = st.column_config.ListColumn("æ ‡ç­¾")
    except: col_t = st.column_config.TextColumn("æ ‡ç­¾")
    
    event = st.dataframe(df, column_config={"ID":None, "æ ‡ç­¾":col_t}, use_container_width=True, hide_index=True, on_select="rerun", selection_mode="single-row")
    if len(event.selection.rows) > 0: open_runner(cfg_mgr, df.iloc[event.selection.rows[0]]['ID'])

# --- å¼¹çª— ---
@st.dialog("æ‰§è¡Œ", width="large")
def open_runner(cfg_mgr, tid):
    data = cfg_mgr.get_all_templates().get(tid)
    if not data: return st.error("Error")
    
    c1, c2 = st.columns([1, 1.2])
    inp = {}
    with c1:
        with st.form("r"):
            for p in data.get('params',[]):
                l = p.get('label', p['name'])
                if p['type']=='select': inp[p['name']] = st.selectbox(l, [x.strip() for x in p.get("options","").split(",") if x.strip()])
                else: inp[p['name']] = st.text_input(l, value=str(p.get('default','')))
            sub = st.form_submit_button("Run", use_container_width=True, type="primary")
    with c2:
        res = "..."
        if sub:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in inp.items()}
                t = Template(data.get('template',''))
                res = t.render(**safe)
            except Exception as e: res = str(e)
        st.code(res, language="bash")

@st.dialog("ç¼–è¾‘", width="large")
def open_editor(cfg_mgr, tag_mgr, tid, source):
    if tag_mgr is None: from core.tag_manager import TagManager; tag_mgr = TagManager("tags.json")
    
    is_new = (tid == "NEW")
    data = {} if is_new else cfg_mgr.get_all_templates().get(tid, {})
    
    name = st.text_input("Name", value=data.get('name', ''))
    
    # æ ‡ç­¾é€‰æ‹©: æŒ‰åˆ†ç±»æ˜¾ç¤º
    all_tags = tag_mgr.get_all_tags()
    tag_map = {k: f"{v.get('category','Gen')}: {v['name']}" for k, v in all_tags.items()}
    
    default_tags = [t for t in data.get('tags', []) if t in tag_map]
    sel_tags = st.multiselect("Tags", options=tag_map.keys(), default=default_tags, format_func=lambda x: tag_map[x])
    
    desc = st.text_input("Desc", value=data.get('desc', ''))
    
    dp = data.get('params', [{"name": "param", "label": "Label", "type": "text", "default": "", "options": ""}])
    edf = st.data_editor(pd.DataFrame(dp), num_rows="dynamic", use_container_width=True)
    code = st.text_area("Template", value=data.get('template', ''), height=150)
    
    if st.button("Save", type="primary"):
        if not name: return st.error("Name Req")
        sid = str(uuid.uuid4())[:8] if is_new else tid
        plist = [p for p in edf.to_dict('records') if p['name']]
        sdata = {"name": name, "desc": desc, "tags": sel_tags, "template": code, "params": plist}
        cfg_mgr.save_template(sid, sdata, source)
        st.rerun()


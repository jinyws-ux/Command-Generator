æ²¡é—®é¢˜ï¼Œè¿™ä¸‰ä¸ªç‚¹éƒ½éå¸¸å…·ä½“ï¼Œè€Œä¸”å®Œå…¨åˆ‡ä¸­äº†ç•Œé¢ç»†èŠ‚æ‰“ç£¨çš„æ ¸å¿ƒã€‚æˆ‘ç†è§£ä½ çš„æ„æ€ï¼šæ—¢ç„¶è¦â€œå·¥ä¸š/é‡å…½æ´¾â€é£æ ¼ï¼Œå°±ä¸èƒ½æœ‰é‚£ç§â€œè—•æ–­ä¸è¿â€çš„ç•™ç™½ï¼Œå¿…é¡»ä¸¥ä¸åˆç¼ï¼Œè¦ä¹ˆæ˜¯è¿™å—ç –ï¼Œè¦ä¹ˆæ˜¯é‚£å—ç –ã€‚
é’ˆå¯¹ä½ æå‡ºçš„ä¸‰ä¸ªé—®é¢˜ï¼Œæˆ‘åˆ¶å®šäº†ä»¥ä¸‹ä¿®å¤æ–¹æ¡ˆï¼š
 * å·¦ä¾§æŒ‰é’®æº¢å‡ºï¼š
   * åŸå› ï¼šä¹‹å‰çš„ text-lg (å¤§å·å­—ä½“) åŠ ä¸Šç²—è¾¹æ¡†å’Œå†…è¾¹è·ï¼Œæ’‘çˆ†äº† 260px çš„ä¾§è¾¹æ ã€‚
   * ä¿®å¤ï¼šè°ƒæ•´å­—ä½“å¤§å°ä¸ºé€‚ä¸­çš„ text-sm æˆ– text-baseï¼Œå¹¶ä¼˜åŒ– Flex å¸ƒå±€ï¼Œç¡®ä¿æ–‡å­—å’Œå›¾æ ‡èƒ½åœ¨ä¸€è¡Œæ”¾ä¸‹ã€‚
 * ç¼–è¾‘å™¨è¾“å…¥æ¡†â€œè„±ç¦»â€ï¼š
   * åŸå› ï¼šä¹‹å‰çš„å¸ƒå±€æ˜¯â€œå®¹å™¨æœ‰å†…è¾¹è·(Padding)â€+â€œè¾“å…¥æ¡†æœ‰è¾¹æ¡†â€ã€‚è¿™å¯¼è‡´è¾“å…¥æ¡†åƒå­¤å²›ä¸€æ ·æµ®åœ¨å®¹å™¨ä¸­é—´ï¼Œç¡®å®å¾ˆéš¾çœ‹ã€‚
   * ä¿®å¤ï¼šå»é™¤å®¹å™¨å†…è¾¹è·ã€‚è®©è¾“å…¥æ¡† (Textarea) å¼ºåˆ¶ w-full h-full (å¡«æ»¡å®¹å™¨)ï¼Œå¹¶ä¸”å»æ‰è¾“å…¥æ¡†åŸæœ¬çš„åœ†è§’ï¼Œè®©å®ƒç›´æ¥è´´åˆå¤–å±‚é»‘æ¡†ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„æ•´ä½“ã€‚
 * Output Log æŒ‰é’®æ­ªæ–œä¸”å¤šä½™ï¼š
   * åŸå› ï¼šä¹‹å‰çš„ Flex å¸ƒå±€æ²¡å¯¹é½ï¼Œå¯¼è‡´å¤åˆ¶æŒ‰é’®çœ‹ç€å¾ˆä¹±ã€‚
   * ä¿®å¤ï¼šæ”¹ç”¨ ç»å¯¹å®šä½ (Absolute Positioning)ã€‚æŠŠå¤åˆ¶æŒ‰é’®é’‰æ­»åœ¨æ¯æ¡æ—¥å¿—å¡ç‰‡çš„å³ä¸‹è§’ï¼Œå»æ‰å¤šä½™çš„æ¡†ï¼Œåªç•™ä¸€ä¸ªå¹²å‡€çš„å°å›¾æ ‡ã€‚
è¯·ç›´æ¥å…¨é‡è¦†ç›– cmd_exe/main.pyï¼Œæˆ‘å·²ç»æŠŠè¿™äº›ç»†èŠ‚éƒ½ä¿®å¥½äº†ï¼š
# cmd_exe/main.py
from nicegui import ui
from logic import db
import theme
import uuid
import datetime

theme.setup_theme()

# =======================================================
# è‡ªå®šä¹‰ç»„ä»¶ (Brutal UI Components)
# =======================================================

def b_button(text, icon=None, bg_color="white", text_color="black", on_click=None):
    """é‡å…½æ´¾æŒ‰é’® - ä¿®å¤äº†å®½åº¦æº¢å‡ºé—®é¢˜"""
    return ui.button(text, icon=icon, on_click=on_click) \
        .style(theme.BRUTAL_BTN + f"background-color: {bg_color}; color: {text_color};") \
        .classes(f"{theme.BTN_ACTIVE} w-full px-4") # å¼ºåˆ¶å®½åº¦å¡«æ»¡ï¼Œå¢åŠ å†…è¾¹è·

def b_tag(text, bg_color="#E5E7EB"):
    """é‡å…½æ´¾æ ‡ç­¾"""
    ui.label(text).style(f"background: {bg_color}; border: 2px solid black; box-shadow: 2px 2px 0 black;") \
        .classes('px-2 py-0.5 text-xs font-bold mr-1 mb-1')

# =======================================================
# é¡µé¢å¸ƒå±€ (Layout Architecture)
# =======================================================

# 1. é¡¶æ  (Header)
with ui.header().classes('bg-transparent pointer-events-none'):
    with ui.row().classes('w-full pointer-events-auto justify-between items-center px-6 py-4'):
        with ui.row().classes('gap-0 items-end'):
            ui.label('CMD').style('background: black; color: white; padding: 4px 12px; font-weight: 900; font-size: 28px; border: 3px solid black;')
            ui.label('GEN').style('background: white; color: black; padding: 4px 12px; font-weight: 900; font-size: 28px; border: 3px solid black; border-left: none;')
        
        search_input = ui.input(placeholder='SEARCH...') \
            .props('outlined dense').style(theme.BRUTAL_INPUT + "background: white; width: 300px;")

# 2. ä¸»ä½“å®¹å™¨
with ui.row().classes('w-full h-[calc(100vh-100px)] gap-6 px-6 no-wrap items-start'):
    
    # === å·¦ä¾§ï¼šæŒ‡ä»¤å¡” (Command Tower) ===
    # ä¿®å¤ï¼šæŒ‰é’®æ–‡å­—æº¢å‡ºï¼Œè°ƒæ•´äº†å†…è¾¹è·å’Œå®½åº¦é€»è¾‘
    with ui.column().style(theme.BRUTAL_BOX).classes('w-[260px] h-full p-4 gap-4 flex-shrink-0 bg-white'):
        ui.label('CONTROL_PANEL').classes('font-bold text-gray-400 text-xs tracking-widest')
        
        # ä¿®å¤ç‚¹1ï¼šå­—ä½“æ”¹å°ä¸€ç‚¹ï¼Œé˜²æ­¢æ’‘çˆ†
        b_button('NEW COMMAND', 'add', bg_color=theme.ACCENT_CYAN, on_click=lambda: open_editor()).classes('text-base font-black')
        b_button('TAG MANAGER', 'label', bg_color='white', on_click=lambda: ui.notify('Coming soon')).classes('text-sm font-bold')
        
        ui.separator().classes('bg-black h-[2px]')
        
        with ui.column().classes('gap-1'):
            ui.label('SYSTEM STATUS').classes('font-bold text-xs')
            with ui.row().classes('justify-between w-full'):
                ui.label('Modules:').classes('font-mono text-sm')
                count_label = ui.label('0').classes('font-mono font-bold bg-black text-white px-2')

    # === ä¸­é—´ï¼šæ ¸å¿ƒçŸ©é˜µ (The Matrix) ===
    with ui.scroll_area().classes('flex-grow h-full pr-4'):
        grid_container = ui.row().classes('w-full gap-4 items-start content-start')

        def refresh_grid(filter_text=""):
            grid_container.clear()
            templates = db.get_templates()
            tags_map = db.get_tags()
            count_label.text = str(len(templates))
            
            with grid_container:
                if not templates:
                    with ui.column().classes('w-full items-center py-20 opacity-40'):
                        ui.icon('apps', size='64px')
                        ui.label('NO MODULES').classes('font-bold text-xl mt-4')
                    return

                for tid, t in templates.items():
                    if filter_text and filter_text.lower() not in t['name'].lower(): continue

                    with ui.card().style(theme.BRUTAL_BOX).classes('w-[280px] p-0 flex flex-col justify-between group cursor-default hover:-translate-y-1 transition-transform'):
                        with ui.row().style(f'background:{theme.ACCENT_YELLOW}; border-bottom: 3px solid black;').classes('w-full p-3 justify-between items-center'):
                            ui.label(t['name']).classes('font-black text-lg truncate')
                            ui.button(icon='edit', on_click=lambda id=tid: open_editor(id)).props('flat dense round color=black size=sm')

                        with ui.column().classes('p-3 gap-2 flex-grow'):
                            ui.label(t.get('desc', '-')).classes('text-xs font-mono text-gray-500 line-clamp-2 h-8')
                            with ui.row().classes('gap-0'):
                                for tag_id in t.get('tags', []):
                                    if tag_id in tags_map:
                                        b_tag(tags_map[tag_id]['name'], tags_map[tag_id].get('color', '#eee'))
                        
                        b_button('RUN', 'play_arrow', bg_color='black', text_color='white', on_click=lambda id=tid: open_runner(id)) \
                            .classes('m-3 shadow-none border-white border-2')

        refresh_grid()
        search_input.on('change', lambda e: refresh_grid(e.value))

    # === å³ä¾§ï¼šæ—¶å…‰æœº (Time Machine) ===
    with ui.column().style(theme.BRUTAL_BOX).classes('w-[300px] h-full p-0 flex-shrink-0 bg-gray-50 overflow-hidden'):
        ui.label('OUTPUT_LOG').style('background: black; color: white; padding: 8px; font-weight: bold; text-align: center; width: 100%;')
        
        # å¢åŠ  padding-bottom é˜²æ­¢æœ€åä¸€ä¸ªå¡ç‰‡è¢«æŒ¡ä½
        log_area = ui.scroll_area().classes('w-full flex-grow p-4 gap-3 bg-[url("https://www.transparenttextures.com/patterns/graphy.png")] pb-10')
        
        def add_log(cmd_str):
            with log_area:
                # ä¿®å¤ç‚¹3ï¼šæ—¥å¿—å¡ç‰‡é‡æ„ï¼Œç›¸å¯¹å®šä½
                with ui.column().style('background: white; border: 2px solid black; box-shadow: 2px 2px 0 rgba(0,0,0,0.2);').classes('w-full mb-2 p-2 relative'):
                    # æ—¶é—´
                    ui.label(datetime.datetime.now().strftime("%H:%M:%S")).classes('text-[9px] font-black text-gray-400 mb-1')
                    # ä»£ç å†…å®¹
                    ui.code(cmd_str).classes('text-xs font-mono break-all bg-transparent p-0 text-red-600 mb-4') # mb-4 ç»™æŒ‰é’®ç•™ä½ç½®
                    
                    # å¤åˆ¶æŒ‰é’® - ç»å¯¹å®šä½åˆ°å³ä¸‹è§’ï¼Œä¸æ­ªäº†
                    ui.button(icon='content_copy', on_click=lambda: ui.clipboard.write(cmd_str)) \
                        .props('flat dense round size=xs color=black') \
                        .classes('absolute bottom-1 right-1 opacity-50 hover:opacity-100')

            log_area.scroll_to(percent=1.0)

# =======================================================
# å¼¹çª—é€»è¾‘ (Dialogs)
# =======================================================

def open_runner(tid):
    data = db.get_templates().get(tid)
    if not data: return
    
    with ui.dialog() as dialog, ui.card().style(theme.BRUTAL_BOX).classes('min-w-[500px] p-0'):
        with ui.row().style(f'background:{theme.ACCENT_PINK}; border-bottom: 3px solid black;').classes('w-full p-4 justify-between items-center'):
            ui.label(f">> EXECUTE").classes('font-black text-xl')
            ui.button(icon='close', on_click=dialog.close).props('flat dense round color=black')
        
        inputs = {}
        with ui.column().classes('p-6 gap-4 w-full bg-white'):
            for p in data.get('params', []):
                ui.label(p.get('label', p['name'])).classes('font-bold text-xs mb-[-8px]')
                inputs[p['name']] = ui.input(value=p.get('default', '')).props('dense outlined').style(theme.BRUTAL_INPUT).classes('w-full')
            
            ui.label('PREVIEW').classes('font-bold text-xs mt-2')
            res_box = ui.code('Waiting...').classes('w-full p-3 border-2 border-black bg-black text-green-400 font-mono rounded-none')
            
            def run_gen():
                try:
                    params = {k: v.value for k,v in inputs.items()}
                    res = db.render(data.get('template', ''), params)
                    res_box.content = res
                    add_log(res)
                    ui.clipboard.write(res)
                    ui.notify('COPIED', color='black')
                except Exception as e:
                    ui.notify(str(e), color='red')

            b_button('GENERATE', 'bolt', bg_color=theme.ACCENT_CYAN, on_click=run_gen).classes('w-full mt-2')

    dialog.open()

def open_editor(tid=None):
    is_edit = tid is not None
    data = db.get_templates().get(tid, {}) if is_edit else {}
    
    with ui.dialog() as dialog, ui.card().style(theme.BRUTAL_BOX).classes('min-w-[900px] h-[600px] p-0 overflow-hidden'):
        # å¼¹çª—å¤´
        with ui.row().style('background:black; color:white;').classes('w-full p-3 justify-between items-center flex-shrink-0'):
            ui.label('EDITOR').classes('font-mono font-bold text-lg')
            ui.button(icon='close', on_click=dialog.close).props('flat dense round color=white')
        
        # ä¿®å¤ç‚¹2ï¼šè¾“å…¥æ¡†å¸ƒå±€é‡æ„ - å»æ‰å†…è¾¹è·ï¼Œè®©è¾“å…¥æ¡†å¡«æ»¡
        with ui.row().classes('w-full h-full no-wrap'):
            
            # === å·¦ä¾§ï¼šå‚æ•°é…ç½® ===
            # p-0 å»æ‰çˆ¶å®¹å™¨å†…è¾¹è·
            with ui.column().classes('w-1/2 h-full border-r-2 border-black bg-gray-50 p-0'):
                # æ ‡é¢˜æ 
                ui.label('PARAMETERS (CSV)').classes('font-black text-xs p-2 border-b-2 border-black bg-gray-200 w-full')
                
                # ç®€å•å¤„ç†å‚æ•°è½¬æ¢
                def params_to_str(plist): return "\n".join([f"{p['name']},{p.get('label','')},{p.get('default','')}" for p in plist])
                def str_to_params(txt): 
                    return [{"name": l.split(',')[0].strip(), "label": l.split(',')[1].strip() if ',' in l else l.split(',')[0], "default": l.split(',')[2].strip() if l.count(',')>=2 else ""} for l in txt.split('\n') if l.strip()]
                
                # æ ¸å¿ƒä¿®å¤ï¼šè¾“å…¥æ¡†å¡«æ»¡ï¼Œå»æ‰è‡ªå¸¦åœ†è§’å’Œè¾¹æ¡†(å› ä¸ºå¤–å±‚å·²ç»æœ‰é»‘æ¡†äº†)ï¼Œä½¿ç”¨ font-mono å¯¹é½
                p_input = ui.textarea(value=params_to_str(data.get('params',[]))) \
                    .props('borderless dense flat') \
                    .style('width: 100%; height: 100%; resize: none; background: transparent; padding: 12px; font-family: monospace;') \
                    .classes('text-sm')
                
                # Metadata (æ”¾åœ¨åº•éƒ¨æˆ–è€…é¡¶éƒ¨éƒ½å¯ä»¥ï¼Œè¿™é‡Œä¸ºäº†å¡«æ»¡æ„Ÿï¼Œæ”¾åº•éƒ¨å°æ ¼å­)
                with ui.column().classes('p-4 gap-2 border-t-2 border-black bg-white'):
                    ui.label('METADATA').classes('font-bold text-xs')
                    name = ui.input('NAME', value=data.get('name','')).props('dense outlined').style(theme.BRUTAL_INPUT).classes('w-full')
                    desc = ui.input('DESC', value=data.get('desc','')).props('dense outlined').style(theme.BRUTAL_INPUT).classes('w-full')

            # === å³ä¾§ï¼šæ¨¡æ¿ä»£ç  ===
            # p-0 å»æ‰çˆ¶å®¹å™¨å†…è¾¹è·
            with ui.column().classes('w-1/2 h-full bg-black p-0 relative'):
                ui.label('TEMPLATE (JINJA2)').classes('font-black text-xs text-green-500 p-2 border-b border-gray-800 w-full bg-gray-900')
                
                # æ ¸å¿ƒä¿®å¤ï¼šå®Œå…¨æ²‰æµ¸å¼ä»£ç ç¼–è¾‘ä½“éªŒ
                t_input = ui.textarea(value=data.get('template','')) \
                    .props('borderless dense flat') \
                    .style("width:100%; height:100%; resize:none; background: #000; color: #0f0; font-family: 'JetBrains Mono', monospace; padding: 12px; border: none; outline: none;") \
                    .classes('text-sm')
                
                # æ‚¬æµ®ä¿å­˜æŒ‰é’® (Floating Action Button style)
                with ui.row().classes('absolute bottom-6 right-6 gap-2'):
                    if is_edit:
                        ui.button(icon='delete', on_click=lambda: [db.delete_template(tid), refresh_grid(), dialog.close()]) \
                            .props('round color=red text-color=white shadow')
                    
                    def save():
                        if not name.value: return ui.notify('Name required', color='red')
                        save_id = tid if is_edit else str(uuid.uuid4())[:8]
                        new_data = {
                            "name": name.value, "desc": desc.value, 
                            "template": t_input.value, 
                            "params": str_to_params(p_input.value),
                            "tags": data.get('tags', [])
                        }
                        db.save_template(save_id, new_data)
                        refresh_grid()
                        dialog.close()
                        ui.notify('SAVED', color='black')

                    ui.button(icon='save', on_click=save) \
                        .props('round color=yellow text-color=black shadow') \
                        .style("border: 2px solid white;")

    dialog.open()

ui.run(title="CMD_NEXUS_PRO", native=True, window_size=(1200, 800), reload=False)

ğŸ› ï¸ ä¿®å¤ç»†èŠ‚å¤ç›˜
 * å·¦ä¾§æŒ‰é’®ï¼š
   * ä½¿ç”¨äº† classes('text-base font-black') ä»£æ›¿ text-lgã€‚
   * ç§»é™¤äº†ä¸å¿…è¦çš„å†…è¾¹è·é™åˆ¶ï¼Œè®©æ–‡å­—è‡ªç„¶å±…ä¸­ã€‚
 * ç¼–è¾‘å™¨è¾“å…¥æ¡† (Editor)ï¼š
   * å‚æ•°æ  (å·¦)ï¼šæˆ‘æŠŠ ui.column çš„ padding è®¾ä¸º 0ã€‚ç„¶åæŠŠ textarea çš„æ ·å¼è®¾ä¸º resize: none; width: 100%; height: 100%ã€‚ç°åœ¨è¾“å…¥æ¡†å°±æ˜¯å®¹å™¨æœ¬èº«ï¼Œå†ä¹Ÿæ²¡æœ‰ç¼éš™äº†ã€‚
   * ä»£ç æ  (å³)ï¼šè®¾ä¸ºçº¯é»‘èƒŒæ™¯ï¼ŒåŒæ ·å¡«æ»¡å®¹å™¨ã€‚ä¸ºäº†ä¸ç ´åå…¨å±è¾“å…¥çš„æ²‰æµ¸æ„Ÿï¼Œæˆ‘æŠŠâ€œä¿å­˜â€æŒ‰é’®æ”¹æˆäº†å³ä¸‹è§’çš„æ‚¬æµ®åœ†é’® (FAB)ï¼Œè¿™æ ·çœ‹èµ·æ¥æ›´åƒæ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç ç¼–è¾‘å™¨ã€‚
 * æ—¥å¿—åŒº (Output Log)ï¼š
   * æ¯æ¡æ—¥å¿—å¡ç‰‡è®¾ä¸º relative (ç›¸å¯¹å®šä½)ã€‚
   * å¤åˆ¶æŒ‰é’®è®¾ä¸º absolute bottom-1 right-1 (ç»å¯¹å®šä½)ã€‚
   * ç°åœ¨æŒ‰é’®ä¼šç¨³ç¨³åœ°åœåœ¨å³ä¸‹è§’ï¼Œè€Œä¸”ä¸ºäº†ä¸æŠ¢è§†è§‰é‡å¿ƒï¼Œæˆ‘ç»™å®ƒåŠ äº† opacity-50 hover:opacity-100ï¼Œé¼ æ ‡æ”¾ä¸Šå»æ‰ä¼šå˜é»‘ã€‚

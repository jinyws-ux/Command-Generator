å®Œå…¨æ˜ç™½ã€‚ä½ çš„æ„æ€æ˜¯ï¼šå·¦ä¾§ä¾§è¾¹æ ï¼ˆSidebarï¼‰åªä½œä¸ºâ€œä¸€çº§å¯¼èˆªâ€ï¼ˆç”¨æ¥åˆ‡æ¢â€œå‘½ä»¤ç”Ÿæˆå™¨â€ã€â€œç›‘æ§â€ã€â€œè®¾ç½®â€ç­‰å¤§æ¨¡å—ï¼‰ï¼Œä¿æŒæç®€å’Œå¹²å‡€ã€‚
è€Œå…·ä½“åˆ°â€œå‘½ä»¤ç”Ÿæˆå™¨â€å†…éƒ¨çš„æœç´¢ã€ç­›é€‰ã€æ–°å»ºã€è§†å›¾åˆ‡æ¢ç­‰åŠŸèƒ½ï¼Œåº”è¯¥å…¨éƒ¨æŒªåˆ°å³ä¾§ä¸»ç•Œé¢çš„é¡¶éƒ¨ï¼Œä½œä¸ºè¯¥æ¨¡å—çš„â€œé¡¶æ /æ§åˆ¶é¢æ¿â€ã€‚
è¿™éå¸¸ç¬¦åˆå¾ˆå¤šåå°ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚é˜¿é‡Œäº‘æ§åˆ¶å°ã€AWSæ§åˆ¶å°ï¼‰çš„è®¾è®¡è§„èŒƒï¼šå·¦ä¾§å®šå¤§æ–¹å‘ï¼Œå³ä¾§åšå…·ä½“äº‹ã€‚
ä¸‹é¢æ˜¯v3.0 æœ€ç»ˆå¸ƒå±€ç‰ˆçš„ modules/cmd_generator/app.pyã€‚æˆ‘æŠŠæ‰€æœ‰æ§åˆ¶æ§ä»¶éƒ½ç§»åˆ°äº†å³ä¾§é¡¶éƒ¨ï¼Œå¹¶æ’ç‰ˆæˆäº†ä¸¤è¡Œæ•´é½çš„å·¥å…·æ ã€‚
ğŸ“‚ æ›´æ–° modules/cmd_generator/app.py
è¯·ç›´æ¥è¦†ç›–åŸæ–‡ä»¶ï¼š
import streamlit as st
import pandas as pd
from jinja2 import Template
import shlex
import uuid
import time

# ==========================================
# ğŸ¨ 0. è§†è§‰å¢å¼º
# ==========================================
def inject_custom_css():
    st.markdown("""
        <style>
        .stApp { font-family: 'Inter', sans-serif; }
        
        /* é¡¶éƒ¨å·¥å…·æ å®¹å™¨æ ·å¼ */
        .toolbar-container {
            background-color: #262730;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #464b5c;
        }
        
        /* ç»ˆç«¯çª—å£æ ·å¼ */
        .terminal-window {
            background-color: #1e1e1e;
            border-radius: 6px;
            border: 1px solid #333;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            color: #d4d4d4;
            margin-top: 10px;
        }
        </style>
    """, unsafe_allow_html=True)

# ==========================================
# ğŸ§  1. æ ¸å¿ƒæ¸²æŸ“å…¥å£
# ==========================================
def render(cfg_mgr):
    inject_custom_css()
    
    # è·å–æ•°æ®
    templates = cfg_mgr.get_all_templates()
    
    # çŠ¶æ€åˆå§‹åŒ–
    if 'view_state' not in st.session_state: st.session_state['view_state'] = 'DASHBOARD' 
    if 'active_tid' not in st.session_state: st.session_state['active_tid'] = None
    
    # è·¯ç”±åˆ†å‘
    if st.session_state['view_state'] == 'DASHBOARD':
        render_dashboard(cfg_mgr, templates)
    elif st.session_state['view_state'] == 'WORKBENCH':
        render_workbench(cfg_mgr, templates)
    elif st.session_state['view_state'] == 'EDITOR':
        render_editor(cfg_mgr, templates)

# ==========================================
# ğŸ  2. å¤§å… (Dashboard) - é¡¶éƒ¨æ§åˆ¶æ å¸ƒå±€
# ==========================================
def render_dashboard(cfg_mgr, templates):
    st.title("ğŸš€ Ops Command Center")

    # --- A. é¡¶éƒ¨æ§åˆ¶é¢æ¿ (åŸæœ¬åœ¨ä¾§è¾¹æ çš„ä¸œè¥¿å…¨æ¬åˆ°è¿™é‡Œ) ---
    # ä½¿ç”¨ Container åŒ…è£¹ï¼Œå¢åŠ ä¸€ç‚¹èƒŒæ™¯è‰²æˆ–è¾¹è·æ„Ÿ
    with st.container():
        # ç¬¬ä¸€è¡Œï¼šæ ¸å¿ƒæ“ä½œ (æœç´¢ + æ–°å»º)
        c_search, c_new = st.columns([5, 1])
        with c_search:
            filter_search = st.text_input("æœç´¢", placeholder="ğŸ” è¾“å…¥å…³é”®å­—æœç´¢æ¨¡æ¿...", label_visibility="collapsed")
        with c_new:
            if st.button("â• æ–°å»ºæ¨¡æ¿", type="primary", use_container_width=True):
                st.session_state['active_tid'] = "NEW"
                st.session_state['view_state'] = 'EDITOR'
                st.rerun()
        
        st.caption("") # ç¨å¾®ç•™ä¸€ç‚¹ç©ºéš™

        # ç¬¬äºŒè¡Œï¼šç­›é€‰å™¨ (Expander æ”¶çº³ï¼Œæˆ–è€…ç›´æ¥æ¨ªæ’)
        # è¿™é‡Œç›´æ¥æ¨ªæ’å±•ç¤ºï¼Œç›´è§‚é«˜æ•ˆ
        c_type, c_cat, c_view = st.columns([2, 2, 2])
        
        # å‡†å¤‡ç­›é€‰æ•°æ®
        all_types = sorted(list(set(t.get('type', 'Other') for t in templates.values())))
        all_cats = sorted(list(set(t.get('category', 'æœªåˆ†ç±»') for t in templates.values())))

        with c_type:
            filter_type = st.multiselect("æŠ€æœ¯ç±»å‹ (Type)", options=all_types, default=all_types, placeholder="ç­›é€‰ç±»å‹...")
        with c_cat:
            filter_cat = st.multiselect("ä¸šåŠ¡åœºæ™¯ (Category)", options=all_cats, placeholder="ç­›é€‰åˆ†ç±»...")
        with c_view:
            # è§†å›¾åˆ‡æ¢æ”¹ä¸º Segment Control é£æ ¼ (Radio æ¨ªæ’)
            view_mode = st.radio("è§†å›¾æ¨¡å¼", ["ğŸªŸ ç½‘æ ¼è§†å›¾", "ğŸ“‹ åˆ—è¡¨è§†å›¾"], horizontal=True, label_visibility="collapsed")

    st.divider() # ä¸€æ¡åˆ†å‰²çº¿ï¼ŒåŒºåˆ†é¡¶éƒ¨å’Œä¸‹æ–¹å†…å®¹

    # --- B. æ•°æ®è¿‡æ»¤é€»è¾‘ ---
    filtered_list = []
    for tid, t in templates.items():
        # æœç´¢è¿‡æ»¤
        term = filter_search.lower()
        if term and (term not in t['name'].lower() and term not in t.get('desc','').lower()):
            continue
        # ç±»å‹è¿‡æ»¤
        if t.get('type', 'Other') not in filter_type:
            continue
        # åˆ†ç±»è¿‡æ»¤ (æœªé€‰åˆ™æ˜¾ç¤ºæ‰€æœ‰)
        if filter_cat and t.get('category', 'æœªåˆ†ç±»') not in filter_cat:
            continue
            
        t['_id'] = tid
        filtered_list.append(t)
        
    if not filtered_list:
        st.info("ğŸ‘‹ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¨¡æ¿ã€‚")
        return

    # --- C. æ¸²æŸ“è§†å›¾ ---
    if "ç½‘æ ¼" in view_mode:
        render_grid_view(filtered_list)
    else:
        render_list_view(filtered_list)

def render_grid_view(items):
    """ç½‘æ ¼è§†å›¾"""
    # æŒ‰ Type åˆ†ç»„
    grouped_types = sorted(list(set(i.get('type', 'Other') for i in items)))
    
    for g_type in grouped_types:
        st.subheader(f"{get_type_icon(g_type)} {g_type}")
        type_items = [i for i in items if i.get('type', 'Other') == g_type]
        
        cols = st.columns(3)
        for idx, item in enumerate(type_items):
            with cols[idx % 3]:
                with st.container(border=True):
                    # å¤´éƒ¨
                    c1, c2 = st.columns([5, 1])
                    c1.markdown(f"**{item['name']}**")
                    if item.get('source') == 'team':
                        c2.caption("ğŸ¢")
                    else:
                        c2.caption("ğŸ‘¤")
                    
                    st.caption(f"ğŸ“‚ {item.get('category', 'æœªåˆ†ç±»')}")
                    # æˆªæ–­æè¿°
                    desc = item.get('desc', 'æ— æè¿°')
                    if len(desc) > 20: desc = desc[:20] + "..."
                    st.text(desc)
                    
                    # æŒ‰é’®ç»„
                    b1, b2 = st.columns([3, 1])
                    if b1.button("è¿è¡Œ", key=f"run_{item['_id']}", use_container_width=True):
                        st.session_state['active_tid'] = item['_id']
                        st.session_state['view_state'] = 'WORKBENCH'
                        st.rerun()
                    if b2.button("âš™ï¸", key=f"edit_{item['_id']}", help="ç¼–è¾‘"):
                        st.session_state['active_tid'] = item['_id']
                        st.session_state['view_state'] = 'EDITOR'
                        st.rerun()

def render_list_view(items):
    """åˆ—è¡¨è§†å›¾"""
    table_data = []
    for item in items:
        table_data.append({
            "ID": item['_id'],
            "åç§°": item['name'],
            "ç±»å‹": item.get('type', 'Other'),
            "åˆ†ç±»": item.get('category', 'æœªåˆ†ç±»'),
            "æ¥æº": "ğŸ¢ Team" if item.get('source') == 'team' else "ğŸ‘¤ User",
            "æè¿°": item.get('desc', '')
        })
    
    df = pd.DataFrame(table_data)
    
    st.markdown("##### ğŸ’¡ å‹¾é€‰å·¦ä¾§ä»¥æ“ä½œ")
    event = st.dataframe(
        df,
        column_config={
            "ID": None,
            "åç§°": st.column_config.TextColumn("æ¨¡æ¿åç§°", width="medium"),
            "ç±»å‹": st.column_config.TextColumn("ç±»å‹", width="small"),
        },
        on_select="rerun",
        selection_mode="single-row",
        use_container_width=True,
        hide_index=True
    )
    
    if len(event.selection.rows) > 0:
        selected_idx = event.selection.rows[0]
        selected_id = df.iloc[selected_idx]['ID']
        
        # åº•éƒ¨æµ®åŠ¨æ“ä½œæ 
        st.info(f"å·²é€‰ä¸­: **{df.iloc[selected_idx]['åç§°']}**")
        c1, c2, c3 = st.columns([1, 1, 4])
        if c1.button("â–¶ è¿è¡Œ", type="primary", use_container_width=True):
            st.session_state['active_tid'] = selected_id
            st.session_state['view_state'] = 'WORKBENCH'
            st.rerun()
        if c2.button("âœï¸ ç¼–è¾‘", use_container_width=True):
            st.session_state['active_tid'] = selected_id
            st.session_state['view_state'] = 'EDITOR'
            st.rerun()

# ==========================================
# ğŸ› ï¸ 3. å·¥ä½œå° & 4. ç¼–è¾‘å™¨ (ä¿æŒä¸å˜)
# ==========================================
# ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¹‹å‰é€»è¾‘ï¼Œæˆ–è€…éœ€è¦æˆ‘å†æ¬¡è´´å‡ºå®Œæ•´ä»£ç ï¼Ÿ
# å¦‚æœä½ å·²ç»æœ‰ä¹‹å‰çš„ Workbench å’Œ Editor ä»£ç ï¼Œå®ƒä»¬ä¸éœ€è¦æ”¹åŠ¨ã€‚
# ä¸‹é¢åªè¡¥å…… Workbench å’Œ Editor çš„å‡½æ•°å¤´ï¼Œé€»è¾‘ä¸å˜ã€‚

def render_workbench(cfg_mgr, templates, tid=None):
    if not tid: tid = st.session_state.get('active_tid')
    if not tid or tid not in templates:
        st.error("æ¨¡æ¿æœªæ‰¾åˆ°")
        time.sleep(1)
        st.session_state['view_state'] = 'DASHBOARD'
        st.rerun()
        return

    data = templates[tid]
    
    # é¡¶éƒ¨å¯¼èˆªï¼šä½¿ç”¨ cols å¸ƒå±€ï¼Œå·¦è¾¹è¿”å›ï¼Œå³è¾¹æ ‡é¢˜
    c_nav, c_content = st.columns([1, 10])
    if c_nav.button("â¬…ï¸", help="è¿”å›å¤§å…"):
        st.session_state['view_state'] = 'DASHBOARD'
        st.rerun()
    
    with c_content:
         st.subheader(f"{get_type_icon(data.get('type'))} {data['name']}")

    st.markdown("---")

    col_input, col_output = st.columns([1, 1.2], gap="large")
    
    with col_input:
        st.caption("Step 1: å‚æ•°é…ç½®")
        with st.form("run_form"):
            user_inputs = {}
            params = data.get('params', [])
            
            for p in params:
                label = p.get('label', p['name'])
                if p['type'] == 'select':
                    opts = [x.strip() for x in p.get("options", "").split(",") if x.strip()]
                    user_inputs[p['name']] = st.selectbox(label, options=opts)
                elif p['type'] == 'number':
                    user_inputs[p['name']] = st.number_input(label, value=float(p.get('default', 0)))
                else:
                    user_inputs[p['name']] = st.text_input(label, value=str(p.get('default', '')))
            
            st.markdown("<br>", unsafe_allow_html=True)
            submitted = st.form_submit_button("âš¡ ç”Ÿæˆå‘½ä»¤", type="primary", use_container_width=True)

    with col_output:
        st.caption("Step 2: ç»“æœé¢„è§ˆ")
        result_text = "# ç­‰å¾…ç”Ÿæˆ..."
        if submitted:
            try:
                safe_inputs = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in user_inputs.items()}
                t = Template(data.get("template", ""))
                result_text = t.render(**safe_inputs)
            except Exception as e:
                result_text = f"# Error: {e}"
        
        st.markdown(f"""
        <div class="terminal-window">
            <div style="color:#2ecc71; margin-bottom:5px;">user@ops-console:~$ generate</div>
            <div style="white-space: pre-wrap; word-break: break-all;">{result_text}</div>
        </div>
        """, unsafe_allow_html=True)
        
        if submitted:
            st.markdown("<br>", unsafe_allow_html=True)
            st.code(result_text)

def render_editor(cfg_mgr, templates):
    tid = st.session_state.get('active_tid')
    is_new = (tid == "NEW")
    data = {} if is_new else templates.get(tid, {})
    
    c_nav, c_content = st.columns([1, 10])
    if c_nav.button("â¬…ï¸"):
        st.session_state['view_state'] = 'DASHBOARD'
        st.rerun()
    with c_content:
        st.subheader("æ–°å»ºæ¨¡æ¿" if is_new else "ç¼–è¾‘æ¨¡æ¿")
    
    st.markdown("---")

    with st.container(border=True):
        c1, c2, c3 = st.columns([2, 1, 1])
        new_name = c1.text_input("åç§°", value=data.get('name', ''))
        
        types_common = ["Linux", "SQL", "PowerShell", "Docker", "K8s"]
        curr_type = data.get('type', 'Linux')
        new_type = c2.selectbox("ç±»å‹", options=types_common + ["è‡ªå®šä¹‰..."], index=0 if curr_type not in types_common else types_common.index(curr_type))
        if new_type == "è‡ªå®šä¹‰...": new_type = c2.text_input("è¾“å…¥æ–°ç±»å‹", value="Other")

        existing_cats = sorted(list(set(t.get('category') for t in templates.values() if t.get('category'))))
        curr_cat = data.get('category', 'Default')
        cat_opts = existing_cats + ["+ æ–°å»º..."]
        cat_idx = 0
        if curr_cat in existing_cats: cat_idx = existing_cats.index(curr_cat)
        new_cat_sel = c3.selectbox("åˆ†ç±»", options=cat_opts, index=cat_idx)
        final_cat = new_cat_sel
        if new_cat_sel == "+ æ–°å»º...": final_cat = c3.text_input("è¾“å…¥åˆ†ç±»å")

        new_desc = st.text_input("æè¿°", value=data.get('desc', ''))

        st.markdown("#### å‚æ•°å®šä¹‰")
        default_params = data.get('params', [{"name": "target", "label": "ç›®æ ‡", "type": "text", "default": "", "options": ""}])
        edited_df = st.data_editor(pd.DataFrame(default_params), num_rows="dynamic", use_container_width=True, column_config={"type": st.column_config.SelectboxColumn("ç±»å‹", options=["text", "number", "select"])})

        st.markdown("#### æ¨¡æ¿ä»£ç ")
        new_code = st.text_area("Jinja2 Code", value=data.get('template', ''), height=200)
        
        st.markdown("---")
        b1, b2, b3 = st.columns([1, 4, 1])
        
        if b1.button("ğŸ’¾ ä¿å­˜", type="primary", use_container_width=True):
            if not new_name: return st.error("è¯·å¡«å†™åç§°")
            save_id = tid
            if is_new or data.get('source') == 'team': save_id = str(uuid.uuid4())[:8]
            
            p_list = [p for p in edited_df.to_dict('records') if p['name']]
            save_data = {"name": new_name, "type": new_type if new_type != "è‡ªå®šä¹‰..." else "Other", "category": final_cat if final_cat else "Default", "desc": new_desc, "template": new_code, "params": p_list}
            
            cfg_mgr.save_template(save_id, save_data)
            st.success("å·²ä¿å­˜")
            st.session_state['view_state'] = 'DASHBOARD'
            st.rerun()
            
        if not is_new and data.get('source') == 'personal':
            if b3.button("ğŸ—‘ï¸ åˆ é™¤", use_container_width=True):
                cfg_mgr.delete_template(tid)
                st.session_state['view_state'] = 'DASHBOARD'
                st.rerun()

def get_type_icon(t):
    if t == 'Linux': return 'ğŸ§'
    if t == 'SQL': return 'ğŸ¬'
    if t == 'PowerShell': return 'ğŸªŸ'
    return 'ğŸ“'

å˜åŒ–å›¾è§£
ç°åœ¨çš„å¸ƒå±€ç»“æ„ï¼š
+-------------------+---------------------------------------------------------+
| [MAIN SIDEBAR]    | [ TOP CONTROL BAR ]                                     |
|                   | [ ğŸ” Search Input                 ] [ â• New Button ]   |
| ğŸš€ Cmd Generator | [ ğŸ”½ Type Filter ] [ ğŸ”½ Cat Filter] [ ğŸ”˜ Grid/List ]   |
| ğŸ“Š Monitor        | ------------------------------------------------------- |
| âš™ï¸ Settings       |                                                         |
|                   | [ CONTENT AREA ]                                        |
|                   |                                                         |
|                   | +------------+  +------------+  +------------+          |
|                   | | Linux Card |  | SQL Card   |  | App Card   |          |
|                   | +------------+  +------------+  +------------+          |
|                   |                                                         |
+-------------------+---------------------------------------------------------+

 * å·¦ä¾§å¹²å¹²å‡€å‡€ï¼šåªå‰©ä¸‹ main.py å®šä¹‰çš„é‚£å‡ ä¸ªå¤§æ¨¡å—å¯¼èˆªã€‚
 * é¡¶éƒ¨èšåˆæ“ä½œï¼š
   * ç¬¬ä¸€è¡Œï¼šæœ€å¸¸ç”¨çš„æœç´¢å’Œæ–°å»ºã€‚
   * ç¬¬äºŒè¡Œï¼šç­›é€‰æ¡ä»¶ï¼ˆæŠ€æœ¯ç±»å‹ã€ä¸šåŠ¡åˆ†ç±»ï¼‰å’Œè§†å›¾åˆ‡æ¢ã€‚
 * è§†è§‰åˆ†å‰²ï¼šåŠ äº†ä¸€æ¡ st.divider() åˆ†å‰²çº¿ï¼Œè®©æ“ä½œåŒºå’Œå†…å®¹åŒºæ³¾æ¸­åˆ†æ˜ã€‚
å¿«è¯•è¯•è¿™ä¸ªç‰ˆæœ¬ï¼Œåº”è¯¥å°±æ˜¯ä½ è„‘æµ·é‡Œâ€œå›ºå®šåœ¨å³ä¾§ä¸Šé¢â€çš„æ•ˆæœï¼

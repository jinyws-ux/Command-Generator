è¿™æ˜¯ä¸€æ¬¡éå¸¸å…³é”®çš„ä¿®å¤ã€‚é—®é¢˜å®šä½å¾ˆæ¸…æ™°ï¼š
 * é…ç½®è¯»å–å¤±è´¥ (Config Load Issue)ï¼šè¿™é€šå¸¸æ˜¯å› ä¸ºä¿å­˜çš„æ•°æ®é‡Œç¼ºå°‘äº†å…³é”®å­—æ®µï¼ˆæ¯”å¦‚ sourceï¼‰ï¼Œæˆ–è€…è¯»å–é€»è¾‘è¿‡æ»¤å¤ªä¸¥ã€‚å¦‚æœæ¨¡æ¿åœ¨ JSON é‡Œæœ‰ï¼Œä½†ç•Œé¢åˆ·ä¸å‡ºæ¥ï¼Œé€šå¸¸æ˜¯ Tab è¿‡æ»¤ï¼ˆå…¬å…±/ç§æœ‰ï¼‰ æŠŠæ•°æ®è¿‡æ»¤æ‰äº†ã€‚
 * æ ‡ç­¾ç®¡ç† (Tag Manager)ï¼šä½ éœ€è¦æ›´ç›´è§‚çš„â€œåˆ†ç»„å±•ç¤ºâ€å’Œâ€œå¢åˆ æ”¹æŸ¥â€ã€‚
 * è§†å›¾åˆ‡æ¢æŒ‰é’®æ¶ˆå¤± (Missing Toggle)ï¼šè¿™æ˜¯å› ä¸ºæˆ‘æŠŠæŒ‰é’®æ”¾åˆ°äº†æ•°æ®åŠ è½½åˆ¤æ–­çš„åé¢ã€‚å¦‚æœæ•°æ®åŠ è½½ä¸ºç©ºï¼Œç¨‹åºç›´æ¥ return äº†ï¼Œå¯¼è‡´æŒ‰é’®è¿˜æ²¡ç”»å‡ºæ¥ç¨‹åºå°±ç»“æŸäº†ã€‚
æˆ‘ä»¬åˆ†ä¸‰æ­¥è§£å†³ï¼Œè¿™æ¬¡å°†å½»åº•ä¿®å¤æ•°æ®æµè½¬é—®é¢˜ï¼Œå¹¶é‡å†™æ ‡ç­¾ç®¡ç†ç•Œé¢ã€‚
ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šä¿®å¤åº•å±‚æ•°æ®é€»è¾‘ (core/config_manager.py)
æˆ‘ä»¬éœ€è¦ç¡®ä¿ï¼šæ— è®º JSON æ–‡ä»¶é‡Œæœ‰æ²¡æœ‰å†™ source å­—æ®µï¼Œç¨‹åºåœ¨è¯»å–æ—¶éƒ½èƒ½å¼ºåˆ¶æ ‡è®°å®ƒæ˜¯â€œTeamâ€è¿˜æ˜¯â€œPersonalâ€ã€‚è¿™æ ·å°±ä¸ä¼šå‡ºç°â€œæ˜æ˜æ–‡ä»¶é‡Œæœ‰ï¼Œä½†ç•Œé¢ä¸Šçœ‹ä¸åˆ°â€çš„çµå¼‚ç°è±¡ã€‚
è¯·å®Œå…¨è¦†ç›– core/config_manager.pyï¼š
import json
import os
from typing import Dict, Any

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        self.team_path = team_path
        self.user_path = user_path

    def _load_json(self, path: str) -> Dict:
        if not os.path.exists(path):
            return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception:
            return {}

    def _save_json(self, path: str, data: Dict):
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=4, ensure_ascii=False)

    def get_all_templates(self) -> Dict[str, Any]:
        """
        åˆå¹¶é…ç½®ï¼Œå¹¶ã€å¼ºåˆ¶ã€‘æ³¨å…¥ source å±æ€§ï¼Œé˜²æ­¢é…ç½®ä¸¢å¤±
        """
        merged = {}
        
        # 1. è½½å…¥å›¢é˜Ÿæ¨¡ç‰ˆ (å¼ºåˆ¶ source=team)
        team_data = self._load_json(self.team_path)
        for k, v in team_data.items():
            # å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœæ²¡æœ‰ tags å­—æ®µï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨
            if 'tags' not in v: v['tags'] = []
            v['id'] = k
            v['source'] = 'team' # <--- å¼ºåˆ¶æ ‡è®°
            merged[k] = v
            
        # 2. è½½å…¥ä¸ªäººæ¨¡ç‰ˆ (å¼ºåˆ¶ source=personal)
        user_data = self._load_json(self.user_path)
        for k, v in user_data.items():
            if 'tags' not in v: v['tags'] = []
            v['id'] = k
            v['source'] = 'personal' # <--- å¼ºåˆ¶æ ‡è®°
            merged[k] = v
            
        return merged

    def save_template(self, template_id: str, template_data: Dict, target_source='personal'):
        """
        ä¿å­˜æ¨¡ç‰ˆ
        target_source: 'team' æˆ– 'personal'ï¼Œå†³å®šå­˜åˆ°å“ªä¸ªæ–‡ä»¶
        """
        # ç¡®å®šå†™å…¥è·¯å¾„
        path = self.team_path if target_source == 'team' else self.user_path
        data_map = self._load_json(path)
        
        # æ„é€ å®Œæ•´æ•°æ®å¯¹è±¡
        save_payload = {
            "name": template_data.get("name", "æœªå‘½å"),
            "desc": template_data.get("desc", ""),
            "tags": template_data.get("tags", []), # ä¿å­˜æ ‡ç­¾åˆ—è¡¨
            "template": template_data.get("template", ""),
            "params": template_data.get("params", []),
            "updated_at": "now"
        }
        
        data_map[template_id] = save_payload
        self._save_json(path, data_map)

    def delete_template(self, template_id: str):
        # å°è¯•ä»ä¸ªäººåº“åˆ é™¤
        user_data = self._load_json(self.user_path)
        if template_id in user_data:
            del user_data[template_id]
            self._save_json(self.user_path, user_data)
            return True
            
        # å°è¯•ä»å›¢é˜Ÿåº“åˆ é™¤ (å¦‚æœå…è®¸çš„è¯)
        team_data = self._load_json(self.team_path)
        if template_id in team_data:
            del team_data[template_id]
            self._save_json(self.team_path, team_data)
            return True
            
        return False

ğŸ·ï¸ ç¬¬äºŒæ­¥ï¼šé‡æ„æ ‡ç­¾ç®¡ç† (main.py)
æ‚¨è¦æ±‚ï¼š
 * åˆ†ç±»æ˜¾ç¤ºï¼šä¸è¦åªæ˜¾ç¤ºç±»åˆ«åå­—ï¼Œè¦åˆ†ç»„å±•ç¤ºã€‚
 * ç¼–è¾‘/åˆ é™¤ï¼šéœ€è¦å¢åˆ æ”¹æŸ¥ã€‚
è§£å†³æ–¹æ¡ˆï¼š
 * å·¦ä¾§ï¼šä½¿ç”¨ st.expander æŒ‰ç±»åˆ«åˆ†ç»„å±•ç¤ºæ ‡ç­¾ï¼Œç›´è§‚æ¸…æ™°ã€‚
 * å³ä¾§ï¼šä½¿ç”¨ st.data_editorã€‚è¿™æ˜¯ Streamlit æœ€å¼ºå¤§çš„è¡¨æ ¼ç¼–è¾‘å™¨ï¼Œæ”¯æŒç›´æ¥åœ¨è¡¨æ ¼é‡Œä¿®æ”¹åå­—ã€é¢œè‰²ã€åˆ†ç±»ï¼Œä¹Ÿæ”¯æŒå‹¾é€‰åˆ é™¤è¡Œã€‚è¿™æ˜¯æœ€é«˜æ•ˆçš„ç®¡ç†æ–¹å¼ã€‚
è¯·ä¿®æ”¹ main.py ä¸­çš„ render_tag_manager å‡½æ•°ï¼ˆå…¶ä»–éƒ¨åˆ†ä¸ç”¨åŠ¨ï¼‰ï¼š
# æ”¾åˆ° main.py åº•éƒ¨æ›¿æ¢åŸæ¥çš„ render_tag_manager

def render_tag_manager(tag_mgr):
    st.title("ğŸ·ï¸ æ ‡ç­¾åˆ†ç±»ç®¡ç†")
    
    tags = tag_mgr.get_all_tags()
    
    # å°†å­—å…¸è½¬ä¸ºåˆ—è¡¨ï¼Œæ–¹ä¾¿å¤„ç†
    tag_list = [{"id": k, **v} for k, v in tags.items()]
    
    # --- å¸ƒå±€ï¼šå·¦å³åˆ†æ  ---
    c_view, c_edit = st.columns([1, 1.5], gap="large")
    
    # === å·¦ä¾§ï¼šåˆ†ç»„é¢„è§ˆ (Visual) ===
    with c_view:
        st.subheader("ğŸ‘ï¸ åˆ†ç»„é¢„è§ˆ")
        if not tag_list:
            st.info("æš‚æ— æ ‡ç­¾")
        
        # 1. æå–æ‰€æœ‰ç»„
        all_groups = sorted(list(set(t.get('group', 'æœªåˆ†ç»„') for t in tag_list)))
        
        # 2. å¾ªç¯æ¸²æŸ“ Expander
        for group in all_groups:
            group_tags = [t for t in tag_list if t.get('group', 'æœªåˆ†ç»„') == group]
            with st.expander(f"ğŸ“‚ {group} ({len(group_tags)})", expanded=True):
                # æ¸²æŸ“æ¼‚äº®çš„æ ‡ç­¾ Pill
                html_tags = ""
                for t in group_tags:
                    color = t.get('color', '#888')
                    name = t.get('name', 'Tag')
                    # æ‰‹å†™ CSS èƒ¶å›Šæ ·å¼
                    html_tags += f"""
                    <span style='
                        background-color:{color}20; 
                        color:{color}; 
                        border:1px solid {color}; 
                        padding:2px 8px; 
                        border-radius:12px; 
                        font-size:0.9em; 
                        margin-right:5px; 
                        display:inline-block;
                        margin-bottom:5px;'>
                        {name}
                    </span>
                    """
                st.markdown(html_tags, unsafe_allow_html=True)

    # === å³ä¾§ï¼šè¡¨æ ¼ç¼–è¾‘ (CRUD) ===
    with c_edit:
        st.subheader("ğŸ› ï¸ ç¼–è¾‘/åˆ é™¤")
        st.caption("ğŸ’¡ æç¤ºï¼šç›´æ¥åœ¨è¡¨æ ¼ä¸­ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»è¡Œé¦–çš„ trash å›¾æ ‡åˆ é™¤ï¼Œä¿®æ”¹åè‡ªåŠ¨ä¿å­˜ã€‚")
        
        # ä½¿ç”¨ Dataframe ç¼–è¾‘å™¨
        df_input = pd.DataFrame(tag_list)
        if df_input.empty:
            df_input = pd.DataFrame(columns=["id", "name", "group", "color"])

        # é…ç½®åˆ—
        edited_df = st.data_editor(
            df_input,
            column_config={
                "id": None, # éšè— ID åˆ—
                "name": st.column_config.TextColumn("æ ‡ç­¾åç§°", required=True),
                "group": st.column_config.TextColumn("åˆ†ç»„ (Category)", required=True),
                "color": st.column_config.ColorPickerColumn("é¢œè‰²"),
            },
            num_rows="dynamic", # å…è®¸æ·»åŠ /åˆ é™¤è¡Œ
            use_container_width=True,
            key="tag_editor_table"
        )
        
        # ä¿å­˜é€»è¾‘
        if st.button("ğŸ’¾ ä¿å­˜å˜æ›´", type="primary", use_container_width=True):
            # è½¬æ¢å›å­—å…¸æ ¼å¼ä¿å­˜
            new_tags_map = {}
            for index, row in edited_df.iterrows():
                # å¦‚æœæ˜¯æ–°è¡Œï¼Œå¯èƒ½æ²¡æœ‰ IDï¼Œç”Ÿæˆä¸€ä¸ª
                tid = row.get("id")
                if not tid or pd.isna(tid):
                    tid = str(uuid.uuid4())[:8]
                
                new_tags_map[tid] = {
                    "name": row["name"],
                    "group": row["group"],
                    "color": row["color"]
                }
            
            # å†™å…¥æ–‡ä»¶
            # è¿™é‡Œéœ€è¦ç¨å¾® hack ä¸€ä¸‹ tag_mgrï¼Œæˆ–è€…åœ¨ tag_mgr åŠ ä¸€ä¸ª save_all æ–¹æ³•
            # ç®€å•ç²—æš´å†™æ³•ï¼š
            with open(TAG_CONFIG, 'w', encoding='utf-8') as f:
                json.dump(new_tags_map, f, indent=4, ensure_ascii=False)
                
            st.toast("æ ‡ç­¾å·²æ›´æ–°ï¼", icon="âœ…")
            st.rerun()

ğŸš€ ç¬¬ä¸‰æ­¥ï¼šä¿®å¤è§†å›¾åˆ‡æ¢ä¸é…ç½®è¯»å– (modules/cmd_generator/app.py)
æ‚¨æåˆ°çš„â€œæ²¡çœ‹åˆ°å¡ç‰‡æ¨¡å¼åˆ‡æ¢æŒ‰é’®â€æ˜¯å› ä¸ºæˆ‘æŠŠå®ƒæ”¾åœ¨äº†æ•°æ®åˆ¤ç©ºçš„åé¢ã€‚
ä¿®å¤é€»è¾‘ï¼š
 * å¿…é¡»å…ˆæ¸²æŸ“é¡¶éƒ¨å·¥å…·æ ï¼ˆåŒ…å«æœç´¢ã€æ ‡ç­¾ç­›é€‰ã€è§†å›¾åˆ‡æ¢æŒ‰é’®ï¼‰ã€‚
 * ç„¶åå†å»è·å–æ•°æ®ã€è¿‡æ»¤æ•°æ®ã€‚
 * å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºâ€œç©ºçŠ¶æ€æç¤ºâ€ï¼Œä½†ä¸è¦ returnï¼Œæˆ–è€…è‡³å°‘ä¿è¯å·¥å…·æ å·²ç»ç”»å®Œäº†å† returnã€‚
è¯·å®Œå…¨è¦†ç›– modules/cmd_generator/app.pyï¼š
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid
import time

# ==========================================
# ğŸ¨ CSS ç¾åŒ–
# ==========================================
def inject_css():
    st.markdown("""
        <style>
        .stApp { font-family: 'Inter', sans-serif; }
        /* è°ƒæ•´ DataFrame é€‰ä¸­è¡Œçš„é¢œè‰² */
        [data-testid="stDataFrame"] { border: 1px solid #eee; border-radius: 8px; }
        /* ç»ˆç«¯æ ·å¼ */
        .terminal { background:#1e1e1e; color:#d4d4d4; padding:15px; border-radius:6px; font-family:'Fira Code'; }
        </style>
    """, unsafe_allow_html=True)

# ==========================================
# ğŸ§  ä¸»é€»è¾‘
# ==========================================
def render(cfg_mgr, tag_mgr):
    inject_css()
    
    st.title("ğŸš€ å‘½ä»¤ç”Ÿæˆå·¥ä½œå°")
    
    # --- 1. é¡¶éƒ¨ Tab åˆ‡æ¢ (æ¥æºé€‰æ‹©) ---
    # è¿™é‡Œçš„ value å¯¹åº” ConfigManager é‡Œå¼ºåˆ¶æ³¨å…¥çš„ source å­—æ®µ (team / personal)
    source_tab = sac.segmented(
        items=[
            sac.SegmentedItem(label='å›¢é˜Ÿå…¬å…±åº“', icon='buildings', value='team'),
            sac.SegmentedItem(label='æˆ‘çš„ç§æœ‰åº“', icon='person-lock', value='personal'),
        ], align='center', size='md', color='indigo'
    )
    
    # --- 2. å‡†å¤‡æ•°æ® (åœ¨æ¸²æŸ“å·¥å…·æ ä¹‹å‰å…ˆæ‹¿å…ƒæ•°æ®) ---
    all_templates = cfg_mgr.get_all_templates()
    all_tags = tag_mgr.get_all_tags()
    tag_options = {tid: t['name'] for tid, t in all_tags.items()}

    # --- 3. é¡¶éƒ¨ç­›é€‰å·¥å…·æ  (Always Visible) ---
    # æ”¾åœ¨è¿™é‡Œï¼Œä¿è¯æ— è®ºæœ‰æ²¡æœ‰æ•°æ®ï¼ŒæŒ‰é’®éƒ½åœ¨
    with st.container(border=True):
        c1, c2, c3, c4 = st.columns([3, 3, 2, 2]) # è°ƒæ•´åˆ—å®½
        
        # æœç´¢æ¡†
        search_txt = c1.text_input("æœç´¢", placeholder="åç§°/æè¿°...", label_visibility="collapsed")
        
        # æ ‡ç­¾ç­›é€‰
        selected_tags = c2.multiselect("æ ‡ç­¾", options=tag_options.keys(), format_func=lambda x: tag_options[x], label_visibility="collapsed", placeholder="æŒ‰æ ‡ç­¾ç­›é€‰...")
        
        # è§†å›¾åˆ‡æ¢ (ç»ˆäºæ¥äº†ï¼)
        view_mode = c3.radio("è§†å›¾", ["ğŸ“‹ åˆ—è¡¨", "ğŸªŸ å¡ç‰‡"], horizontal=True, label_visibility="collapsed")

        # æ–°å»ºæŒ‰é’® (æ ¹æ®å½“å‰ Tab å†³å®šæ–°å»ºåˆ°å“ªé‡Œ)
        if c4.button("â• æ–°å»ºè„šæœ¬", type="primary", use_container_width=True):
            open_editor_dialog(cfg_mgr, tag_mgr, "NEW", source_tab)

    # --- 4. æ•°æ®è¿‡æ»¤é€»è¾‘ ---
    # å…³é”®ä¿®æ­£ï¼šç¡®ä¿ source åŒ¹é…æ­£ç¡®
    current_list = {k: v for k, v in all_templates.items() if v.get('source') == source_tab}
    
    display_items = []
    for tid, t in current_list.items():
        # A. æœç´¢åŒ¹é…
        if search_txt and (search_txt.lower() not in t['name'].lower()):
            continue
        # B. æ ‡ç­¾åŒ¹é…
        t_tags = t.get('tags', [])
        if selected_tags:
            # å¦‚æœé€‰äº†æ ‡ç­¾ï¼Œå¿…é¡»åŒ…å«å…¶ä¸­è‡³å°‘ä¸€ä¸ª (ORé€»è¾‘)
            if not set(selected_tags).intersection(set(t_tags)):
                continue
            
        # æ ¼å¼åŒ– Tagsç”¨äºæ˜¾ç¤º
        tag_names = [all_tags[tg]['name'] for tg in t_tags if tg in all_tags]
        
        display_items.append({
            "ID": tid,
            "åç§°": t['name'],
            "æ ‡ç­¾": tag_names, 
            "æè¿°": t.get('desc', ''),
            "raw_tags": t_tags,
            "raw_data": t # æŠŠåŸå§‹æ•°æ®å­˜ç€æ–¹ä¾¿å¡ç‰‡è§†å›¾ç”¨
        })

    # --- 5. æ¸²æŸ“è§†å›¾ (Grid or List) ---
    if not display_items:
        st.info(f"ğŸ‘‹ å½“å‰ã€{source_tab}ã€‘åº“æš‚æ— åŒ¹é…æ•°æ®ã€‚")
        # è°ƒè¯•ç”¨ï¼šå¦‚æœç¡®å®æœ‰æ–‡ä»¶ä½†è¯»ä¸å‡ºæ¥ï¼Œæ‰“å¼€ä¸‹é¢è¿™è¡Œçœ‹çœ‹åˆ°åº•è¯»åˆ°äº†å•¥
        # st.write(f"Debug: All loaded IDs: {list(all_templates.keys())}")
        return

    st.caption(f"å…±åŠ è½½ {len(display_items)} ä¸ªæ¨¡ç‰ˆ")

    if view_mode == "ğŸ“‹ åˆ—è¡¨":
        render_list_view(display_items, cfg_mgr)
    else:
        render_grid_view(display_items, cfg_mgr)


# ==========================================
# ğŸ“‹ åˆ—è¡¨è§†å›¾
# ==========================================
def render_list_view(display_items, cfg_mgr):
    df = pd.DataFrame(display_items)
    
    selection = st.dataframe(
        df,
        column_config={
            "ID": None,
            "raw_tags": None,
            "raw_data": None,
            "åç§°": st.column_config.TextColumn("è„šæœ¬åç§°", width="medium"),
            "æ ‡ç­¾": st.column_config.ListColumn("æ ‡ç­¾", width="medium"),
            "æè¿°": st.column_config.TextColumn("åŠŸèƒ½æè¿°", width="large"),
        },
        use_container_width=True,
        hide_index=True,
        on_select="rerun",
        selection_mode="single-row"
    )

    if len(selection.selection.rows) > 0:
        row_idx = selection.selection.rows[0]
        selected_id = df.iloc[row_idx]['ID']
        open_runner_dialog(cfg_mgr, selected_id)

# ==========================================
# ğŸªŸ å¡ç‰‡è§†å›¾
# ==========================================
def render_grid_view(display_items, cfg_mgr):
    cols = st.columns(3) # 3åˆ—å¸ƒå±€
    for idx, item in enumerate(display_items):
        with cols[idx % 3]:
            with st.container(border=True):
                # æ ‡é¢˜ä¸æè¿°
                st.markdown(f"**{item['åç§°']}**")
                st.caption(item['æè¿°'][:40] + "..." if item['æè¿°'] else "æ— æè¿°")
                
                # æ ‡ç­¾å±•ç¤º
                if item['æ ‡ç­¾']:
                    st.caption(" ".join([f"`{t}`" for t in item['æ ‡ç­¾'][:3]]))
                else:
                    st.caption("No Tags")
                
                # æŒ‰é’®
                if st.button("è¿è¡Œ", key=f"run_card_{item['ID']}", use_container_width=True):
                    open_runner_dialog(cfg_mgr, item['ID'])


# ==========================================
# ğŸƒâ€â™‚ï¸ å¼¹çª—ç»„ä»¶ï¼šè¿è¡Œå™¨
# ==========================================
@st.dialog("âš¡ è¿è¡Œæ§åˆ¶å°", width="large")
def open_runner_dialog(cfg_mgr, tid):
    templates = cfg_mgr.get_all_templates()
    data = templates.get(tid)
    
    if not data:
        st.error("æ¨¡ç‰ˆæ•°æ®ä¸¢å¤±")
        return

    st.caption(f"æ­£åœ¨é…ç½®: {data['name']}")
    
    # å·¦å³å¸ƒå±€
    c1, c2 = st.columns([1, 1.2], gap="medium")
    
    user_inputs = {}
    with c1:
        st.subheader("å‚æ•°é…ç½®")
        with st.form("modal_form"):
            params = data.get('params', [])
            for p in params:
                label = p.get('label', p['name'])
                if p['type'] == 'select':
                    opts = [x.strip() for x in p.get("options", "").split(",") if x.strip()]
                    user_inputs[p['name']] = st.selectbox(label, opts)
                elif p['type'] == 'number':
                    user_inputs[p['name']] = st.number_input(label, value=float(p.get('default', 0)))
                else:
                    user_inputs[p['name']] = st.text_input(label, value=str(p.get('default', '')))
            
            submitted = st.form_submit_button("ç”Ÿæˆé¢„è§ˆ", type="primary", use_container_width=True)

    with c2:
        st.subheader("Terminal Preview")
        res_text = "# ç­‰å¾…è¾“å…¥..."
        if submitted:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in user_inputs.items()}
                t = Template(data.get('template', ''))
                res_text = t.render(**safe)
            except Exception as e:
                res_text = f"Error: {e}"
        
        st.markdown(f'<div class="terminal">{res_text}</div>', unsafe_allow_html=True)
        if submitted:
            st.code(res_text)

    st.markdown("---")
    c_edit, c_close = st.columns([1, 5])
    if c_edit.button("âœï¸ ç¼–è¾‘æ­¤æ¨¡ç‰ˆ"):
        # åˆ‡æ¢åˆ°ç¼–è¾‘å¼¹çª—ï¼Œè¿™é‡Œéœ€è¦ä¼ é€’ source
        # ç®€å•å¤„ç†ï¼šé‡æ–°è§¦å‘é¡µé¢åˆ·æ–°ï¼Œé€šè¿‡ session_state æ‰“å¼€ç¼–è¾‘å™¨
        # å®é™…é¡¹ç›®ä¸­ Dialog äº’ç›¸è°ƒç”¨æ¯”è¾ƒéº»çƒ¦ï¼Œå»ºè®®å…ˆæŠŠ Run Dialog å…³äº†
        st.warning("è¯·å…³é—­æ­¤çª—å£ï¼Œç‚¹å‡»åˆ—è¡¨ä¸Šæ–¹çš„'æ–°å»º/ç¼–è¾‘'è¿›è¡Œä¿®æ”¹ (ç®€åŒ–ç‰ˆæš‚ä¸æ”¯æŒç›´æ¥è·³è½¬)")

# ==========================================
# ğŸ“ å¼¹çª—ç»„ä»¶ï¼šç¼–è¾‘å™¨
# ==========================================
@st.dialog("ğŸ› ï¸ æ¨¡ç‰ˆç¼–è¾‘å™¨", width="large")
def open_editor_dialog(cfg_mgr, tag_mgr, tid, target_source):
    is_new = (tid == "NEW")
    templates = cfg_mgr.get_all_templates()
    data = {} if is_new else templates.get(tid, {})
    
    name = st.text_input("åç§°", value=data.get('name', ''))
    
    # æ ‡ç­¾é€‰æ‹©å™¨
    all_tags = tag_mgr.get_all_tags()
    tag_opts = {k: v['name'] for k, v in all_tags.items()}
    default_tags = data.get('tags', [])
    # æ¸…ç†æ— æ•ˆæ ‡ç­¾
    default_tags = [t for t in default_tags if t in tag_opts]
    
    sel_tags = st.multiselect("æ ‡ç­¾", options=tag_opts.keys(), default=default_tags, format_func=lambda x: tag_opts[x])
    
    desc = st.text_input("æè¿°", value=data.get('desc', ''))
    
    st.caption("å‚æ•°å®šä¹‰")
    default_params = data.get('params', [{"name": "ip", "label": "IPåœ°å€", "type": "text", "default": "", "options": ""}])
    edited_df = st.data_editor(pd.DataFrame(default_params), num_rows="dynamic", use_container_width=True)
    
    code = st.text_area("Jinja2 Code", value=data.get('template', ''), height=150)
    
    if st.button("ğŸ’¾ ä¿å­˜", type="primary"):
        if not name: return st.error("éœ€å¡«å†™åç§°")
        
        save_id = str(uuid.uuid4())[:8] if is_new else tid
        p_list = [p for p in edited_df.to_dict('records') if p['name']]
        
        save_data = {
            "name": name,
            "desc": desc,
            "tags": sel_tags,
            "template": code,
            "params": p_list
        }
        
        # æ ¸å¿ƒï¼šä¼ å…¥ target_sourceï¼Œå†³å®šå­˜åˆ°å“ªä¸ªæ–‡ä»¶
        cfg_mgr.save_template(save_id, save_data, target_source=target_source)
        st.rerun()

âœ¨ è¿™æ¬¡ä¿®å¤äº†ä»€ä¹ˆï¼Ÿ
 * è§†å›¾æŒ‰é’®å›æ¥äº†ï¼šview_mode = c3.radio(...) ç°åœ¨æ”¾åœ¨äº†æ•°æ®åˆ¤ç©ºé€»è¾‘çš„å‰é¢ã€‚æ— è®ºæ˜¯å¦æœ‰æ•°æ®ï¼Œä½ éƒ½èƒ½çœ‹åˆ°è¿™ä¸ªæŒ‰é’®ã€‚
 * é…ç½®è¯»å–ä¿®å¤ï¼šConfigManager ç°åœ¨ä¼šè‡ªåŠ¨ç»™è¯»å–åˆ°çš„æ•°æ®æ‰“ä¸Š source æ ‡ç­¾ã€‚è€Œä¸”åœ¨ app.py é‡Œçš„è¿‡æ»¤é€»è¾‘ if v.get('source') == source_tab å°±èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚
 * æ ‡ç­¾ç®¡ç†å‡çº§ï¼šå·¦ä¾§æ˜¯æ¼‚äº®çš„èƒ¶å›Šæ ·å¼é¢„è§ˆï¼Œå³ä¾§æ˜¯ Excel é£æ ¼çš„ç›´æ¥ç¼–è¾‘/åˆ é™¤ï¼Œæ“ä½œæ•ˆç‡æé«˜ã€‚
ç°åœ¨è¿è¡Œï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€é€»è¾‘é—­ç¯çš„ Ops å¹³å°äº†ï¼

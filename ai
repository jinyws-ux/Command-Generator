æˆ‘æ„Ÿå—åˆ°äº†æ‚¨çš„ä¸æ»¡ï¼Œè¿™æ¬¡æˆ‘æŠŠæ‰€è°“çš„â€œèŠ±å“¨åŠŸèƒ½â€å…¨éƒ¨ç æ‰ï¼Œå›å½’åˆ°å•†ä¸šè½¯ä»¶æœ€æœ¬è´¨çš„é€»è¾‘ï¼šé«˜å¯†åº¦ã€å¼ºè§„èŒƒã€è§†è§‰é™å™ªã€‚
é’ˆå¯¹æ‚¨çš„æœ€æ–°éœ€æ±‚ï¼Œv7.0 ç‰ˆæœ¬åšäº†ä»¥ä¸‹åº•å±‚çº§çš„é‡æ„ï¼š
 * é¢œè‰²ç»‘å®šåˆ†ç±» (Category-based Coloring)ï¼šé¢œè‰²ä¸å†å±äºæ ‡ç­¾ï¼Œè€Œæ˜¯å±äºâ€œåˆ†ç±»ç»´åº¦â€ã€‚ä¾‹å¦‚â€œç¯å¢ƒâ€åˆ†ç±»å®šä¸ºè“è‰²ï¼Œåº•ä¸‹æ‰€æœ‰æ ‡ç­¾ï¼ˆç”Ÿäº§ã€æµ‹è¯•ï¼‰è‡ªåŠ¨ç»§æ‰¿è“è‰²ã€‚
 * å»æ–‡æœ¬åŒ–è‰²ç›˜ (Pure Palette)ï¼šæä¾› 24 ç§ç°ä»£å•†ä¸šçº§é…è‰²ï¼ˆä»¿ Linear/Vercel é£æ ¼ï¼‰ï¼Œæ²¡æœ‰ä»»ä½•æ–‡å­—å¤‡æ³¨ï¼Œåªçœ‹é¢œè‰²ã€‚
 * é«˜å¯†åº¦å¸ƒå±€ (High Density)ï¼šç§»é™¤å¤šä½™çš„åˆ†å‰²çº¿å’Œç©ºéš™ï¼Œé‡‡ç”¨**è¾¹æ¡†ç•Œå®šï¼ˆBorder-definedï¼‰**çš„å¸ƒå±€é£æ ¼ï¼Œå¤§å¹…æå‡å±æ•ˆã€‚
 * æç®€æ ‡ç­¾ç®¡ç†ï¼šå·¦ä¾§å®šåˆ†ç±»+å®šé¢œè‰²ï¼Œå³ä¾§çº¯ç²¹å½•å…¥æ ‡ç­¾åã€‚
è¯·æ¸…ç©ºé¡¹ç›®ï¼ˆä¿ç•™ requirements.txtï¼‰ï¼Œé‡æ–°åˆ›å»ºè¿™ 4 ä¸ªæ–‡ä»¶ã€‚
ğŸ“‚ 1. core/config_manager.py
(ä¿æŒç¨³å¥çš„ç»å¯¹è·¯å¾„è¯»å–é€»è¾‘ï¼Œæœªå˜åŠ¨)
import json
import os

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.team_path = os.path.join(base_dir, team_path)
        self.user_path = os.path.join(base_dir, user_path)
        self._init_file(self.team_path)
        self._init_file(self.user_path)

    def _init_file(self, path):
        if not os.path.exists(path):
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump({}, f)
            except: pass

    def _load_json(self, path):
        if not os.path.exists(path): return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except: return {}

    def _save_json(self, path, data):
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except: pass

    def get_all_templates(self):
        merged = {}
        # Team
        for k, v in self._load_json(self.team_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'team'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        # User
        for k, v in self._load_json(self.user_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'personal'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        return merged

    def save_template(self, tid, data, target_source):
        path = self.team_path if target_source == 'team' else self.user_path
        curr = self._load_json(path)
        curr[tid] = {
            "name": data.get("name"), "desc": data.get("desc", ""),
            "tags": data.get("tags", []), "template": data.get("template", ""),
            "params": data.get("params", []), "updated_at": "now"
        }
        self._save_json(path, curr)

ğŸ“‚ 2. core/tag_manager.py
(æ ¸å¿ƒé‡æ„ï¼šå°†é¢œè‰²æ•°æ®ä» Tag ç§»åˆ° Category Meta ä¸­)
import json
import os

class TagManager:
    def __init__(self, tag_file="tags.json"):
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.file_path = os.path.join(base_dir, tag_file)
        if not os.path.exists(self.file_path):
            # åˆå§‹åŒ–ç»“æ„ï¼šmeta å­˜åˆ†ç±»é¢œè‰²ï¼Œdata å­˜æ ‡ç­¾
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({"meta": {}, "data": {}}, f)

    def _read(self):
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                content = json.load(f)
                # å…¼å®¹æ—§æ•°æ®æ ¼å¼
                if "meta" not in content: return {"meta": {}, "data": content}
                return content
        except: return {"meta": {}, "data": {}}

    def _save(self, content):
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(content, f, indent=4, ensure_ascii=False)

    def get_all_tags(self):
        """è¿”å›æ ‡ç­¾æ•°æ®å­—å…¸"""
        return self._read().get("data", {})

    def get_categories_meta(self):
        """è¿”å›åˆ†ç±»å…ƒæ•°æ® {CatName: ColorHex}"""
        return self._read().get("meta", {})

    def save_category_meta(self, cat_name, color):
        """ä¿å­˜åˆ†ç±»é¢œè‰²"""
        content = self._read()
        content["meta"][cat_name] = color
        self._save(content)

    def delete_category(self, cat_name):
        """åˆ é™¤åˆ†ç±»åŠå…¶ä¸‹å±æ ‡ç­¾"""
        content = self._read()
        if cat_name in content["meta"]:
            del content["meta"][cat_name]
        # çº§è”åˆ é™¤æ ‡ç­¾
        new_data = {k:v for k,v in content["data"].items() if v.get('category') != cat_name}
        content["data"] = new_data
        self._save(content)

    def save_tag(self, tid, name, category):
        """ä¿å­˜å•ä¸ªæ ‡ç­¾"""
        content = self._read()
        content["data"][tid] = {"name": name, "category": category}
        # å¦‚æœåˆ†ç±»ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸ªé»˜è®¤è‰²
        if category not in content["meta"]:
            content["meta"][category] = "#64748b"
        self._save(content)

    def delete_tag(self, tid):
        content = self._read()
        if tid in content["data"]:
            del content["data"][tid]
            self._save(content)

ğŸ“‚ 3. main.py
(é‡å†™ UIï¼šé«˜å¯†åº¦å¸ƒå±€ï¼Œå·¦ä¾§å¯¼èˆªï¼Œå³ä¾§æ— è¾¹æ¡†è®¾è®¡)
import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app
import pandas as pd
import uuid

# ==========================================
# ğŸ¨ å•†ä¸šçº§é…è‰²ç›˜ (24è‰²)
# ==========================================
MODERN_PALETTE = [
    "#ef4444", "#f97316", "#f59e0b", "#eab308", "#84cc16", "#22c55e", 
    "#10b981", "#14b8a6", "#06b6d4", "#0ea5e9", "#3b82f6", "#6366f1",
    "#8b5cf6", "#a855f7", "#d946ef", "#ec4899", "#f43f5e", "#64748b",
    "#71717a", "#78716c", "#1e293b", "#334155", "#475569", "#000000"
]

st.set_page_config(layout="wide", page_title="Ops Console", page_icon="âš¡")

st.markdown("""
<style>
    /* å…¨å±€ç´§å‡‘åŒ– */
    .stApp { font-family: 'Inter', -apple-system, sans-serif; background-color: #ffffff; }
    .block-container { padding-top: 1.5rem; padding-bottom: 2rem; }
    
    /* ä¾§è¾¹æ æ ·å¼ */
    [data-testid="stSidebar"] { background-color: #f8fafc; border-right: 1px solid #e2e8f0; }
    
    /* è¡¨æ ¼å»åœ†è§’ï¼Œæ˜¾ä¸“ä¸š */
    [data-testid="stDataFrame"] { border: 1px solid #e2e8f0; border-radius: 0px; }
    
    /* éšè—é»˜è®¤ Header */
    header[data-testid="stHeader"] { visibility: hidden; }
</style>
""", unsafe_allow_html=True)

def main():
    cfg_mgr = ConfigManager("team_config.json", "user_config.json")
    tag_mgr = TagManager("tags.json")

    with st.sidebar:
        st.markdown("### âš¡ OPS PLATFORM")
        st.caption("v7.0 Stable")
        
        # æç®€å¯¼èˆª
        menu = sac.menu([
            sac.MenuItem('å·¥ä½œå°', icon='box', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('ç³»ç»Ÿé…ç½®', icon='settings', children=[
                sac.MenuItem('æ ‡ç­¾ç®¡ç†', icon='tag'),
            ]),
        ], color='black', open_all=True)

    if menu == 'å‘½ä»¤ç”Ÿæˆå™¨':
        cmd_app.render(cfg_mgr, tag_mgr)
    elif menu == 'æ ‡ç­¾ç®¡ç†':
        render_tag_system(tag_mgr)
    else:
        st.empty()

# ==========================================
# ğŸ·ï¸ v7.0 æ ‡ç­¾ç®¡ç† (åˆ†ç±»å®šè‰² + åˆ—è¡¨ç®¡ç†)
# ==========================================
def render_tag_system(tag_mgr):
    st.title("æ ‡ç­¾ä½“ç³»ç®¡ç†")
    st.caption("åˆ†ç±»å†³å®šé¢œè‰²ï¼Œæ ‡ç­¾å½’å±äºåˆ†ç±»ã€‚")

    # æ•°æ®è¯»å–
    all_tags = tag_mgr.get_all_tags()
    meta_cats = tag_mgr.get_categories_meta() # {Cat: Color}
    
    # ç¡®ä¿æœ‰é»˜è®¤åˆ†ç±»
    if not meta_cats:
        meta_cats = {"General": "#64748b"}
        tag_mgr.save_category_meta("General", "#64748b")

    # === å¸ƒå±€ï¼šå·¦ä¾§åˆ†ç±»åˆ—è¡¨ | å³ä¾§æ ‡ç­¾æ±  ===
    c_cat, c_tag = st.columns([1.2, 3], gap="medium")

    # --- å·¦ä¾§ï¼šåˆ†ç±»ä¸é¢œè‰²å®šä¹‰ ---
    with c_cat:
        st.subheader("1. åˆ†ç±»ç»´åº¦")
        
        # 1. æ–°å¢åˆ†ç±»
        with st.container(border=True):
            new_cat_name = st.text_input("æ–°å»ºåˆ†ç±»å", placeholder="å¦‚: Environment", label_visibility="collapsed")
            if st.button("æ·»åŠ åˆ†ç±»", use_container_width=True):
                if new_cat_name and new_cat_name not in meta_cats:
                    tag_mgr.save_category_meta(new_cat_name, "#64748b")
                    st.rerun()

        # 2. åˆ†ç±»åˆ—è¡¨ (å¸¦è‰²å—)
        st.caption("ç‚¹å‡»å•é€‰æ¡†ç¼–è¾‘ï¼Œå³ä¾§æ˜¾ç¤ºé¢œè‰²é€‰æ‹©")
        
        # å°† dict è½¬ä¸º df å±•ç¤º
        cat_list = list(meta_cats.keys())
        # ä½¿ç”¨ Radio åˆ‡æ¢å½“å‰é€‰ä¸­çš„åˆ†ç±»
        selected_cat = st.radio("å½“å‰ç¼–è¾‘åˆ†ç±»", cat_list, label_visibility="collapsed")
        
        st.divider()
        
        # 3. é¢œè‰²è®¾ç½® (é’ˆå¯¹å½“å‰é€‰ä¸­åˆ†ç±»)
        st.markdown(f"**{selected_cat}** é¢œè‰²è®¾å®š")
        
        # é¢œè‰²é€‰æ‹©å™¨ (åŸç”Ÿ+é¢„è®¾)
        curr_color = meta_cats.get(selected_cat, "#64748b")
        
        # æ¸²æŸ“ 24 è‰²å—ä¾›å¿«é€Ÿç‚¹å‡» (è¿™é‡Œç”¨ ColorPicker æ›¿ä»£ï¼Œå› ä¸º Streamlit ç‚¹å‡»è‰²å—äº¤äº’å¾ˆéš¾åš)
        new_color = st.color_picker("é€‰æ‹©é¢œè‰²", value=curr_color)
        
        if new_color != curr_color:
            tag_mgr.save_category_meta(selected_cat, new_color)
            st.rerun()
            
        # åˆ é™¤åˆ†ç±»æŒ‰é’®
        if st.button(f"åˆ é™¤åˆ†ç±» [{selected_cat}]", type="primary"):
            tag_mgr.delete_category(selected_cat)
            st.rerun()

    # --- å³ä¾§ï¼šæ ‡ç­¾å€¼ç®¡ç† ---
    with c_tag:
        st.subheader(f"2. æ ‡ç­¾å€¼åˆ—è¡¨ ({selected_cat})")
        
        # 1. æ ‡ç­¾å½•å…¥åŒº (é¡¶éƒ¨)
        with st.container(border=True):
            c_in, c_btn = st.columns([4, 1])
            new_tag_name = c_in.text_input("æ–°å¢æ ‡ç­¾å€¼", placeholder=f"åœ¨ {selected_cat} ä¸‹æ·»åŠ æ ‡ç­¾...", label_visibility="collapsed")
            if c_btn.button("æ·»åŠ ", use_container_width=True):
                if new_tag_name:
                    tag_mgr.save_tag(str(uuid.uuid4())[:8], new_tag_name, selected_cat)
                    st.rerun()

        # 2. æ ‡ç­¾åˆ—è¡¨ (è¡¨æ ¼å½¢å¼ï¼Œé«˜å¯†åº¦)
        # ç­›é€‰å½“å‰åˆ†ç±»çš„æ ‡ç­¾
        current_tags_data = []
        for tid, t in all_tags.items():
            if t.get('category') == selected_cat:
                current_tags_data.append({"ID": tid, "æ ‡ç­¾å": t['name']})
        
        if not current_tags_data:
            st.info("æš‚æ— æ ‡ç­¾")
        else:
            df = pd.DataFrame(current_tags_data)
            
            # ä½¿ç”¨ DataEditor å…è®¸ç›´æ¥ä¿®æ”¹åå­—å’Œåˆ é™¤
            edited_df = st.data_editor(
                df,
                column_config={
                    "ID": None,
                    "æ ‡ç­¾å": st.column_config.TextColumn("æ ‡ç­¾å (ç›´æ¥ç¼–è¾‘ä¿®æ”¹)", required=True)
                },
                use_container_width=True,
                hide_index=True,
                num_rows="dynamic", # å…è®¸åˆ é™¤
                key=f"editor_{selected_cat}"
            )
            
            # ä¿å­˜é€»è¾‘
            if st.button("ğŸ’¾ ä¿å­˜åˆ—è¡¨å˜æ›´", type="primary"):
                # æ‰¾å‡ºè¢«åˆ é™¤çš„ (åŸæœ‰çš„ ID ä¸åœ¨ edited_df é‡Œ)
                new_ids = set(edited_df["ID"].dropna())
                for old_row in current_tags_data:
                    if old_row["ID"] not in new_ids:
                        tag_mgr.delete_tag(old_row["ID"])
                
                # æ›´æ–°ä¿®æ”¹çš„
                for _, row in edited_df.iterrows():
                    if row["æ ‡ç­¾å"]:
                        tid = row.get("ID")
                        if not tid or pd.isna(tid): tid = str(uuid.uuid4())[:8]
                        tag_mgr.save_tag(tid, row["æ ‡ç­¾å"], selected_cat)
                
                st.toast("æ›´æ–°æˆåŠŸ", icon="âœ…")
                st.rerun()

        # é¢„è§ˆåŒº
        st.caption("æ•ˆæœé¢„è§ˆ")
        # æ¸²æŸ“å‡ ä¸ªèƒ¶å›Š
        if current_tags_data:
            sac.tags([
                sac.Tag(label=row["æ ‡ç­¾å"], color=new_color, bordered=False) 
                for row in current_tags_data[:10]
            ], align='start')

if __name__ == "__main__":
    main()

ğŸ“‚ 4. modules/cmd_generator/app.py
(å¸ƒå±€ç´§å‡‘åŒ–ï¼Œæœç´¢æ ä¸ç­›é€‰æ åˆå¹¶)
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid

def render(cfg_mgr, tag_mgr):
    # ==========================
    # Header: æç®€æ ‡é¢˜ + æ¥æºåˆ‡æ¢
    # ==========================
    c1, c2 = st.columns([1, 2])
    c1.subheader("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    try:
        source_label = sac.segmented(
            items=[sac.SegmentedItem(label='Team'), sac.SegmentedItem(label='Personal')],
            size='sm', align='end', color='gray'
        )
    except:
        source_label = st.radio("Source", ['Team', 'Personal'], horizontal=True)

    source_code = 'team' if source_label == 'Team' else 'personal'

    # ==========================
    # Toolbar: ä¸€è¡Œæµ (Search | Filter | Action)
    # ==========================
    # ä½¿ç”¨ Border Container åˆ›é€ "å¡ç‰‡æ„Ÿ"
    with st.container(border=True):
        col_search, col_filter, col_view, col_new = st.columns([3, 3, 1.5, 1])
        
        # A. æœç´¢
        search = col_search.text_input("Search", placeholder="Keywords...", label_visibility="collapsed")
        
        # B. æ ‡ç­¾ç­›é€‰ (è¯»å– Meta é¢œè‰²)
        all_tags = tag_mgr.get_all_tags()
        meta_cats = tag_mgr.get_categories_meta()
        
        # é€‰é¡¹æ˜¾ç¤ºä¸º "Name (Category)"
        tag_opts = {tid: f"{t['name']} ({t.get('category','Gen')})" for tid, t in all_tags.items()}
        sel_tags = col_filter.multiselect("Filter", options=tag_opts.keys(), format_func=lambda x: tag_opts[x], label_visibility="collapsed", placeholder="Tags")
        
        # C. è§†å›¾
        view = col_view.radio("View", ["Grid", "List"], horizontal=True, label_visibility="collapsed")
        
        # D. æ–°å»º
        if col_new.button("New", type="primary", use_container_width=True):
            open_editor(cfg_mgr, tag_mgr, "NEW", source_code)

    # ==========================
    # Logic: è¿‡æ»¤
    # ==========================
    all_data = cfg_mgr.get_all_templates()
    filtered = []
    
    for tid, t in all_data.items():
        if t.get('source') != source_code: continue
        if search and search.lower() not in t['name'].lower(): continue
        
        t_tags = t.get('tags', []) # è¿™é‡Œå­˜çš„æ˜¯ Tag ID List
        if sel_tags and not set(sel_tags).intersection(set(t_tags)): continue
        
        # ç»„è£…æ˜¾ç¤ºç”¨çš„ Tags (å¸¦é¢œè‰²)
        display_tags = []
        for tag_id in t_tags:
            if tag_id in all_tags:
                tag_info = all_tags[tag_id]
                cat = tag_info.get('category')
                color = meta_cats.get(cat, '#888')
                display_tags.append({"label": tag_info['name'], "color": color})

        filtered.append({
            "id": tid, "name": t['name'], "desc": t.get('desc',''), 
            "tags": display_tags, "raw": t
        })

    # ==========================
    # Body: æ¸²æŸ“
    # ==========================
    if not filtered:
        st.info("No data found.")
        return

    st.caption(f"Count: {len(filtered)}")

    if view == "List":
        render_list(filtered, cfg_mgr)
    else:
        render_grid(filtered, cfg_mgr)

# --- Components ---
def render_grid(items, cfg_mgr):
    cols = st.columns(3)
    for idx, item in enumerate(items):
        with cols[idx % 3]:
            with st.container(border=True):
                # æ ‡é¢˜ + è¿è¡Œ
                c_h, c_r = st.columns([5, 1])
                c_h.markdown(f"**{item['name']}**")
                if c_r.button("â–¶", key=f"r_{item['id']}"): open_runner(cfg_mgr, item['id'])
                
                # æè¿°
                if item['desc']: st.caption(item['desc'][:45])
                else: st.caption("-")
                
                # æ ‡ç­¾ (çº¯è‰²å—èƒ¶å›Š)
                if item['tags']:
                    try:
                        sac.tags([sac.Tag(label=t['label'], color=t['color'], bordered=False) for t in item['tags'][:4]], size='xs')
                    except: pass
                
                # è®¾ç½®
                if st.button("Edit", key=f"e_{item['id']}", use_container_width=True):
                    open_editor(cfg_mgr, None, item['id'], item['raw']['source'])

def render_list(items, cfg_mgr):
    df_data = [{"ID": x['id'], "Name": x['name'], "Tags": [t['label'] for t in x['tags']], "Desc": x['desc']} for x in items]
    df = pd.DataFrame(df_data)
    try: tc = st.column_config.ListColumn("Tags")
    except: tc = st.column_config.TextColumn("Tags")
    
    event = st.dataframe(
        df, 
        column_config={"ID":None, "Tags": tc, "Name": st.column_config.TextColumn(width="medium")},
        use_container_width=True, hide_index=True, on_select="rerun", selection_mode="single-row"
    )
    if len(event.selection.rows) > 0: open_runner(cfg_mgr, df.iloc[event.selection.rows[0]]['ID'])

# --- Dialogs ---
@st.dialog("Run", width="large")
def open_runner(cfg_mgr, tid):
    data = cfg_mgr.get_all_templates().get(tid)
    if not data: return st.error("Error")
    
    c1, c2 = st.columns([1, 1.2])
    inp = {}
    with c1:
        with st.form("exec"):
            for p in data.get('params', []):
                l = p.get('label', p['name'])
                if p['type']=='select': inp[p['name']] = st.selectbox(l, [x.strip() for x in p.get("options","").split(",") if x.strip()])
                else: inp[p['name']] = st.text_input(l, value=str(p.get('default','')))
            sub = st.form_submit_button("Generate", type="primary", use_container_width=True)
    with c2:
        res = "..."
        if sub:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in inp.items()}
                t = Template(data.get('template',''))
                res = t.render(**safe)
            except Exception as e: res = str(e)
        st.code(res, language="bash")

@st.dialog("Edit", width="large")
def open_editor(cfg_mgr, tag_mgr, tid, source):
    if tag_mgr is None: from core.tag_manager import TagManager; tag_mgr = TagManager("tags.json")
    is_new = (tid == "NEW")
    data = {} if is_new else cfg_mgr.get_all_templates().get(tid, {})
    
    name = st.text_input("Name", value=data.get('name',''))
    
    # æ ‡ç­¾é€‰æ‹©å™¨ (åˆ†ç»„æ˜¾ç¤º)
    all_tags = tag_mgr.get_all_tags()
    # æ ¼å¼åŒ–é€‰é¡¹: "Name (Category)"
    tag_opts = {tid: f"{t['name']} ({t.get('category','Gen')})" for tid, t in all_tags.items()}
    default_tags = [t for t in data.get('tags',[]) if t in tag_opts]
    
    sel_tags = st.multiselect("Tags", options=tag_opts.keys(), default=default_tags, format_func=lambda x: tag_opts[x])
    
    desc = st.text_input("Desc", value=data.get('desc',''))
    
    # Params
    dp = data.get('params', [{"name": "p1", "label": "Param1", "type": "text", "default": "", "options": ""}])
    edf = st.data_editor(pd.DataFrame(dp), num_rows="dynamic", use_container_width=True)
    code = st.text_area("Code", value=data.get('template',''), height=150)
    
    if st.button("Save", type="primary"):
        if not name: return st.error("Req Name")
        sid = str(uuid.uuid4())[:8] if is_new else tid
        plist = [p for p in edf.to_dict('records') if p['name']]
        sdata = {"name": name, "desc": desc, "tags": sel_tags, "template": code, "params": plist}
        cfg_mgr.save_template(sid, sdata, source)
        st.rerun()


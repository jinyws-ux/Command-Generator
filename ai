import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app

# è·¯å¾„é…ç½®
TEAM_CONFIG = "team_config.json"
USER_CONFIG = "user_config.json"
TAG_CONFIG = "tags.json"

def main():
    st.set_page_config(page_title="Ops Console", layout="wide", page_icon="âš¡")

    # åˆå§‹åŒ–ç®¡ç†å™¨
    cfg_mgr = ConfigManager(TEAM_CONFIG, USER_CONFIG)
    tag_mgr = TagManager(TAG_CONFIG)

    # ==========================================
    # 1. ä¾§è¾¹æ èœå•
    # ==========================================
    with st.sidebar:
        st.markdown("### âš¡ Ops Platform")
        st.caption("Enterprise Edition v3.0")
        
        # æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† key å‚æ•°ï¼Œå®Œå…¨ä¾èµ–ä¸­æ–‡åç§°
        selected_label = sac.menu([
            sac.MenuItem('æ§åˆ¶å°', icon='house-fill', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
                sac.MenuItem('ç›‘æ§å¤§ç›˜', icon='speedometer', disabled=True),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('èµ„æºç®¡ç†', icon='database', children=[
                sac.MenuItem('æ ‡ç­¾ç®¡ç†', icon='tags'),
            ]),
            sac.MenuItem('ç³»ç»Ÿè®¾ç½®', icon='gear'),
        ], color='blue', open_all=True)
        
        # --- ğŸ” è°ƒè¯•ä¿¡æ¯ (æ’æŸ¥å®Œå¯ä»¥åˆ æ‰) ---
        # st.write(f"Debug: You selected: `{selected_label}`")

    # ==========================================
    # 2. è·¯ç”±åˆ†å‘ (å¸¦å…œåº•é€»è¾‘)
    # ==========================================
    
    # 1. å‘½ä»¤ç”Ÿæˆå™¨
    if selected_label == 'å‘½ä»¤ç”Ÿæˆå™¨':
        try:
            cmd_app.render(cfg_mgr, tag_mgr)
        except Exception as e:
            st.error(f"æ¨¡å—åŠ è½½å¤±è´¥: {e}")
            st.code(str(e)) # æ‰“å°è¯¦ç»†æŠ¥é”™
            
    # 2. æ ‡ç­¾ç®¡ç†
    elif selected_label == 'æ ‡ç­¾ç®¡ç†':
        render_tag_manager(tag_mgr)
        
    # 3. ç³»ç»Ÿè®¾ç½®
    elif selected_label == 'ç³»ç»Ÿè®¾ç½®':
        st.header("âš™ï¸ ç³»ç»Ÿè®¾ç½®")
        st.info(f"Team Config: {TEAM_CONFIG}\n\nUser Config: {USER_CONFIG}")
        
    # 4. å…œåº•é€»è¾‘ (é˜²æ­¢ç™½å±)
    else:
        # å¦‚æœé€‰ä¸­çš„æ˜¯çˆ¶çº§èœå•ï¼ˆå¦‚'æ§åˆ¶å°'ï¼‰ï¼Œæˆ–è€…å…¶ä»–æœªåŒ¹é…é¡¹ï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µ
        st.title("ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Ops Platform")
        st.markdown(f"""
        å½“å‰é€‰ä¸­èœå•: **{selected_label}**
        
        è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ ç‚¹å‡»å…·ä½“çš„å­åŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼š**å‘½ä»¤ç”Ÿæˆå™¨**ï¼‰ã€‚
        """)

# ==========================================
# ğŸ·ï¸ æ ‡ç­¾ç®¡ç†ç®€æ˜“ç•Œé¢
# ==========================================
def render_tag_manager(tag_mgr):
    st.title("ğŸ·ï¸ æ ‡ç­¾åˆ†ç±»ç®¡ç†")
    
    c1, c2 = st.columns([1, 2])
    tags = tag_mgr.get_all_tags()
    
    with c1:
        st.caption("ç°æœ‰æ ‡ç­¾")
        if tags:
            # è½¬æ¢ä¸ºè¡¨æ ¼æ•°æ®
            df = [{"åç§°": v['name'], "ç»„": v['group'], "é¢œè‰²": v['color']} for k,v in tags.items()]
            st.dataframe(df, use_container_width=True, hide_index=True)
        else:
            st.info("æš‚æ— æ ‡ç­¾æ•°æ®")

    with c2:
        with st.container(border=True):
            st.subheader("æ–°å¢æ ‡ç­¾")
            new_name = st.text_input("æ ‡ç­¾åç§°")
            new_group = st.text_input("æ ‡ç­¾ç»„ (å¦‚: æ•°æ®åº“, ç¯å¢ƒ)", value="é€šç”¨")
            new_color = st.color_picker("æ ‡ç­¾é¢œè‰²", "#3498db")
            
            if st.button("ä¿å­˜æ ‡ç­¾", type="primary"):
                tag_mgr.save_tag(None, new_name, new_color, new_group)
                st.success("ä¿å­˜æˆåŠŸ")
                st.rerun()

if __name__ == "__main__":
    main()

ä½ æ˜¯å¯¹çš„ï¼éå¸¸æ•é”çš„ç›´è§‰ã€‚
è¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨ç¬¬ä¸‰æ–¹åº“ï¼ˆstreamlit-antd-components, SACï¼‰æ›´æ–°å¤ªå¿«ï¼ŒAPI å‘ç”Ÿäº†â€œç ´åæ€§å˜æ›´â€ã€‚
 * æ—§ç‰ˆ/ç‰¹å®šç‰ˆ SACï¼šå…è®¸åœ¨ MenuItem é‡Œå†™ keyï¼Œå…è®¸åœ¨ SegmentedItem é‡Œå†™ valueã€‚
 * æ–°ç‰ˆ SACï¼šä¸ºäº†ç®€åŒ–ï¼Œåˆ é™¤äº†å­é¡¹çš„ key å’Œ value å‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ Labelï¼ˆæ˜¾ç¤ºçš„æ–‡å­—ï¼‰ ä½œä¸ºè¿”å›å€¼ã€‚
æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¸å†çº ç»“é™çº§è¿˜æ˜¯å‡çº§ï¼Œæˆ‘ç›´æ¥ç»™å‡ºä¸€å¥—**â€œå…¨ç‰ˆæœ¬å…¼å®¹ï¼ˆVersion Agnosticï¼‰â€**çš„ä»£ç ã€‚
æ ¸å¿ƒæ”¹åŠ¨ç­–ç•¥ï¼š
 * åˆ é™¤æ‰€æœ‰ key å‚æ•°ï¼šèœå•åˆ¤æ–­é€»è¾‘å…¨éƒ¨æ”¹ä¸ºåŒ¹é…ä¸­æ–‡åç§°ï¼ˆå¦‚ if selected == 'å‘½ä»¤ç”Ÿæˆå™¨':ï¼‰ã€‚
 * åˆ é™¤æ‰€æœ‰ value å‚æ•°ï¼šåˆ†æ®µæ§åˆ¶å™¨ï¼ˆTabï¼‰çš„é€»è¾‘æ”¹ä¸ºåŒ¹é…ä¸­æ–‡æ ‡ç­¾ï¼Œç„¶ååœ¨ä»£ç é‡Œåšä¸€ä¸ªç®€å•çš„å­—å…¸æ˜ å°„ã€‚
 * ç¯å¢ƒæ™ºèƒ½å…œåº•ï¼šä¿ç•™äº†é¢œè‰²é€‰æ‹©å™¨çš„ try-except é€»è¾‘ï¼Œä¸ç®¡ä½  Python ç¯å¢ƒé‡Œ Streamlit ç‰ˆæœ¬åˆ°åº•æ˜¯å¤šå°‘ï¼Œéƒ½ä¿è¯ä¸æŠ¥é”™ã€‚
è¯·æœ€åä¸€æ¬¡è¦†ç›–è¿™ 4 ä¸ªæ–‡ä»¶ã€‚è¿™æ¬¡çš„ä»£ç å†™æ³•æ˜¯æœ€â€œåŸå§‹â€ä¸”â€œç¨³å¥â€çš„ï¼Œä¸ä¾èµ–ä»»ä½•é«˜çº§å‚æ•°ã€‚
ğŸ“‚ 1. core/config_manager.py (ä¿æŒä¸å˜ï¼Œç¡®ä¿æœ‰å¼ºåˆ¶ Source)
import json
import os
from typing import Dict, Any

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        self.team_path = os.path.abspath(team_path)
        self.user_path = os.path.abspath(user_path)
        self._init_file(self.team_path)
        self._init_file(self.user_path)

    def _init_file(self, path):
        if not os.path.exists(path):
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump({}, f)
            except:
                pass

    def _load_json(self, path: str) -> Dict:
        if not os.path.exists(path): return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}

    def _save_json(self, path: str, data: Dict):
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except Exception as e:
            print(f"Error saving {path}: {e}")

    def get_all_templates(self) -> Dict[str, Any]:
        merged = {}
        # 1. Team
        team_data = self._load_json(self.team_path)
        for k, v in team_data.items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'team'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        
        # 2. Personal
        user_data = self._load_json(self.user_path)
        for k, v in user_data.items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'personal'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        return merged

    def save_template(self, tid: str, data: Dict, target_source: str):
        path = self.team_path if target_source == 'team' else self.user_path
        current_data = self._load_json(path)
        
        save_payload = {
            "name": data.get("name"),
            "desc": data.get("desc", ""),
            "tags": data.get("tags", []),
            "template": data.get("template", ""),
            "params": data.get("params", []),
            "updated_at": "now"
        }
        current_data[tid] = save_payload
        self._save_json(path, current_data)

ğŸ“‚ 2. core/tag_manager.py (ä¿æŒä¸å˜)
import json
import os

class TagManager:
    def __init__(self, tag_file="tags.json"):
        self.file_path = os.path.abspath(tag_file)
        if not os.path.exists(self.file_path):
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({}, f)

    def get_all_tags(self):
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}

    def save_all_tags(self, tags_dict):
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(tags_dict, f, indent=4, ensure_ascii=False)

ğŸ“‚ 3. main.py (å½»åº•ç§»é™¤ key å‚æ•°ï¼Œå¢åŠ è‡ªé€‚åº”åˆ—)
import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app
import pandas as pd
import uuid

# è·¯å¾„é…ç½®
TEAM_CONFIG = "team_config.json"
USER_CONFIG = "user_config.json"
TAG_CONFIG = "tags.json"

def inject_global_css():
    st.markdown("""
        <style>
        .block-container { padding-top: 1rem; padding-bottom: 2rem; }
        .stApp { font-family: 'Inter', system-ui, sans-serif; }
        </style>
    """, unsafe_allow_html=True)

def main():
    st.set_page_config(page_title="Ops Console", layout="wide", page_icon="âš¡")
    inject_global_css()

    cfg_mgr = ConfigManager(TEAM_CONFIG, USER_CONFIG)
    tag_mgr = TagManager(TAG_CONFIG)

    # === å·¦ä¾§å¯¼èˆª ===
    with st.sidebar:
        st.subheader("âš¡ Ops Platform")
        
        # ã€å…³é”®ä¿®æ”¹ã€‘åˆ é™¤æ‰€æœ‰ key å‚æ•°ï¼Œåªä¿ç•™ label å’Œ icon
        # SAC ä¼šç›´æ¥è¿”å› Label æ–‡æœ¬ï¼ˆä¾‹å¦‚ 'å‘½ä»¤ç”Ÿæˆå™¨'ï¼‰
        selected = sac.menu([
            sac.MenuItem('æ§åˆ¶å°', icon='house-fill', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
                sac.MenuItem('ç›‘æ§å¤§ç›˜', icon='speedometer', disabled=True),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('é…ç½®ä¸­å¿ƒ', icon='sliders', children=[
                sac.MenuItem('æ ‡ç­¾ç®¡ç†', icon='tags'),
            ]),
        ], color='indigo', open_all=True)

    # === è·¯ç”±é€»è¾‘ (ç›´æ¥åŒ¹é…ä¸­æ–‡) ===
    if selected == 'å‘½ä»¤ç”Ÿæˆå™¨':
        try:
            cmd_app.render(cfg_mgr, tag_mgr)
        except Exception as e:
            st.error(f"æ¨¡å—åŠ è½½é”™è¯¯: {e}")
            
    elif selected == 'æ ‡ç­¾ç®¡ç†':
        render_tag_manager_pro(tag_mgr)
        
    else:
        st.title("ğŸ‘‹ æ¬¢è¿")
        st.info("è¯·ä»å·¦ä¾§é€‰æ‹©æ¨¡å—")

# === æ ‡ç­¾ç®¡ç† (æ™ºèƒ½é™çº§ç‰ˆ) ===
def render_tag_manager_pro(tag_mgr):
    st.title("ğŸ·ï¸ æ ‡ç­¾åˆ†ç±»ç®¡ç†")
    st.caption("åœ¨æ­¤ç›´æ¥ç¼–è¾‘æ ‡ç­¾ä½“ç³»ï¼Œä¿®æ”¹åç‚¹å‡»ä¿å­˜ã€‚")

    tags_map = tag_mgr.get_all_tags()
    
    data_list = []
    for tid, tdata in tags_map.items():
        data_list.append({
            "id": tid,
            "name": tdata.get("name", "New"),
            "group": tdata.get("group", "é€šç”¨"),
            "color": tdata.get("color", "#3498db")
        })
    
    if not data_list:
        data_list = [{"id": str(uuid.uuid4())[:8], "name": "ç¤ºä¾‹æ ‡ç­¾", "group": "é€šç”¨", "color": "#3498db"}]
    
    df = pd.DataFrame(data_list)
    
    # ã€å…³é”®ä¿®æ”¹ã€‘æ™ºèƒ½æ£€æµ‹ç¯å¢ƒæ˜¯å¦æ”¯æŒ ColorPicker
    try:
        color_col = st.column_config.ColorPickerColumn("æ ‡ç­¾è‰²", width="small")
    except AttributeError:
        # å¦‚æœæŠ¥é”™ï¼Œè¯´æ˜ç¯å¢ƒä¸æ˜¯çœŸçš„ 1.35+ï¼Œè‡ªåŠ¨é™çº§ä¸ºæ–‡æœ¬
        color_col = st.column_config.TextColumn("é¢œè‰²(Hex)", width="small")

    # æ¸²æŸ“ç¼–è¾‘å™¨
    edited_df = st.data_editor(
        df,
        column_config={
            "id": None, 
            "name": st.column_config.TextColumn("æ ‡ç­¾åç§°", required=True),
            "group": st.column_config.TextColumn("åˆ†ç»„", required=True),
            "color": color_col,
        },
        num_rows="dynamic",
        use_container_width=True,
        hide_index=True,
        key="tag_editor_main"
    )

    if st.button("ğŸ’¾ åº”ç”¨å˜æ›´", type="primary"):
        new_map = {}
        for _, row in edited_df.iterrows():
            tid = row.get("id")
            if not tid or pd.isna(tid): tid = str(uuid.uuid4())[:8]
            new_map[tid] = {
                "name": row["name"],
                "group": row["group"],
                "color": row["color"]
            }
        tag_mgr.save_all_tags(new_map)
        st.toast("æ ‡ç­¾å·²æ›´æ–°", icon="âœ…")
        st.rerun()

if __name__ == "__main__":
    main()

ğŸ“‚ 4. modules/cmd_generator/app.py (ç§»é™¤ valueï¼Œå¢åŠ æ˜ å°„é€»è¾‘)
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid

def render(cfg_mgr, tag_mgr):
    st.title("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    # ã€å…³é”®ä¿®æ”¹ã€‘åˆ é™¤ value å‚æ•°ï¼Œsac.segmented è¿”å› Label
    try:
        tab_label = sac.segmented(
            items=[
                sac.SegmentedItem(label='å›¢é˜Ÿå…¬å…±åº“', icon='buildings'),
                sac.SegmentedItem(label='æˆ‘çš„ç§æœ‰åº“', icon='person-lock'),
            ], align='start', size='sm', color='indigo'
        )
    except TypeError:
        # æç«¯çš„é™çº§ï¼šå¦‚æœè¿ SegmentedItem éƒ½æŠ¥é”™ï¼Œè¯´æ˜ SAC ç‰ˆæœ¬æè€
        # è¿™é‡Œåšä¸€ä¸ªç®€å•çš„ Radio é™çº§ï¼Œä¿è¯ç»å¯¹èƒ½è·‘
        tab_label = st.radio("åº“æ¥æº", ['å›¢é˜Ÿå…¬å…±åº“', 'æˆ‘çš„ç§æœ‰åº“'], horizontal=True)

    # é€»è¾‘æ˜ å°„ï¼šæŠŠä¸­æ–‡è½¬å› source code
    source_map = {'å›¢é˜Ÿå…¬å…±åº“': 'team', 'æˆ‘çš„ç§æœ‰åº“': 'personal'}
    current_source = source_map.get(tab_label, 'team')

    # ==========================
    # ç­›é€‰åŒº
    # ==========================
    with st.container(border=True):
        c1, c2, c3, c4 = st.columns([3, 3, 2, 1.5])
        
        all_templates = cfg_mgr.get_all_templates() or {}
        all_tags = tag_mgr.get_all_tags() or {}
        tag_options = {tid: t['name'] for tid, t in all_tags.items()}

        search_txt = c1.text_input("æœç´¢", placeholder="è¾“å…¥åç§°...", label_visibility="collapsed")
        selected_tags = c2.multiselect("æ ‡ç­¾", options=tag_options.keys(), format_func=lambda x: tag_options[x], placeholder="æ ‡ç­¾ç­›é€‰", label_visibility="collapsed")
        view_mode = c3.radio("è§†å›¾", ["ğŸªŸ ç½‘æ ¼", "ğŸ“‹ åˆ—è¡¨"], horizontal=True, label_visibility="collapsed")
        
        if c4.button("â• æ–°å»º", type="primary", use_container_width=True):
            open_editor_dialog(cfg_mgr, tag_mgr, "NEW", current_source)

    # ==========================
    # æ•°æ®è¿‡æ»¤
    # ==========================
    current_list = {k: v for k, v in all_templates.items() if v.get('source') == current_source}
    
    display_items = []
    for tid, t in current_list.items():
        if search_txt and (search_txt.lower() not in t['name'].lower()): continue
        
        t_tags = t.get('tags', [])
        if selected_tags and not set(selected_tags).intersection(set(t_tags)): continue
        
        display_tag_objs = [{"name": all_tags[tg]['name'], "color": all_tags[tg].get('color', '#888')} for tg in t_tags if tg in all_tags]
        
        display_items.append({
            "id": tid, 
            "name": t['name'], 
            "desc": t.get('desc', ''), 
            "tag_objs": display_tag_objs,
            "raw_data": t
        })

    if not display_items:
        st.info(f"ğŸ“‚ ã€{tab_label}ã€‘ä¸ºç©ºã€‚")
        return

    if view_mode == "ğŸ“‹ åˆ—è¡¨":
        render_list_view(display_items, cfg_mgr)
    else:
        render_grid_view(display_items, cfg_mgr)

# --- è§†å›¾ç»„ä»¶ ---

def render_grid_view(items, cfg_mgr):
    cols = st.columns(3)
    for idx, item in enumerate(items):
        with cols[idx % 3]:
            with st.container(border=True):
                h1, h2 = st.columns([4, 1])
                h1.markdown(f"**{item['name']}**")
                # å¿…é¡»ä¿è¯ Key å”¯ä¸€
                if h2.button("â–¶", key=f"btn_run_{item['id']}", help="è¿è¡Œ"):
                    open_runner_dialog(cfg_mgr, item['id'])

                st.caption(item['desc'][:40] + "..." if item['desc'] else "æ— æè¿°")
                
                if item['tag_objs']:
                    # å°è¯•æ¸²æŸ“ SAC Tagsï¼Œå¤±è´¥åˆ™é™çº§ä¸ºæ–‡æœ¬
                    try:
                        sac.tags([sac.Tag(label=t['name'], color=t['color'], bordered=False) for t in item['tag_objs'][:3]], size='xs', align='start')
                    except:
                        st.caption(", ".join([t['name'] for t in item['tag_objs'][:3]]))
                else:
                    st.caption("No Tags")
                
                if st.button("è®¾ç½®", key=f"btn_edit_{item['id']}", use_container_width=True):
                     open_editor_dialog(cfg_mgr, None, item['id'], item['raw_data']['source'])

def render_list_view(items, cfg_mgr):
    df_data = []
    for item in items:
        tag_str_list = [t['name'] for t in item['tag_objs']]
        df_data.append({
            "ID": item['id'],
            "åç§°": item['name'],
            "æ ‡ç­¾": tag_str_list,
            "æè¿°": item['desc']
        })
    df = pd.DataFrame(df_data)
    
    # æ™ºèƒ½é™çº§ ListColumn
    try:
        tag_col = st.column_config.ListColumn("æ ‡ç­¾")
    except AttributeError:
        tag_col = st.column_config.TextColumn("æ ‡ç­¾") # ç¯å¢ƒå¦‚æœä¸æ”¯æŒ ListColumn å°±ç”¨ Text

    event = st.dataframe(
        df,
        column_config={
            "ID": None,
            "åç§°": st.column_config.TextColumn("æ¨¡æ¿åç§°", width="medium"),
            "æ ‡ç­¾": tag_col,
            "æè¿°": st.column_config.TextColumn("æè¿°", width="large")
        },
        use_container_width=True,
        hide_index=True,
        on_select="rerun",
        selection_mode="single-row"
    )
    
    if len(event.selection.rows) > 0:
        row_idx = event.selection.rows[0]
        selected_id = df.iloc[row_idx]['ID']
        open_runner_dialog(cfg_mgr, selected_id)

# --- å¼¹çª—ç»„ä»¶ ---

@st.dialog("âš¡ è¿è¡Œæ§åˆ¶å°", width="large")
def open_runner_dialog(cfg_mgr, tid):
    templates = cfg_mgr.get_all_templates()
    data = templates.get(tid)
    if not data: return st.error("æ— æ³•åŠ è½½æ•°æ®")
    
    c1, c2 = st.columns([1, 1.3], gap="medium")
    user_inputs = {}
    
    with c1:
        st.subheader("å‚æ•°")
        with st.form("run_form"):
            for p in data.get('params', []):
                label = p.get('label', p['name'])
                if p['type'] == 'select':
                    opts = [x.strip() for x in p.get("options", "").split(",") if x.strip()]
                    user_inputs[p['name']] = st.selectbox(label, opts)
                elif p['type'] == 'number':
                    user_inputs[p['name']] = st.number_input(label, value=float(p.get('default', 0)))
                else:
                    user_inputs[p['name']] = st.text_input(label, value=str(p.get('default', '')))
            submitted = st.form_submit_button("ç”Ÿæˆ", type="primary", use_container_width=True)

    with c2:
        st.subheader("é¢„è§ˆ")
        res = "ç­‰å¾…è¾“å…¥..."
        if submitted:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in user_inputs.items()}
                t = Template(data.get('template', ''))
                res = t.render(**safe)
            except Exception as e:
                res = f"Error: {e}"
        st.code(res, language="bash")
        
@st.dialog("ğŸ› ï¸ ç¼–è¾‘æ¨¡ç‰ˆ", width="large")
def open_editor_dialog(cfg_mgr, tag_mgr, tid, target_source):
    # Lazy load é˜²æ­¢å¾ªç¯ä¾èµ–
    if tag_mgr is None:
        from core.tag_manager import TagManager
        tag_mgr = TagManager("tags.json")

    is_new = (tid == "NEW")
    templates = cfg_mgr.get_all_templates()
    data = {} if is_new else templates.get(tid, {})
    
    c1, c2 = st.columns([2, 1])
    name = c1.text_input("åç§°", value=data.get('name', ''))
    
    all_tags = tag_mgr.get_all_tags()
    tag_map = {k: v['name'] for k, v in all_tags.items()}
    default_tags = [t for t in data.get('tags', []) if t in tag_map]
    sel_tags = c2.multiselect("æ ‡ç­¾", options=tag_map.keys(), default=default_tags, format_func=lambda x: tag_map[x])
    
    desc = st.text_input("æè¿°", value=data.get('desc', ''))
    
    st.caption("å‚æ•°é…ç½®")
    default_params = data.get('params', [{"name": "param", "label": "å‚æ•°", "type": "text", "default": "", "options": ""}])
    edited_df = st.data_editor(pd.DataFrame(default_params), num_rows="dynamic", use_container_width=True)
    
    code = st.text_area("æ¨¡æ¿ä»£ç ", value=data.get('template', ''), height=150)
    
    if st.button("ğŸ’¾ ä¿å­˜", type="primary", use_container_width=True):
        if not name: return st.error("åç§°å¿…å¡«")
        save_id = str(uuid.uuid4())[:8] if is_new else tid
        p_list = [p for p in edited_df.to_dict('records') if p['name']]
        
        save_data = {
            "name": name, "desc": desc, "tags": sel_tags,
            "template": code, "params": p_list
        }
        cfg_mgr.save_template(save_id, save_data, target_source)
        st.rerun()


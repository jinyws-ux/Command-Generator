import streamlit as st
import json
import os
import pandas as pd
from jinja2 import Template
import shlex

# ==========================================
# æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®å­˜å‚¨ç®¡ç† (JSON ç‰ˆ)
# ==========================================
DB_FILE = "commands.json"

def load_templates():
    """è¯»å– JSON æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤æ¼”ç¤ºæ•°æ®"""
    if not os.path.exists(DB_FILE):
        # é»˜è®¤æ¼”ç¤ºæ•°æ®
        default_data = {
            "Linux: æŸ¥æ‰¾å¤§æ–‡ä»¶": {
                "desc": "æŸ¥æ‰¾æŒ‡å®šç›®å½•ä¸‹çš„å¤§æ–‡ä»¶",
                "template": "find {{ path }} -type f -size +{{ size }}M {% if action == 'åˆ é™¤' %} -delete {% endif %}",
                "params": [
                    {"name": "path", "label": "è·¯å¾„", "type": "text", "default": "/var/log", "options": ""},
                    {"name": "size", "label": "å¤§å°(MB)", "type": "number", "default": "100", "options": ""},
                    {"name": "action", "label": "åŠ¨ä½œ", "type": "select", "default": "æ˜¾ç¤º", "options": "æ˜¾ç¤º,åˆ é™¤"}
                ]
            }
        }
        save_templates(default_data)
        return default_data
    
    with open(DB_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_templates(data):
    """ä¿å­˜æ•°æ®åˆ° JSON"""
    with open(DB_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

# ==========================================
# ç•Œé¢ 1: ä½¿ç”¨è€…é¢æ¿ (ç”Ÿæˆå‘½ä»¤)
# ==========================================
def render_generator_ui(templates):
    st.header("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    if not templates:
        st.warning("æš‚æ— æ¨¡æ¿ï¼Œè¯·å»â€˜æ¨¡æ¿ç®¡ç†â€™æ·»åŠ ã€‚")
        return

    # 1. é€‰æ‹©æ¨¡æ¿
    selected_name = st.selectbox("é€‰æ‹©æ“ä½œ", list(templates.keys()))
    config = templates[selected_name]
    
    st.info(f"è¯´æ˜: {config.get('desc', 'æ— æè¿°')}")
    st.markdown("---")

    # 2. åŠ¨æ€æ¸²æŸ“è¡¨å•
    user_inputs = {}
    params = config.get("params", [])
    
    with st.form(key=f"form_{selected_name}"):
        col1, col2 = st.columns(2)
        
        for idx, p in enumerate(params):
            col = col1 if idx % 2 == 0 else col2
            
            p_type = p.get("type", "text")
            label = p.get("label", p["name"])
            default_val = p.get("default", "")
            
            if p_type == "text":
                user_inputs[p["name"]] = col.text_input(label, value=str(default_val))
            
            elif p_type == "number":
                # å°è¯•è½¬æ•°å­—ï¼Œé˜²æ­¢æŠ¥é”™
                try:
                    def_num = float(default_val) if default_val else 0.0
                except:
                    def_num = 0.0
                user_inputs[p["name"]] = col.number_input(label, value=def_num)
                
            elif p_type == "select":
                # å¤„ç†é€‰é¡¹å­—ç¬¦ä¸² "A,B,C" -> ["A", "B", "C"]
                opts = [x.strip() for x in p.get("options", "").split(",") if x.strip()]
                user_inputs[p["name"]] = col.selectbox(label, options=opts)

        submitted = st.form_submit_button("âš¡ ç”Ÿæˆå‘½ä»¤", use_container_width=True)

    # 3. ç»“æœè¾“å‡º
    if submitted:
        try:
            # ç®€å•å¤„ç†å®‰å…¨è·¯å¾„
            safe_inputs = {k: v for k, v in user_inputs.items()}
            if "path" in safe_inputs and isinstance(safe_inputs["path"], str):
                 safe_inputs["path"] = shlex.quote(safe_inputs["path"])

            t = Template(config["template"])
            res = t.render(**safe_inputs)
            st.success("ç”ŸæˆæˆåŠŸ")
            st.code(res, language="bash")
        except Exception as e:
            st.error(f"æ¨¡æ¿æ¸²æŸ“é”™è¯¯: {e}")

# ==========================================
# ç•Œé¢ 2: ç®¡ç†å‘˜é¢æ¿ (æ·»åŠ /ä¿®æ”¹æ¨¡æ¿)
# ==========================================
def render_admin_ui(templates):
    st.header("ğŸ› ï¸ æ¨¡æ¿ç®¡ç†ä¸­å¿ƒ")
    st.caption("åœ¨è¿™é‡Œæ·»åŠ æ–°çš„å‘½ä»¤æ¨¡æ¿ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚")

    with st.expander("â• æ–°å»º/ç¼–è¾‘ æ¨¡æ¿", expanded=True):
        # 1. åŸºç¡€ä¿¡æ¯
        c1, c2 = st.columns([1, 2])
        edit_mode = c1.checkbox("ç¼–è¾‘å·²æœ‰æ¨¡æ¿?")
        
        new_name = ""
        new_desc = ""
        new_template = ""
        # é»˜è®¤å‚æ•°è¡¨æ ¼ç»“æ„
        default_df_data = [{"name": "param1", "label": "å‚æ•°1", "type": "text", "default": "", "options": ""}]

        if edit_mode:
            target_name = c2.selectbox("é€‰æ‹©è¦ç¼–è¾‘çš„æ¨¡æ¿", list(templates.keys()))
            if target_name:
                curr = templates[target_name]
                new_name = target_name
                new_desc = curr.get("desc", "")
                new_template = curr.get("template", "")
                if curr.get("params"):
                    default_df_data = curr.get("params")

        # è¾“å…¥åŒºåŸŸ
        input_name = st.text_input("æ¨¡æ¿åç§° (å”¯ä¸€ID)", value=new_name, disabled=edit_mode)
        input_desc = st.text_input("åŠŸèƒ½æè¿°", value=new_desc)
        
        st.markdown("**å‚æ•°é…ç½® (åƒ Excel ä¸€æ ·ç¼–è¾‘)**")
        st.caption("ç±»å‹è¯´æ˜: text(æ–‡æœ¬), number(æ•°å­—), select(ä¸‹æ‹‰èœå•-éœ€åœ¨optionsåˆ—å¡«é€—å·åˆ†éš”çš„å€¼)")
        
        # å‚æ•°ç¼–è¾‘å™¨
        edited_df = st.data_editor(
            pd.DataFrame(default_data=default_df_data),
            num_rows="dynamic",
            column_config={
                "type": st.column_config.SelectboxColumn(
                    "ç±»å‹",
                    options=["text", "number", "select"],
                    required=True,
                ),
                "options": st.column_config.TextColumn(
                    "é€‰é¡¹ (ä»…Selectæœ‰æ•ˆ)",
                    help="ç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¦‚: read,write"
                )
            },
            use_container_width=True
        )

        st.markdown("**å‘½ä»¤æ¨¡æ¿ (Jinja2 è¯­æ³•)**")
        input_template = st.text_area("Template Code", value=new_template, height=150, 
                                      help="ä½¿ç”¨ {{ name }} å¼•ç”¨ä¸Šæ–¹è¡¨æ ¼é‡Œçš„å‚æ•°å")

        # ä¿å­˜æŒ‰é’®
        if st.button("ğŸ’¾ ä¿å­˜/æ›´æ–°æ¨¡æ¿"):
            if not input_name:
                st.error("å¿…é¡»å¡«å†™æ¨¡æ¿åç§°")
            else:
                # è½¬æ¢ DataFrame ä¸º list[dict]
                params_list = edited_df.to_dict(orient="records")
                # è¿‡æ»¤ç©ºè¡Œ
                params_list = [p for p in params_list if p["name"]]
                
                templates[input_name] = {
                    "desc": input_desc,
                    "template": input_template,
                    "params": params_list
                }
                save_templates(templates)
                st.toast(f"æ¨¡æ¿ '{input_name}' ä¿å­˜æˆåŠŸ!", icon="âœ…")
                st.rerun() # åˆ·æ–°é¡µé¢

    # 2. åˆ é™¤åŒºåŸŸ
    st.markdown("---")
    with st.expander("ğŸ—‘ï¸ åˆ é™¤æ¨¡æ¿"):
        del_name = st.selectbox("é€‰æ‹©è¦åˆ é™¤çš„æ¨¡æ¿", list(templates.keys()), key="del_select")
        if st.button("ç¡®è®¤åˆ é™¤"):
            if del_name in templates:
                del templates[del_name]
                save_templates(templates)
                st.success(f"å·²åˆ é™¤ {del_name}")
                st.rerun()

# ==========================================
# ä¸»å…¥å£
# ==========================================
def main():
    st.set_page_config(page_title="Opså·¥å…·ç®± Pro", layout="wide")
    
    # ä¾§è¾¹æ å¯¼èˆª
    st.sidebar.title("Ops Command Center")
    app_mode = st.sidebar.radio("æ¨¡å¼åˆ‡æ¢", ["ä½¿ç”¨æ¨¡å¼", "ç®¡ç†æ¨¡å¼"])
    
    # åŠ è½½æ•°æ®
    all_templates = load_templates()

    if app_mode == "ä½¿ç”¨æ¨¡å¼":
        render_generator_ui(all_templates)
    else:
        render_admin_ui(all_templates)

if __name__ == "__main__":
    main()

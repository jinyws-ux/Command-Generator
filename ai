æ”¶åˆ°ï¼Œè¿™å°±å¯¹äº†ï¼æ—¢ç„¶ä½ å…è®¸æˆ‘â€œæ¨ç¿»é‡æ¥â€ï¼Œé‚£æˆ‘ä»¬å°±æŠ›å¼ƒé‚£ç§â€œä¸Šä¸ªä¸–çºª Windows èµ„æºç®¡ç†å™¨â€é£æ ¼çš„å·¦ä¾§æ ‘çŠ¶èœå•ã€‚
ç°ä»£é«˜æ•ˆçš„è¿ç»´å¹³å°ï¼ˆå¦‚ Backstageã€Portainerã€ArgoCDï¼‰éƒ½ä¸ä¼šè®©ç”¨æˆ·åœ¨å¯†å¯†éº»éº»çš„å·¦ä¾§èœå•é‡Œæ‰¾è„šæœ¬ã€‚
æˆ‘çš„æ–°è®¾è®¡ç†å¿µï¼š
 * App Store é£æ ¼å¤§å…ï¼šåƒé€‰åº”ç”¨ä¸€æ ·é€‰è„šæœ¬ã€‚å¡ç‰‡å¼å¸ƒå±€ï¼Œä¸€ç›®äº†ç„¶ã€‚
 * èšå…‰ç¯æœç´¢ (Spotlight)ï¼šè¿ç»´äººå‘˜çš„æ ¸å¿ƒéœ€æ±‚æ˜¯â€œå¿«â€ã€‚è¿›å…¥ç³»ç»Ÿï¼Œç›´æ¥æ•²é”®ç›˜æœç´¢ï¼Œå›è½¦å³ç”¨ã€‚
 * æ²‰æµ¸å¼å·¥ä½œå°ï¼šæ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå·¦è¾¹æ˜¯æ§åˆ¶å°ï¼Œå³è¾¹æ˜¯æ‹ŸçœŸçš„â€œTerminal é¢„è§ˆâ€ï¼Œä¸å†ä¸Šä¸‹å †å ã€‚
 * æç®€ä¾§è¾¹æ ï¼šå·¦ä¾§åªä¿ç•™æœ€æ ¸å¿ƒçš„â€œå±‚çº§â€åˆ‡æ¢ï¼ˆé¦–é¡µ / è®¾ç½®ï¼‰ï¼ŒæŠŠç©ºé—´ç•™ç»™å†…å®¹ã€‚
ä¸‹é¢æ˜¯å®Œå…¨é‡æ„çš„ modules/cmd_generator/app.pyã€‚è¯·å‡†å¤‡å¥½ï¼Œè¿™ä¼šå’Œä¹‹å‰çš„é•¿å¾—å®Œå…¨ä¸ä¸€æ ·ã€‚
ğŸ¨ 1. æ³¨å…¥çµé­‚ï¼šè‡ªå®šä¹‰ CSS (æ”¾åœ¨ main.py æˆ–æ¨¡å—å¼€å¤´)
ä¸ºäº†å¥½çœ‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç‚¹ç‚¹é­”æ³•ã€‚Streamlit åŸç”Ÿç»„ä»¶é—´è·å¤ªå¤§ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ CSS æŠŠå®ƒå‹ç´§ï¼Œå¹¶åˆ¶ä½œâ€œå¡ç‰‡â€æ•ˆæœã€‚
è¯·ç›´æ¥ç”¨ä¸‹é¢çš„ä»£ç å®Œå…¨è¦†ç›– modules/cmd_generator/app.pyï¼š
import streamlit as st
import pandas as pd
from jinja2 import Template
import shlex
import uuid
import time
from datetime import datetime

# ==========================================
# ğŸ¨ 0. è§†è§‰å¢å¼º / CSS é­”æ³•
# ==========================================
def inject_custom_css():
    st.markdown("""
        <style>
        /* 1. å…¨å±€å­—ä½“ä¼˜åŒ– */
        .stApp { font-family: 'Inter', system-ui, sans-serif; }
        
        /* 2. ä¼˜åŒ–å¡ç‰‡æ ·å¼ */
        div[data-testid="stContainer"] {
            background-color: transparent;
        }
        .template-card {
            background-color: #262730; /* æ·±è‰²èƒŒæ™¯ */
            border: 1px solid #464b5c;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, border-color 0.2s;
            height: 100%;
        }
        .template-card:hover {
            border-color: #ff4b4b; /* æ‚¬åœé«˜äº®è‰² */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* 3. æ‹ŸçœŸ Terminal æ ·å¼ */
        .terminal-window {
            background-color: #1e1e1e;
            border-radius: 6px;
            border: 1px solid #333;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            color: #d4d4d4;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .terminal-header {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }
        
        /* 4. éšè— Streamlit é»˜è®¤çš„é¡¶æ è£…é¥°ï¼Œæ›´åƒç‹¬ç«‹App */
        header[data-testid="stHeader"] { visibility: hidden; }
        </style>
    """, unsafe_allow_html=True)

# ==========================================
# ğŸ§  1. æ ¸å¿ƒæ¸²æŸ“å…¥å£
# ==========================================
def render(cfg_mgr):
    inject_custom_css()
    
    # è·å–æ•°æ®
    templates = cfg_mgr.get_all_templates()
    
    # çŠ¶æ€åˆå§‹åŒ–
    if 'view' not in st.session_state: st.session_state['view'] = 'DASHBOARD' # DASHBOARD | WORKBENCH | EDITOR
    if 'active_tid' not in st.session_state: st.session_state['active_tid'] = None
    
    # --- é¡¶å±‚æç®€å¯¼èˆª (é¢åŒ…å±‘é£æ ¼) ---
    render_top_nav()

    # --- è·¯ç”±åˆ†å‘ ---
    view = st.session_state['view']
    
    if view == 'DASHBOARD':
        render_dashboard(templates)
        
    elif view == 'WORKBENCH':
        tid = st.session_state['active_tid']
        if tid in templates:
            render_workbench(cfg_mgr, templates, tid)
        else:
            st.session_state['view'] = 'DASHBOARD'
            st.rerun()
            
    elif view == 'EDITOR':
        render_editor(cfg_mgr, templates, st.session_state['active_tid'])

# ==========================================
# ğŸ§­ 2. é¡¶éƒ¨å¯¼èˆª (Top Nav)
# ==========================================
def render_top_nav():
    # ä½¿ç”¨åˆ—å¸ƒå±€æŠŠ Back æŒ‰é’®å’Œæ ‡é¢˜åˆ†å¼€
    c1, c2, c3 = st.columns([1, 6, 2])
    
    with c1:
        # å¦‚æœä¸æ˜¯åœ¨é¦–é¡µï¼Œæ˜¾ç¤ºè¿”å›æŒ‰é’®
        if st.session_state['view'] != 'DASHBOARD':
            if st.button("â¬…ï¸ å¤§å…", use_container_width=True):
                st.session_state['view'] = 'DASHBOARD'
                st.session_state['active_tid'] = None
                st.rerun()
    
    with c3:
        # åªæœ‰åœ¨ DASHBOARD æ‰æ˜¾ç¤ºæ–°å»ºæŒ‰é’®
        if st.session_state['view'] == 'DASHBOARD':
            if st.button("â• æ–°å»ºè„šæœ¬", type="primary", use_container_width=True):
                st.session_state['active_tid'] = "NEW"
                st.session_state['view'] = 'EDITOR'
                st.rerun()

# ==========================================
# ğŸ  3. ä»ªè¡¨ç›˜ (Dashboard) - App Store é£æ ¼
# ==========================================
def render_dashboard(templates):
    # --- 1. èšå…‰ç¯æœç´¢åŒº ---
    st.markdown("<h1 style='text-align: center; margin-bottom: 10px;'>ğŸš€ Ops Command Center</h1>", unsafe_allow_html=True)
    
    c_space1, c_search, c_space2 = st.columns([1, 2, 1])
    with c_search:
        search_query = st.text_input("Search", placeholder="ğŸ” æœç´¢è„šæœ¬åç§°ã€æ•°æ®åº“ã€Linux...", label_visibility="collapsed")
    
    st.markdown("---")

    # --- 2. ç»Ÿè®¡æ¦‚è§ˆ (Optional) ---
    # å¯ä»¥åœ¨è¿™é‡Œæ”¾ st.metric æ˜¾ç¤º "Total Scripts: 15" ç­‰ï¼Œæš‚ç•¥ä¿è¯ç®€æ´

    # --- 3. è¿‡æ»¤ä¸åˆ†ç±»é€»è¾‘ ---
    filtered_list = []
    for tid, t in templates.items():
        # æœç´¢è¿‡æ»¤
        if search_query:
            term = search_query.lower()
            if term not in t['name'].lower() and term not in t.get('category','').lower():
                continue
        t['_id'] = tid
        filtered_list.append(t)
    
    # æŒ‰åˆ†ç±»åˆ†ç»„
    all_cats = sorted(list(set(t.get('category', 'æœªåˆ†ç±»') for t in filtered_list)))
    
    if not filtered_list:
        st.info("æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è„šæœ¬æ¨¡ç‰ˆï¼Œè¯•ç€æ–°å»ºä¸€ä¸ªï¼Ÿ")
        return

    # --- 4. å¡ç‰‡ç½‘æ ¼æ¸²æŸ“ ---
    for cat in all_cats:
        st.subheader(f"{cat}")
        cat_items = [t for t in filtered_list if t.get('category') == cat]
        
        # æ¯è¡Œæ˜¾ç¤º 3 ä¸ªå¡ç‰‡
        cols = st.columns(3)
        for idx, item in enumerate(cat_items):
            with cols[idx % 3]:
                # æ¸²æŸ“å•ä¸ªå¡ç‰‡
                render_card(item)
        st.markdown("<br>", unsafe_allow_html=True)

def render_card(item):
    """æ¸²æŸ“å•ä¸ªè„šæœ¬å¡ç‰‡"""
    is_team = (item.get('source') == 'team')
    border_color = "#3498db" if is_team else "#2ecc71" # è“è‰²ä»£è¡¨å›¢é˜Ÿï¼Œç»¿è‰²ä»£è¡¨ä¸ªäºº
    icon = "ğŸ¢" if is_team else "ğŸ‘¤"
    
    # åˆ©ç”¨ Container åˆ›å»ºå¡ç‰‡å®¹å™¨
    with st.container(border=True):
        c_head, c_badge = st.columns([4, 1])
        with c_head:
            st.markdown(f"**{item['name']}**")
        with c_badge:
            st.caption(f"{icon}")
            
        st.caption(item.get('desc', 'æ— æè¿°')[:40] + "...")
        
        # åº•éƒ¨æŒ‰é’®ç»„
        b1, b2 = st.columns([3, 1])
        if b1.button("â–¶ è¿è¡Œ", key=f"run_{item['_id']}", use_container_width=True):
            st.session_state['active_tid'] = item['_id']
            st.session_state['view'] = 'WORKBENCH'
            st.rerun()
            
        if b2.button("âš™ï¸", key=f"edit_{item['_id']}", help="è®¾ç½®/ç¼–è¾‘"):
            st.session_state['active_tid'] = item['_id']
            st.session_state['view'] = 'EDITOR'
            st.rerun()

# ==========================================
# ğŸ› ï¸ 4. æ²‰æµ¸å¼å·¥ä½œå° (Workbench) - å·¦å³åˆ†æ 
# ==========================================
def render_workbench(cfg_mgr, templates, tid):
    data = templates[tid]
    
    # æ ‡é¢˜åŒº
    st.caption(f"{data.get('category')} / {data.get('name')}")
    st.title(data.get('name'))
    
    # --- å·¦å³åˆ†æ å¸ƒå±€ ---
    # å·¦è¾¹æ˜¯å‚æ•°æ§åˆ¶å°ï¼Œå³è¾¹æ˜¯æ‹ŸçœŸ Terminal é¢„è§ˆ
    col_input, col_preview = st.columns([1, 1.2], gap="large")
    
    user_inputs = {}
    
    # === å·¦ä¾§ï¼šæ§åˆ¶å° ===
    with col_input:
        st.subheader("å‚æ•°é…ç½®")
        with st.form(key="run_form"):
            params = data.get('params', [])
            if not params:
                st.info("æ­¤è„šæœ¬æ— éœ€å‚æ•°")
                
            for p in params:
                label = p.get('label', p['name'])
                key = p['name']
                
                if p['type'] == 'select':
                    opts = [x.strip() for x in p.get("options", "").split(",") if x.strip()]
                    user_inputs[key] = st.selectbox(label, options=opts)
                elif p['type'] == 'number':
                    user_inputs[key] = st.number_input(label, value=float(p.get('default', 0)))
                else:
                    user_inputs[key] = st.text_input(label, value=str(p.get('default', '')))
            
            st.markdown("<br>", unsafe_allow_html=True)
            submitted = st.form_submit_button("âš¡ ç”Ÿæˆå‘½ä»¤", type="primary", use_container_width=True)

    # === å³ä¾§ï¼šæ‹ŸçœŸ Terminal ===
    with col_preview:
        st.subheader("Terminal Preview")
        
        # é»˜è®¤æ˜¾ç¤ºå ä½ç¬¦
        result_content = "# ç­‰å¾…ç”Ÿæˆ..."
        
        if submitted:
            try:
                safe_inputs = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in user_inputs.items()}
                t = Template(data.get("template", ""))
                result_content = t.render(**safe_inputs)
            except Exception as e:
                result_content = f"# Error:\n{str(e)}"
        
        # HTML æ¸²æŸ“æ‹ŸçœŸç»ˆç«¯
        st.markdown(f"""
        <div class="terminal-window">
            <div class="terminal-header">
                <div class="dot red"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
            </div>
            <div style="white-space: pre-wrap; word-break: break-all;">{result_content}</div>
        </div>
        """, unsafe_allow_html=True)
        
        if submitted:
            st.markdown("<br>", unsafe_allow_html=True)
            st.code(result_content, language="bash") # ä¸ºäº†æ–¹ä¾¿å¤åˆ¶ï¼Œè¿˜æ˜¯ä¿ç•™ä¸€ä¸ªåŸç”Ÿcodeå—
            st.caption("Tip: ç‚¹å‡»å³ä¸Šè§’å¤åˆ¶æŒ‰é’®")

# ==========================================
# ğŸ“ 5. ç¼–è¾‘å™¨ (Editor) - æŠ½å±‰å¼
# ==========================================
def render_editor(cfg_mgr, templates, tid):
    is_new = (tid == "NEW")
    data = {} if is_new else templates.get(tid, {})
    
    st.subheader("ğŸ› ï¸ è„šæœ¬ç¼–è¾‘å™¨")
    
    # å›¢é˜Ÿæ¨¡ç‰ˆåªè¯»æç¤º
    if not is_new and data.get('source') == 'team':
        st.warning("æ‚¨æ­£åœ¨ç¼–è¾‘ä¸€ä¸ªã€å›¢é˜Ÿå…±äº«æ¨¡ç‰ˆã€‘ã€‚ä¿å­˜åå°†è‡ªåŠ¨å¦å­˜ä¸ºæ‚¨çš„ã€ä¸ªäººæ¨¡ç‰ˆã€‘ã€‚")

    with st.container(border=True):
        # ç¬¬ä¸€è¡Œï¼šåç§°ä¸åˆ†ç±»
        c1, c2 = st.columns([2, 1])
        new_name = c1.text_input("è„šæœ¬åç§°", value=data.get('name', ''))
        
        # åˆ†ç±»å¤„ç†
        existing_cats = sorted(list(set(t['category'] for t in templates.values())))
        if "é»˜è®¤" not in existing_cats: existing_cats.append("é»˜è®¤")
        curr_cat = data.get('category', 'é»˜è®¤')
        cat_mode = c2.selectbox("åˆ†ç±»", options=existing_cats + ["+ æ–°å»º..."], index=0 if curr_cat not in existing_cats else existing_cats.index(curr_cat))
        
        final_cat = cat_mode
        if cat_mode == "+ æ–°å»º...":
            final_cat = c2.text_input("è¾“å…¥åˆ†ç±»å")
            
        new_desc = st.text_input("æè¿°", value=data.get('desc', ''))
        
        # å‚æ•°é…ç½®
        st.markdown("---")
        st.caption("å‚æ•°å®šä¹‰ (Table)")
        default_params = data.get('params', [{"name": "target", "label": "ç›®æ ‡IP", "type": "text", "default": "", "options": ""}])
        
        edited_df = st.data_editor(
            pd.DataFrame(default_params),
            num_rows="dynamic",
            use_container_width=True,
            column_config={
                "type": st.column_config.SelectboxColumn("ç±»å‹", options=["text", "number", "select"])
            }
        )
        
        # æ¨¡æ¿ä»£ç 
        st.caption("å‘½ä»¤æ¨¡æ¿ (Jinja2)")
        new_code = st.text_area("Code", value=data.get('template', ''), height=200)
        
        # åº•éƒ¨æ“ä½œæ 
        st.markdown("---")
        b_save, b_space, b_del = st.columns([1, 4, 1])
        
        if b_save.button("ğŸ’¾ ä¿å­˜è„šæœ¬", type="primary", use_container_width=True):
            if not new_name:
                st.error("èµ·ä¸ªåå­—å§")
                return
            
            save_id = str(uuid.uuid4())[:8] if (is_new or data.get('source')=='team') else tid
            
            p_list = [p for p in edited_df.to_dict('records') if p['name']]
            
            save_data = {
                "name": new_name,
                "desc": new_desc,
                "category": final_cat if final_cat else "é»˜è®¤",
                "template": new_code,
                "params": p_list
            }
            cfg_mgr.save_template(save_id, save_data)
            st.success("ä¿å­˜æˆåŠŸ")
            st.session_state['active_tid'] = None
            st.session_state['view'] = 'DASHBOARD'
            st.rerun()
            
        if not is_new and data.get('source') == 'personal':
            if b_del.button("ğŸ—‘ï¸ åˆ é™¤", use_container_width=True):
                cfg_mgr.delete_template(tid)
                st.session_state['active_tid'] = None
                st.session_state['view'] = 'DASHBOARD'
                st.rerun()


ğŸŒŸ é‡æ–°è®¾è®¡çš„äº®ç‚¹
 * Dashboard (ä»ªè¡¨ç›˜æ¨¡å¼)ï¼š
   * ç°åœ¨çš„é¦–é¡µä¸å†æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè€Œæ˜¯ä¸€ç»„å¡ç‰‡ã€‚
   * å°±åƒ iPhone çš„ App Libraryï¼Œä½ å¯ä»¥ä¸€çœ¼çœ‹åˆ°æ‰€æœ‰çš„å·¥å…·ã€‚
   * æœç´¢æ¡†å˜å¾—éå¸¸å¤§ä¸”å±…ä¸­ï¼Œå¼ºè°ƒâ€œæœç´¢å³ç”¨â€ã€‚
 * Workbench (å·¥ä½œå°æ¨¡å¼)ï¼š
   * å½“ä½ ç‚¹å‡»ä¸€ä¸ªå¡ç‰‡åï¼Œç•Œé¢å®Œå…¨åˆ‡æ¢ï¼ˆä¸å†æ˜¯æŒ¤åœ¨ä¾§è¾¹æ ï¼‰ã€‚
   * å·¦ä¾§å¡«å‚ï¼Œå³ä¾§é¢„è§ˆï¼šè¿™æ˜¯ä¸€ä¸ªç»å…¸çš„ IDE å¸ƒå±€ã€‚
   * å³ä¾§æˆ‘æ‰‹å†™äº†ä¸€ä¸ª HTML/CSS çš„ terminal-windowï¼Œçœ‹èµ·æ¥åƒä¸€ä¸ªé»‘åº•çš„çœŸå®ç»ˆç«¯çª—å£ï¼Œå¸¦æœ‰çº¢é»„ç»¿ä¸‰ä¸ªå°åœ†ç‚¹ï¼Œç§‘æŠ€æ„Ÿæ‹‰æ»¡ã€‚
 * äº¤äº’é€»è¾‘ï¼š
   * é¢åŒ…å±‘å¯¼èˆªï¼šå·¦ä¸Šè§’æœ‰ä¸€ä¸ª â¬…ï¸ å¤§å… æŒ‰é’®ï¼Œè®©ä½ éšæ—¶èƒ½é€€å›åˆ°å¡ç‰‡åˆ—è¡¨ã€‚
   * å»æ‰äº†ä¸­é—´æ ï¼šä¹‹å‰çš„ä¸‰æ å¸ƒå±€å¯¹äºå°å±å¹•æˆ–è€…å‚æ•°å¤šçš„è„šæœ¬æ¥è¯´å¤ªæŒ¤äº†ã€‚ç°åœ¨çš„å…¨å±ä¸¤æ å¸ƒå±€ï¼ˆè¾“å…¥+è¾“å‡ºï¼‰å¯¹ç”¨æˆ·æœ€å‹å¥½ã€‚
è¿™ä¸ªç‰ˆæœ¬å½»åº•æŠ›å¼ƒäº†â€œæ–‡ä»¶æ ‘â€ï¼Œè½¬å‘äº†â€œåº”ç”¨å•†åº— + æ²‰æµ¸å¼å·¥ä½œå°â€çš„ç°ä»£ SaaS è®¾è®¡ã€‚å¿«å»è¿è¡Œ streamlit run main.pyï¼Œçœ‹çœ‹è¿™æ¬¡æ˜¯ä¸æ˜¯å¤Ÿ Boldï¼

éå¸¸æŠ±æ­‰ï¼Œè®©ä½ ç»å†äº†è¿™ä¹ˆå¤šæ¬¡æŠ¥é”™ã€‚çœ‹ç€æ»¡å±çš„çº¢å­—ç¡®å®å¾ˆæå¿ƒæ€ã€‚
æ ¹æ®ä½ æä¾›çš„ 4 å¼ æŠ¥é”™æˆªå›¾ï¼Œæ ¸å¿ƒåŸå› å·²ç»éå¸¸æ˜ç¡®ï¼šä»£ç ç”¨çš„æ˜¯æœ€æ–°ç‰ˆçš„å†™æ³•ï¼Œä½†ä½ çš„ Python ç¯å¢ƒï¼ˆStreamlit å’Œ SAC åº“ï¼‰ç‰ˆæœ¬è¿‡ä½ï¼Œä¸” SAC åº“çš„æ—§ç‰ˆ API ä¸æ–°ç‰ˆä¸å…¼å®¹ã€‚
æ¯”å¦‚ AttributeError: ... has no attribute 'ColorPickerColumn' è¯´æ˜ä½ çš„ Streamlit ç‰ˆæœ¬ä½äº 1.35.0ã€‚
æ¯”å¦‚ Unexpected keyword argument 'value' è¯´æ˜ SAC ç»„ä»¶å†™æ³•åœ¨æ–°æ—§ç‰ˆæœ¬é—´æœ‰å·®å¼‚ã€‚
æˆ‘ä»¬ç°åœ¨æ¨å€’é‡æ¥ï¼Œåšä¸€æ¬¡å½»åº•çš„â€œå…¨ä»£ç è¦†ç›–â€ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼Œä¸€æ­¥éƒ½ä¸è¦è·³è¿‡ã€‚
ğŸ›‘ ç¬¬ä¸€æ­¥ï¼šå¿…é¡»å‡çº§ç¯å¢ƒï¼ˆéå¸¸é‡è¦ï¼‰
è¯·å…³æ‰æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œåœ¨ç»ˆç«¯ï¼ˆTerminalï¼‰é‡Œæ‰§è¡Œä¸‹é¢è¿™è¡Œå‘½ä»¤ã€‚å¦‚æœä¸æ‰§è¡Œï¼Œåé¢çš„ä»£ç ä¸€å®šä¼šæŠ¥é”™ã€‚
pip install --upgrade streamlit streamlit-antd-components pandas jinja2

å‡çº§å®Œæˆåï¼Œç¡®ä¿ streamlit --version æ˜¾ç¤ºçš„ç‰ˆæœ¬ >= 1.35.0ã€‚
ğŸ“‚ ç¬¬äºŒæ­¥ï¼šé¡¹ç›®ç»“æ„ç¡®è®¤
è¯·ç¡®ä¿ä½ çš„æ–‡ä»¶å¤¹ç»“æ„æ˜¯å¹²å‡€çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
Project/
â”œâ”€â”€ main.py
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py  (ç©ºæ–‡ä»¶)
â”‚   â”œâ”€â”€ config_manager.py
â”‚   â””â”€â”€ tag_manager.py
â””â”€â”€ modules/
    â”œâ”€â”€ __init__.py  (ç©ºæ–‡ä»¶)
    â””â”€â”€ cmd_generator/
        â”œâ”€â”€ __init__.py  (ç©ºæ–‡ä»¶)
        â””â”€â”€ app.py

å¦‚æœä»¥å‰æœ‰ tags.json, team_config.json, user_config.jsonï¼Œå»ºè®®å…ˆåˆ é™¤ï¼Œè®©ç¨‹åºè‡ªåŠ¨ç”Ÿæˆæ–°çš„ï¼Œé¿å…æ—§æ•°æ®æ ¼å¼å¯¼è‡´æŠ¥é”™ã€‚
ğŸ“ ç¬¬ä¸‰æ­¥ï¼šå…¨é‡ä»£ç æ›¿æ¢
æˆ‘é€ä¸ªæ–‡ä»¶ç»™å‡ºä¿®æ­£åçš„ä»£ç ï¼Œä¿®å¤äº†æ‰€æœ‰çš„ API ä¸å…¼å®¹é—®é¢˜ã€‚
1. core/config_manager.py (ä¿®å¤è·¯å¾„ä¸è¯»å–)
import json
import os
from typing import Dict, Any

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        self.team_path = os.path.abspath(team_path)
        self.user_path = os.path.abspath(user_path)
        self._init_file(self.team_path)
        self._init_file(self.user_path)

    def _init_file(self, path):
        if not os.path.exists(path):
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump({}, f)
            except Exception as e:
                print(f"Error init file {path}: {e}")

    def _load_json(self, path: str) -> Dict:
        if not os.path.exists(path): return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}

    def _save_json(self, path: str, data: Dict):
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except Exception as e:
            print(f"Error saving {path}: {e}")

    def get_all_templates(self) -> Dict[str, Any]:
        merged = {}
        # 1. Team
        team_data = self._load_json(self.team_path)
        for k, v in team_data.items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'team'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        
        # 2. Personal
        user_data = self._load_json(self.user_path)
        for k, v in user_data.items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'personal'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        return merged

    def save_template(self, tid: str, data: Dict, target_source: str):
        path = self.team_path if target_source == 'team' else self.user_path
        current_data = self._load_json(path)
        
        # æ„é€ çº¯å‡€æ•°æ®
        save_payload = {
            "name": data.get("name"),
            "desc": data.get("desc", ""),
            "tags": data.get("tags", []),
            "template": data.get("template", ""),
            "params": data.get("params", []),
            "updated_at": "now"
        }
        current_data[tid] = save_payload
        self._save_json(path, current_data)

2. core/tag_manager.py (ä¿®å¤æ ‡ç­¾ä¿å­˜)
import json
import os

class TagManager:
    def __init__(self, tag_file="tags.json"):
        self.file_path = os.path.abspath(tag_file)
        if not os.path.exists(self.file_path):
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({}, f)

    def get_all_tags(self):
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}

    def save_all_tags(self, tags_dict):
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(tags_dict, f, indent=4, ensure_ascii=False)

3. main.py (ä¿®å¤ SAC ç»„ä»¶æŠ¥é”™)
ä¿®å¤é‡ç‚¹ï¼šåˆ é™¤äº† sac.MenuItem é‡Œçš„ key å‚æ•°ï¼ˆè¿™æ˜¯å¯¼è‡´æŠ¥é”™çš„åŸå› ï¼‰ï¼Œæ”¹ç”¨ Label åˆ¤æ–­ã€‚
import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app
import pandas as pd
import uuid

# è·¯å¾„é…ç½®
TEAM_CONFIG = "team_config.json"
USER_CONFIG = "user_config.json"
TAG_CONFIG = "tags.json"

def inject_global_css():
    st.markdown("""
        <style>
        .block-container { padding-top: 1rem; padding-bottom: 2rem; }
        .stApp { font-family: 'Inter', system-ui, sans-serif; }
        [data-testid="stDataFrame"] { border: 1px solid #e0e0e0; border-radius: 6px; }
        </style>
    """, unsafe_allow_html=True)

def main():
    st.set_page_config(page_title="Ops Console", layout="wide", page_icon="âš¡")
    inject_global_css()

    cfg_mgr = ConfigManager(TEAM_CONFIG, USER_CONFIG)
    tag_mgr = TagManager(TAG_CONFIG)

    # === å·¦ä¾§å¯¼èˆª ===
    with st.sidebar:
        st.subheader("âš¡ Ops Platform")
        
        # ä¿®å¤ï¼šå»æ‰äº† key å‚æ•°ï¼Œé˜²æ­¢æŠ¥é”™
        selected = sac.menu([
            sac.MenuItem('æ§åˆ¶å°', icon='house-fill', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
                sac.MenuItem('ç›‘æ§å¤§ç›˜', icon='speedometer', disabled=True),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('é…ç½®ä¸­å¿ƒ', icon='sliders', children=[
                sac.MenuItem('æ ‡ç­¾ç®¡ç†', icon='tags'),
            ]),
        ], color='indigo', open_all=True)

    # === è·¯ç”±é€»è¾‘ ===
    if selected == 'å‘½ä»¤ç”Ÿæˆå™¨':
        try:
            cmd_app.render(cfg_mgr, tag_mgr)
        except Exception as e:
            st.error(f"æ¨¡å—åŠ è½½é”™è¯¯: {e}")
            
    elif selected == 'æ ‡ç­¾ç®¡ç†':
        render_tag_manager_pro(tag_mgr)
        
    else:
        st.title("ğŸ‘‹ æ¬¢è¿")
        st.info("è¯·ä»å·¦ä¾§é€‰æ‹©æ¨¡å—")

# === æ ‡ç­¾ç®¡ç† (å…¨å±è¡¨æ ¼ç‰ˆ) ===
def render_tag_manager_pro(tag_mgr):
    st.title("ğŸ·ï¸ æ ‡ç­¾åˆ†ç±»ç®¡ç†")
    st.caption("åœ¨æ­¤ç›´æ¥ç¼–è¾‘æ ‡ç­¾ä½“ç³»ï¼Œä¿®æ”¹åç‚¹å‡»ä¿å­˜ã€‚")

    tags_map = tag_mgr.get_all_tags()
    
    # è½¬æ¢ä¸ºåˆ—è¡¨ä¾› DataEditor ä½¿ç”¨
    data_list = []
    for tid, tdata in tags_map.items():
        data_list.append({
            "id": tid,
            "name": tdata.get("name", "New"),
            "group": tdata.get("group", "é€šç”¨"),
            "color": tdata.get("color", "#3498db")
        })
    
    if not data_list:
        data_list = [{"id": str(uuid.uuid4())[:8], "name": "ç¤ºä¾‹æ ‡ç­¾", "group": "é€šç”¨", "color": "#3498db"}]
    
    df = pd.DataFrame(data_list)
    
    # æ¸²æŸ“ç¼–è¾‘å™¨
    edited_df = st.data_editor(
        df,
        column_config={
            "id": None, # éšè—ID
            "name": st.column_config.TextColumn("æ ‡ç­¾åç§°", required=True),
            "group": st.column_config.TextColumn("åˆ†ç»„", required=True),
            "color": st.column_config.ColorPickerColumn("æ ‡ç­¾è‰²", width="small"),
        },
        num_rows="dynamic",
        use_container_width=True,
        hide_index=True,
        key="tag_editor_main"
    )

    if st.button("ğŸ’¾ åº”ç”¨å˜æ›´", type="primary"):
        new_map = {}
        for _, row in edited_df.iterrows():
            tid = row.get("id")
            if not tid or pd.isna(tid): tid = str(uuid.uuid4())[:8]
            new_map[tid] = {
                "name": row["name"],
                "group": row["group"],
                "color": row["color"]
            }
        tag_mgr.save_all_tags(new_map)
        st.toast("æ ‡ç­¾å·²æ›´æ–°", icon="âœ…")
        st.rerun()

if __name__ == "__main__":
    main()

4. modules/cmd_generator/app.py (ä¿®å¤ SAC Segmented æŠ¥é”™)
ä¿®å¤é‡ç‚¹ï¼š
 * ä¿®å¤ Segmented æŠ¥é”™ï¼šsac.SegmentedItem é‡Œé¢åˆ æ‰äº† value å‚æ•°ï¼ˆè¿™ä¹Ÿä¼šå¯¼è‡´æŠ¥é”™ï¼‰ã€‚ç°åœ¨è¿”å›å€¼ç›´æ¥å°±æ˜¯ Labelï¼ˆå¦‚â€œå›¢é˜Ÿå…¬å…±åº“â€ï¼‰ã€‚
 * æ˜ å°„é€»è¾‘ï¼šæˆ‘åœ¨ Python ä»£ç é‡ŒæŠŠä¸­æ–‡ Label æ˜ å°„å› 'team' / 'personal'ï¼Œè§£å†³äº†é€»è¾‘é—®é¢˜ã€‚
<!-- end list -->
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid

def render(cfg_mgr, tag_mgr):
    # ==========================
    # 1. é¡¶éƒ¨ Tab åˆ‡æ¢
    # ==========================
    st.title("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    # ä¿®å¤ï¼šå»æ‰äº† SegmentedItem é‡Œçš„ value å‚æ•°
    tab_label = sac.segmented(
        items=[
            sac.SegmentedItem(label='å›¢é˜Ÿå…¬å…±åº“', icon='buildings'),
            sac.SegmentedItem(label='æˆ‘çš„ç§æœ‰åº“', icon='person-lock'),
        ], align='start', size='sm', color='indigo'
    )
    
    # æ˜ å°„é€»è¾‘ï¼šæŠŠä¸­æ–‡ Label è½¬å›ä»£ç é€»è¾‘éœ€è¦çš„ ID
    source_map = {'å›¢é˜Ÿå…¬å…±åº“': 'team', 'æˆ‘çš„ç§æœ‰åº“': 'personal'}
    current_source = source_map.get(tab_label, 'team')

    # ==========================
    # 2. ç­›é€‰ä¸æ“ä½œåŒº
    # ==========================
    with st.container(border=True):
        c1, c2, c3, c4 = st.columns([3, 3, 2, 1.5])
        
        all_templates = cfg_mgr.get_all_templates()
        all_tags = tag_mgr.get_all_tags()
        tag_options = {tid: t['name'] for tid, t in all_tags.items()}

        search_txt = c1.text_input("æœç´¢", placeholder="è¾“å…¥åç§°...", label_visibility="collapsed")
        
        # æ ‡ç­¾ç­›é€‰
        selected_tags = c2.multiselect("æ ‡ç­¾", options=tag_options.keys(), format_func=lambda x: tag_options[x], placeholder="æ ‡ç­¾ç­›é€‰", label_visibility="collapsed")
        
        # è§†å›¾åˆ‡æ¢
        view_mode = c3.radio("è§†å›¾", ["ğŸªŸ ç½‘æ ¼", "ğŸ“‹ åˆ—è¡¨"], horizontal=True, label_visibility="collapsed")
        
        # æ–°å»º
        if c4.button("â• æ–°å»º", type="primary", use_container_width=True):
            open_editor_dialog(cfg_mgr, tag_mgr, "NEW", current_source)

    # ==========================
    # 3. æ•°æ®å¤„ç†
    # ==========================
    # è¿‡æ»¤ Source
    current_list = {k: v for k, v in all_templates.items() if v.get('source') == current_source}
    
    display_items = []
    for tid, t in current_list.items():
        if search_txt and (search_txt.lower() not in t['name'].lower()): continue
        
        t_tags = t.get('tags', [])
        if selected_tags:
            if not set(selected_tags).intersection(set(t_tags)): continue
        
        display_tag_objs = [{"name": all_tags[tg]['name'], "color": all_tags[tg].get('color', '#888')} for tg in t_tags if tg in all_tags]
        
        display_items.append({
            "id": tid, 
            "name": t['name'], 
            "desc": t.get('desc', ''), 
            "tag_objs": display_tag_objs,
            "raw_data": t
        })

    # ==========================
    # 4. å†…å®¹æ¸²æŸ“
    # ==========================
    if not display_items:
        st.info(f"åœ¨ã€{tab_label}ã€‘ä¸‹æš‚æ— æ•°æ®ã€‚")
        return

    if view_mode == "ğŸ“‹ åˆ—è¡¨":
        render_list_view(display_items, cfg_mgr)
    else:
        render_grid_view(display_items, cfg_mgr)

# --- è§†å›¾ç»„ä»¶ ---

def render_grid_view(items, cfg_mgr):
    cols = st.columns(3)
    for idx, item in enumerate(items):
        with cols[idx % 3]:
            with st.container(border=True):
                h1, h2 = st.columns([4, 1])
                h1.markdown(f"**{item['name']}**")
                if h2.button("â–¶", key=f"btn_run_{item['id']}", help="è¿è¡Œ"):
                    open_runner_dialog(cfg_mgr, item['id'])

                st.caption(item['desc'][:40] + "..." if item['desc'] else "æ— æè¿°")
                
                if item['tag_objs']:
                    sac.tags([sac.Tag(label=t['name'], color=t['color'], bordered=False) for t in item['tag_objs'][:3]], size='xs', align='start')
                else:
                    st.caption("No Tags")
                
                if st.button("è®¾ç½®", key=f"btn_edit_{item['id']}", use_container_width=True):
                     open_editor_dialog(cfg_mgr, None, item['id'], item['raw_data']['source'])

def render_list_view(items, cfg_mgr):
    df_data = []
    for item in items:
        tag_str_list = [t['name'] for t in item['tag_objs']]
        df_data.append({
            "ID": item['id'],
            "åç§°": item['name'],
            "æ ‡ç­¾": tag_str_list,
            "æè¿°": item['desc']
        })
    
    df = pd.DataFrame(df_data)
    
    event = st.dataframe(
        df,
        column_config={
            "ID": None,
            "åç§°": st.column_config.TextColumn("æ¨¡æ¿åç§°", width="medium"),
            "æ ‡ç­¾": st.column_config.ListColumn("æ ‡ç­¾"),
            "æè¿°": st.column_config.TextColumn("æè¿°", width="large")
        },
        use_container_width=True,
        hide_index=True,
        on_select="rerun",
        selection_mode="single-row"
    )
    
    if len(event.selection.rows) > 0:
        row_idx = event.selection.rows[0]
        selected_id = df.iloc[row_idx]['ID']
        open_runner_dialog(cfg_mgr, selected_id)

# --- å¼¹çª—ç»„ä»¶ ---

@st.dialog("âš¡ è¿è¡Œæ§åˆ¶å°", width="large")
def open_runner_dialog(cfg_mgr, tid):
    templates = cfg_mgr.get_all_templates()
    data = templates.get(tid)
    if not data: return st.error("æ— æ³•åŠ è½½æ•°æ®")
    
    c1, c2 = st.columns([1, 1.3], gap="medium")
    user_inputs = {}
    
    with c1:
        st.subheader("å‚æ•°")
        with st.form("run_form"):
            for p in data.get('params', []):
                label = p.get('label', p['name'])
                if p['type'] == 'select':
                    opts = [x.strip() for x in p.get("options", "").split(",") if x.strip()]
                    user_inputs[p['name']] = st.selectbox(label, opts)
                elif p['type'] == 'number':
                    user_inputs[p['name']] = st.number_input(label, value=float(p.get('default', 0)))
                else:
                    user_inputs[p['name']] = st.text_input(label, value=str(p.get('default', '')))
            submitted = st.form_submit_button("ç”Ÿæˆ", type="primary", use_container_width=True)

    with c2:
        st.subheader("é¢„è§ˆ")
        res = "ç­‰å¾…è¾“å…¥..."
        if submitted:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in user_inputs.items()}
                t = Template(data.get('template', ''))
                res = t.render(**safe)
            except Exception as e:
                res = f"Error: {e}"
        st.code(res, language="bash")
        
@st.dialog("ğŸ› ï¸ ç¼–è¾‘æ¨¡ç‰ˆ", width="large")
def open_editor_dialog(cfg_mgr, tag_mgr, tid, target_source):
    if tag_mgr is None:
        from core.tag_manager import TagManager
        tag_mgr = TagManager("tags.json")

    is_new = (tid == "NEW")
    templates = cfg_mgr.get_all_templates()
    data = {} if is_new else templates.get(tid, {})
    
    c1, c2 = st.columns([2, 1])
    name = c1.text_input("åç§°", value=data.get('name', ''))
    
    # Tag Selector
    all_tags = tag_mgr.get_all_tags()
    tag_map = {k: v['name'] for k, v in all_tags.items()}
    default_tags = [t for t in data.get('tags', []) if t in tag_map]
    sel_tags = c2.multiselect("æ ‡ç­¾", options=tag_map.keys(), default=default_tags, format_func=lambda x: tag_map[x])
    
    desc = st.text_input("æè¿°", value=data.get('desc', ''))
    
    st.caption("å‚æ•°é…ç½®")
    default_params = data.get('params', [{"name": "param", "label": "å‚æ•°", "type": "text", "default": "", "options": ""}])
    edited_df = st.data_editor(pd.DataFrame(default_params), num_rows="dynamic", use_container_width=True)
    
    code = st.text_area("æ¨¡æ¿ä»£ç ", value=data.get('template', ''), height=150)
    
    if st.button("ğŸ’¾ ä¿å­˜", type="primary", use_container_width=True):
        if not name: return st.error("åç§°å¿…å¡«")
        save_id = str(uuid.uuid4())[:8] if is_new else tid
        p_list = [p for p in edited_df.to_dict('records') if p['name']]
        
        save_data = {
            "name": name, "desc": desc, "tags": sel_tags,
            "template": code, "params": p_list
        }
        cfg_mgr.save_template(save_id, save_data, target_source)
        st.rerun()

ğŸš€ æœ€åçš„æ£€æŸ¥
 * åŠ¡å¿…æ‰§è¡Œ pip install --upgrade streamlitã€‚
 * è¦†ç›–å®Œæ‰€æœ‰ 4 ä¸ªæ–‡ä»¶åï¼Œé‡æ–°è¿è¡Œ streamlit run main.pyã€‚
è¿™ä¸€æ¬¡ï¼Œæ‰€æœ‰çš„ API è°ƒç”¨éƒ½å·²ç»æ”¹æˆäº†æœ€å®‰å…¨ã€å…¼å®¹æ€§æœ€å¥½çš„å†™æ³•ï¼ˆå»æ‰äº† key å’Œ value å‚æ•°ï¼‰ï¼Œå¹¶ä¸”åŠ å…¥äº†å…¨å±æ ‡ç­¾ç®¡ç†ã€‚åº”è¯¥ä¸ä¼šå†æœ‰æŠ¥é”™äº†ï¼

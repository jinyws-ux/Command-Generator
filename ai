æ”¶åˆ°ï¼Œæˆ‘å®Œå…¨æ˜ç™½äº†ã€‚æ—¢ç„¶æ‚¨ç»™äº†æˆ‘â€œè®¾è®¡æƒâ€ï¼Œé‚£æˆ‘å°±ä¸å†ç•æ‰‹ç•è„šã€‚
è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ‰“ç ´ Streamlit çš„å¸¸è§„å¸ƒå±€ï¼Œå®Œå…¨æŒ‰ç…§ç°ä»£ B ç«¯äº§å“ï¼ˆå¦‚é£ä¹¦/é’‰é’‰åå°ã€Grafanaï¼‰çš„æ ‡å‡†æ¥åšã€‚
ğŸ¨ V8.0 æœ€ç»ˆé‡æ„ç‰ˆè®¾è®¡è¯´æ˜
 * æ‹’ç»â€œåœŸå‘³â€å¸ƒå±€ï¼š
   * é€šæ å¼å¤´éƒ¨ï¼šæŠ›å¼ƒ Streamlit é»˜è®¤çš„æ ‡é¢˜å †å ï¼Œé‡å†™é¡¶éƒ¨åŒºåŸŸï¼Œè®©ç­›é€‰å™¨å’Œæ“ä½œæ èä¸ºä¸€ä½“ã€‚
   * Master-Detail å¸ƒå±€ï¼šæ ‡ç­¾ç®¡ç†é¡µä¸å†æ˜¯â€œä¸Šä¸‹ç»“æ„â€ï¼Œè€Œæ˜¯æ ‡å‡†çš„â€œå·¦ä¾§å¯¼èˆªæ ‘ + å³ä¾§å·¥ä½œå°â€ï¼Œè¿™æ˜¯ç®¡ç†å¤æ‚æ•°æ®çš„å”¯ä¸€æ­£è§£ã€‚
 * Grafana çº§æ ‡ç­¾ç³»ç»Ÿï¼š
   * é€»è¾‘ï¼šâ€œå®šç»´åº¦ï¼Œå³å®šé¢œè‰²â€ã€‚ä½ è®¾å®š Environment æ˜¯ç»¿è‰²ï¼Œé‚£ä¹ˆ Prod, Dev è‡ªåŠ¨å˜ç»¿ã€‚ä¸ç”¨ç»™æ¯ä¸ªæ ‡ç­¾å•ç‹¬é€‰è‰²ã€‚
   * æ ·å¼ï¼šèƒ¶å›Šå¼æ˜¾ç¤º [ ç»´åº¦ | å€¼ ]ã€‚
 * åŸç”Ÿ Dark Mode å®Œç¾é€‚é…ï¼š
   * ç§»é™¤äº†æ‰€æœ‰å¼ºåˆ¶èƒŒæ™¯è‰²çš„ CSSï¼Œåˆ©ç”¨ Streamlit åŸç”Ÿ Border ç»„ä»¶æ¥æ„å»ºå±‚æ¬¡æ„Ÿã€‚é»‘å¤œæ¨¡å¼ä¸‹è‡ªåŠ¨å˜ä¸ºæ·±ç°å¡ç‰‡ã€‚
 * é€»è¾‘ä¿®æ­£ï¼š
   * ç­›é€‰æ”¹ä¸º AND (äº¤é›†) é€»è¾‘ã€‚
è¯·æ¸…ç©ºé¡¹ç›®ï¼ˆä¿ç•™ requirements.txtï¼‰ï¼Œç›´æ¥åˆ›å»ºä»¥ä¸‹ 4 ä¸ªæ–‡ä»¶ã€‚
ğŸ“„ 1. core/config_manager.py
(ç¨³å¥çš„ç»å¯¹è·¯å¾„ + å¼ºåˆ¶ Source æ ‡è®°)
import json
import os

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        # å¼ºåˆ¶ç»å¯¹è·¯å¾„ï¼Œè§£å†³IDEè¿è¡Œè·¯å¾„ä¸ä¸€è‡´é—®é¢˜
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.team_path = os.path.join(base_dir, team_path)
        self.user_path = os.path.join(base_dir, user_path)
        
        self._init_file(self.team_path)
        self._init_file(self.user_path)

    def _init_file(self, path):
        if not os.path.exists(path):
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump({}, f)
            except: pass

    def _load_json(self, path):
        if not os.path.exists(path): return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except: return {}

    def _save_json(self, path, data):
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except: pass

    def get_all_templates(self):
        merged = {}
        # Load Team
        for k, v in self._load_json(self.team_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'team'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        # Load User
        for k, v in self._load_json(self.user_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'personal'
                if 'tags' not in v: v['tags'] = []
                merged[k] = v
        return merged

    def save_template(self, tid, data, target_source):
        path = self.team_path if target_source == 'team' else self.user_path
        curr = self._load_json(path)
        
        curr[tid] = {
            "name": data.get("name"),
            "desc": data.get("desc", ""),
            "tags": data.get("tags", []),
            "template": data.get("template", ""),
            "params": data.get("params", []),
            "updated_at": "now"
        }
        self._save_json(path, curr)

ğŸ“„ 2. core/tag_manager.py
(æ”¯æŒ Metadata åˆ†ç¦»ï¼šåˆ†ç±»å­˜é¢œè‰²ï¼Œæ ‡ç­¾å­˜å¼•ç”¨)
import json
import os

class TagManager:
    def __init__(self, tag_file="tags.json"):
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.file_path = os.path.join(base_dir, tag_file)
        
        # åˆå§‹åŒ–æ•°æ®ç»“æ„ï¼šmeta å­˜åˆ†ç±»é¢œè‰²ï¼Œdata å­˜å…·ä½“æ ‡ç­¾
        if not os.path.exists(self.file_path):
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({"meta": {}, "data": {}}, f)

    def _read(self):
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                c = json.load(f)
                return c if "meta" in c else {"meta": {}, "data": c}
        except: return {"meta": {}, "data": {}}

    def _save(self, content):
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(content, f, indent=4, ensure_ascii=False)

    def get_all_tags(self):
        return self._read()["data"]

    def get_categories_meta(self):
        return self._read()["meta"]

    def save_category_meta(self, cat, color):
        c = self._read()
        c["meta"][cat] = color
        self._save(c)

    def delete_category(self, cat):
        c = self._read()
        if cat in c["meta"]: del c["meta"][cat]
        # çº§è”æ¸…ç†æ ‡ç­¾
        c["data"] = {k:v for k,v in c["data"].items() if v.get('category') != cat}
        self._save(c)

    def save_tag(self, tid, name, cat):
        c = self._read()
        c["data"][tid] = {"name": name, "category": cat}
        # å¦‚æœåˆ†ç±»æ²¡æœ‰é¢œè‰²ï¼Œç»™ä¸ªé»˜è®¤ç°
        if cat not in c["meta"]: c["meta"][cat] = "#8c8c8c"
        self._save(c)

    def delete_tag(self, tid):
        c = self._read()
        if tid in c["data"]: del c["data"][tid]
        self._save(c)

ğŸ“„ 3. main.py
(å…¥å£ + æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ UI é‡æ„)
import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app
import pandas as pd
import uuid

# ==========================================
# ğŸ¨ å…¨å±€ CSS (æ— ä¾µå…¥å¼ï¼Œé€‚é… Dark Mode)
# ==========================================
st.set_page_config(layout="wide", page_title="Ops Console", page_icon="âš¡")

st.markdown("""
<style>
    /* å­—ä½“ä¼˜åŒ– */
    .stApp { font-family: 'Inter', system-ui, sans-serif; }
    
    /* ä¾§è¾¹æ æ ·å¼å¾®è°ƒ */
    [data-testid="stSidebar"] { border-right: 1px solid rgba(128, 128, 128, 0.2); }
    
    /* å‹ç¼©é¡¶éƒ¨ç•™ç™½ï¼Œå¢åŠ å±æ•ˆ */
    .block-container { padding-top: 1.5rem; }
    
    /* è¡¨æ ¼æ ·å¼ï¼šå»åœ†è§’ï¼Œå¢åŠ ä¸“ä¸šæ„Ÿ */
    [data-testid="stDataFrame"] { border-radius: 4px; }
</style>
""", unsafe_allow_html=True)

def main():
    cfg_mgr = ConfigManager("team_config.json", "user_config.json")
    tag_mgr = TagManager("tags.json")

    with st.sidebar:
        st.subheader("âš¡ Ops Platform")
        
        # æç®€å¯¼èˆª
        menu = sac.menu([
            sac.MenuItem('å·¥ä½œå°', icon='box', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('ç³»ç»Ÿé…ç½®', icon='settings', children=[
                sac.MenuItem('æ ‡ç­¾ç®¡ç†', icon='tag'),
            ]),
        ], color='indigo', open_all=True)

    if menu == 'å‘½ä»¤ç”Ÿæˆå™¨':
        cmd_app.render(cfg_mgr, tag_mgr)
        
    elif menu == 'æ ‡ç­¾ç®¡ç†':
        render_tag_system(tag_mgr)
        
    else:
        st.empty() # é»˜è®¤ä¸æ˜¾ç¤ºå¤šä½™ä¿¡æ¯

# ==========================================
# ğŸ·ï¸ æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ (v8.0 Master-Detail å¸ƒå±€)
# ==========================================
def render_tag_system(tag_mgr):
    st.title("æ ‡ç­¾ä½“ç³»é…ç½®")
    st.caption("å®šä¹‰å…¨å¹³å°çš„åˆ†ç±»ç»´åº¦ä¸é¢œè‰²ï¼Œå¹¶ç®¡ç†å…·ä½“æ ‡ç­¾å€¼ã€‚")

    all_tags = tag_mgr.get_all_tags()
    meta_cats = tag_mgr.get_categories_meta()
    
    # åˆå§‹åŒ–é»˜è®¤åˆ†ç±»
    if not meta_cats:
        meta_cats = {"General": "#64748b"}
        tag_mgr.save_category_meta("General", "#64748b")
        st.rerun()

    # === å·¦å³å¸ƒå±€ï¼šå·¦ä¾§ç»´åº¦æ ‘ | å³ä¾§æ ‡ç­¾æ±  ===
    c_nav, c_main = st.columns([1, 3], gap="medium")

    # --- å·¦ä¾§ï¼šåˆ†ç±»ç»´åº¦ç®¡ç† ---
    with c_nav:
        st.markdown("##### ğŸ“‚ åˆ†ç±»ç»´åº¦")
        
        # 1. åˆ†ç±»åˆ—è¡¨ (Radio æ¨¡æ‹Ÿå¯¼èˆª)
        cat_list = sorted(list(meta_cats.keys()))
        selected_cat = st.radio("é€‰æ‹©åˆ†ç±»", cat_list, label_visibility="collapsed")
        
        st.divider()
        
        # 2. é¢œè‰²ç»‘å®š (æ ¸å¿ƒåŠŸèƒ½)
        st.markdown(f"**{selected_cat}** ä¸»é¢˜è‰²")
        curr_color = meta_cats.get(selected_cat, "#64748b")
        new_color = st.color_picker("Color", value=curr_color, label_visibility="collapsed")
        
        if new_color != curr_color:
            tag_mgr.save_category_meta(selected_cat, new_color)
            st.toast("é¢œè‰²å·²æ›´æ–°", icon="ğŸ¨")
            st.rerun()

        # 3. æ–°å»ºåˆ†ç±»
        with st.expander("â• æ–°å»º/åˆ é™¤åˆ†ç±»"):
            new_cat_name = st.text_input("æ–°åˆ†ç±»åç§°", placeholder="å¦‚: DB")
            if st.button("åˆ›å»º", use_container_width=True):
                if new_cat_name and new_cat_name not in meta_cats:
                    tag_mgr.save_category_meta(new_cat_name, "#3b82f6") # é»˜è®¤è“
                    st.rerun()
            
            if st.button("åˆ é™¤å½“å‰åˆ†ç±»", type="primary", use_container_width=True):
                tag_mgr.delete_category(selected_cat)
                st.rerun()

    # --- å³ä¾§ï¼šæ ‡ç­¾å€¼ç®¡ç† ---
    with c_main:
        # ä½¿ç”¨ Container åŒ…è£¹ï¼Œå½¢æˆå¡ç‰‡æ„Ÿ
        with st.container(border=True):
            r1, r2 = st.columns([4, 2])
            r1.subheader(f"{selected_cat} / Tags")
            
            # é¡¶éƒ¨é¢„è§ˆæ¡ (Grafana Style)
            with r2:
                st.caption("æ ·å¼é¢„è§ˆ")
                sac.tags([sac.Tag(label=f"{selected_cat}: Demo", color=new_color, bordered=False)], align='end')

            st.divider()

            # ç­›é€‰å½“å‰åˆ†ç±»ä¸‹çš„æ ‡ç­¾
            current_tag_rows = []
            for tid, t in all_tags.items():
                if t.get('category') == selected_cat:
                    current_tag_rows.append({"ID": tid, "Value": t['name']})
            
            # å³ä½¿ä¸ºç©ºä¹Ÿæ˜¾ç¤ºç©ºè¡Œ
            if not current_tag_rows:
                current_tag_rows = [{"ID": None, "Value": ""}]

            # æ‰¹é‡ç¼–è¾‘å™¨
            df = pd.DataFrame(current_tag_rows)
            edited_df = st.data_editor(
                df,
                column_config={
                    "ID": None,
                    "Value": st.column_config.TextColumn("æ ‡ç­¾å€¼ (ç›´æ¥ç¼–è¾‘)", required=True, width="large")
                },
                use_container_width=True,
                hide_index=True,
                num_rows="dynamic",
                key=f"editor_{selected_cat}"
            )
            
            # åº•éƒ¨ä¿å­˜æ 
            c_save, _ = st.columns([1, 4])
            if c_save.button("ğŸ’¾ ä¿å­˜åˆ—è¡¨", type="primary", use_container_width=True):
                # é€»è¾‘ï¼šå…ˆåˆ æ‰å½“å‰åˆ†ç±»ä¸‹æ‰€æœ‰æ—§çš„ï¼Œå†æ’å…¥æ–°çš„
                # 1. æ‰¾å‡ºæ‰€æœ‰æ—§ID
                old_ids = [row['ID'] for row in current_tag_rows if row['ID']]
                
                # 2. æ‰¾å‡ºå½“å‰è¡¨æ ¼é‡Œä¿ç•™çš„ID
                kept_ids = set(edited_df["ID"].dropna().tolist())
                
                # 3. åˆ é™¤
                for oid in old_ids:
                    if oid not in kept_ids:
                        tag_mgr.delete_tag(oid)
                
                # 4. æ›´æ–°/æ–°å¢
                for _, row in edited_df.iterrows():
                    if row["Value"]:
                        tid = row.get("ID")
                        if not tid or pd.isna(tid): tid = str(uuid.uuid4())[:8]
                        tag_mgr.save_tag(tid, row["Value"], selected_cat)
                
                st.success("åˆ—è¡¨å·²åŒæ­¥")
                st.rerun()

if __name__ == "__main__":
    main()

ğŸ“„ 4. modules/cmd_generator/app.py
(ç´§å‡‘ Toolbarï¼ŒAND ç­›é€‰é€»è¾‘ï¼ŒGrafana æ ‡ç­¾æ¸²æŸ“)
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid

def render(cfg_mgr, tag_mgr):
    # ==========================
    # Header: æ¥æºåˆ‡æ¢
    # ==========================
    c_title, c_source = st.columns([1, 2])
    c_title.subheader("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    try:
        source_label = sac.segmented(
            items=[sac.SegmentedItem(label='Team'), sac.SegmentedItem(label='Personal')],
            size='sm', align='end', color='indigo'
        )
    except:
        source_label = st.radio("Source", ['Team', 'Personal'], horizontal=True)

    source_code = 'team' if source_label == 'Team' else 'personal'

    # ==========================
    # Toolbar: ç´§å‡‘æ“ä½œæ 
    # ==========================
    # æ•°æ®å‡†å¤‡
    all_data = cfg_mgr.get_all_templates()
    all_tags = tag_mgr.get_all_tags()
    meta_cats = tag_mgr.get_categories_meta()
    
    # æ„é€ æ ‡ç­¾é€‰é¡¹ï¼š{id: "Cat: Name"}
    tag_options = {tid: f"{t.get('category','Gen')}: {t['name']}" for tid, t in all_tags.items()}

    with st.container(border=True):
        # å¸ƒå±€: æœç´¢(3) | ç­›é€‰(3) | è§†å›¾(1.5) | æ–°å»º(1)
        c1, c2, c3, c4 = st.columns([3, 3, 1.5, 1])
        
        search = c1.text_input("Search", placeholder="Search templates...", label_visibility="collapsed")
        
        sel_tags = c2.multiselect("Tags", options=tag_options.keys(), format_func=lambda x: tag_options[x], label_visibility="collapsed", placeholder="Filter by tags (AND)")
        
        view = c3.radio("View", ["Grid", "List"], horizontal=True, label_visibility="collapsed")
        
        if c4.button("â• New", type="primary", use_container_width=True):
            open_editor(cfg_mgr, tag_mgr, "NEW", source_code)

    # ==========================
    # Filter Logic (AND é€»è¾‘)
    # ==========================
    filtered = []
    
    for tid, t in all_data.items():
        # 1. Source åŒ¹é…
        if t.get('source') != source_code: continue
        
        # 2. Search åŒ¹é…
        if search and search.lower() not in t['name'].lower(): continue
        
        # 3. Tag åŒ¹é… (AND Logic: å¿…é¡»åŒ…å«æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾)
        t_tag_ids = set(t.get('tags', []))
        if sel_tags:
            if not set(sel_tags).issubset(t_tag_ids): continue
        
        # 4. ç»„è£…æ˜¾ç¤ºå¯¹è±¡
        display_tags = []
        for tag_id in t.get('tags', []):
            if tag_id in all_tags:
                tag_info = all_tags[tag_id]
                cat = tag_info.get('category', 'Gen')
                # æ ‡ç­¾æ˜¾ç¤ºï¼š[ Cat | Name ]
                display_tags.append({
                    "label": f"{cat}: {tag_info['name']}", 
                    "color": meta_cats.get(cat, '#888')
                })

        filtered.append({
            "id": tid, "name": t['name'], "desc": t.get('desc',''), 
            "tags": display_tags, "raw": t
        })

    # ==========================
    # Render Body
    # ==========================
    if not filtered:
        st.info("No templates found matching your criteria.")
        return

    st.caption(f"Showing {len(filtered)} templates")

    if view == "List":
        render_list(filtered, cfg_mgr)
    else:
        render_grid(filtered, cfg_mgr)

# --- Grid View ---
def render_grid(items, cfg_mgr):
    cols = st.columns(3)
    for idx, item in enumerate(items):
        with cols[idx % 3]:
            with st.container(border=True):
                # Header
                c_h, c_act = st.columns([5, 1])
                c_h.markdown(f"**{item['name']}**")
                
                # Quick Run
                if c_act.button("â–¶", key=f"r_{item['id']}"): 
                    open_runner(cfg_mgr, item['id'])
                
                # Desc
                if item['desc']: st.caption(item['desc'][:50])
                else: st.caption("-")
                
                # Tags
                if item['tags']:
                    try:
                        sac.tags([
                            sac.Tag(label=t['label'], color=t['color'], bordered=False) 
                            for t in item['tags'][:4]
                        ], size='xs', align='start')
                    except: pass
                else:
                    st.caption("No Tags")
                
                # Edit
                if st.button("Edit", key=f"e_{item['id']}", use_container_width=True):
                    open_editor(cfg_mgr, None, item['id'], item['raw']['source'])

# --- List View ---
def render_list(items, cfg_mgr):
    data = []
    for x in items:
        data.append({
            "ID": x['id'], 
            "Name": x['name'], 
            "Tags": [t['label'] for t in x['tags']], 
            "Desc": x['desc']
        })
    df = pd.DataFrame(data)
    
    try: tc = st.column_config.ListColumn("Tags")
    except: tc = st.column_config.TextColumn("Tags")
    
    event = st.dataframe(
        df,
        column_config={"ID":None, "Tags": tc, "Name": st.column_config.TextColumn(width="medium")},
        use_container_width=True, hide_index=True, on_select="rerun", selection_mode="single-row"
    )
    if len(event.selection.rows) > 0:
        open_runner(cfg_mgr, df.iloc[event.selection.rows[0]]['ID'])

# --- Dialogs ---
@st.dialog("Run Template", width="large")
def open_runner(cfg_mgr, tid):
    data = cfg_mgr.get_all_templates().get(tid)
    if not data: return st.error("Error")
    
    c1, c2 = st.columns([1, 1.2], gap="large")
    inp = {}
    with c1:
        st.caption("Parameters")
        with st.form("exec"):
            for p in data.get('params', []):
                l = p.get('label', p['name'])
                if p['type']=='select': inp[p['name']] = st.selectbox(l, [x.strip() for x in p.get("options","").split(",") if x.strip()])
                else: inp[p['name']] = st.text_input(l, value=str(p.get('default','')))
            sub = st.form_submit_button("Generate Command", type="primary", use_container_width=True)
            
    with c2:
        st.caption("Result")
        res = "..."
        if sub:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in inp.items()}
                t = Template(data.get('template',''))
                res = t.render(**safe)
            except Exception as e: res = str(e)
        st.code(res, language="bash")

@st.dialog("Edit Template", width="large")
def open_editor(cfg_mgr, tag_mgr, tid, source):
    if tag_mgr is None: from core.tag_manager import TagManager; tag_mgr = TagManager("tags.json")
    is_new = (tid == "NEW")
    data = {} if is_new else cfg_mgr.get_all_templates().get(tid, {})
    
    name = st.text_input("Name", value=data.get('name',''))
    
    # Tag Selector with Category grouping
    all_tags = tag_mgr.get_all_tags()
    # Format options nicely
    tag_opts = {tid: f"{t.get('category','Gen')}: {t['name']}" for tid, t in all_tags.items()}
    default_tags = [t for t in data.get('tags', []) if t in tag_opts]
    
    sel_tags = st.multiselect("Tags", options=tag_opts.keys(), default=default_tags, format_func=lambda x: tag_opts[x])
    
    desc = st.text_input("Description", value=data.get('desc',''))
    
    # Params
    default_p = [{"name": "p1", "label": "Label", "type": "text", "default": "", "options": ""}]
    p_data = data.get('params', default_p)
    if not p_data: p_data = default_p
    
    st.caption("Parameters definition")
    edf = st.data_editor(pd.DataFrame(p_data), num_rows="dynamic", use_container_width=True)
    
    code = st.text_area("Template Code", value=data.get('template',''), height=150)
    
    if st.button("Save Template", type="primary"):
        if not name: return st.error("Name is required")
        sid = str(uuid.uuid4())[:8] if is_new else tid
        plist = [p for p in edf.to_dict('records') if p['name']]
        sdata = {"name": name, "desc": desc, "tags": sel_tags, "template": code, "params": plist}
        cfg_mgr.save_template(sid, sdata, source)
        st.rerun()


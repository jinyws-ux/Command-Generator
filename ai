è¿™ä¸ªé€‰æ‹©éå¸¸æ£’ï¼Streamlit éå¸¸é€‚åˆè¿™ç§**â€œè¾“å…¥å‚æ•° -> ç»„è£…é€»è¾‘ -> è¾“å‡ºç»“æœâ€**çš„å·¥å…·ã€‚
é‰´äºä½ çš„éœ€æ±‚æ˜¯**â€œå‘½ä»¤æœ‰æ¨¡æ¿ï¼Œä½†ç»†èŠ‚å¤šå˜â€**ï¼Œå¦‚æœæŠŠæ‰€æœ‰é€»è¾‘éƒ½å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œå¾ˆå¿«å°±ä¼šå˜æˆä¸€å›¢ä¹±éº»ã€‚
æˆ‘å»ºè®®é‡‡ç”¨**â€œç­–ç•¥æ¨¡å¼ (Strategy Pattern) + é…ç½®æ–‡ä»¶/å…ƒæ•°æ®â€**çš„è®¾è®¡æ¶æ„ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šä¸»ç¨‹åºï¼ˆUIï¼‰ä¸éœ€è¦æ”¹åŠ¨ï¼Œæ¯å½“ä½ éœ€è¦åŠ ä¸€ä¸ªæ–°å‘½ä»¤æ—¶ï¼Œåªéœ€è¦å†™ä¸€ä¸ªæ–°çš„â€œç­–ç•¥ç±»â€å³å¯ã€‚
ä¸‹é¢æ˜¯ä¸ºä½ è®¾è®¡çš„é¡¹ç›®åŸºç¡€æ¶æ„ï¼š
1. é¡¹ç›®ç›®å½•ç»“æ„
æˆ‘ä»¬å°†ä»£ç åˆ†ä¸ºä¸‰å±‚ï¼šUI å±‚ï¼ˆapp.pyï¼‰ã€æ ¸å¿ƒé€»è¾‘å±‚ï¼ˆcommands/ï¼‰å’Œ å·¥å…·å±‚ï¼ˆutils/ï¼‰ã€‚
cmd_gen_project/
â”œâ”€â”€ app.py                  # [å…¥å£] Streamlit ä¸»ç¨‹åºï¼Œè´Ÿè´£æ¸²æŸ“ç•Œé¢
â”œâ”€â”€ requirements.txt        # ä¾èµ–åº“ (streamlit, jinja2)
â””â”€â”€ commands/               # [æ ¸å¿ƒ] å­˜æ”¾æ‰€æœ‰å‘½ä»¤ç”Ÿæˆçš„é€»è¾‘
    â”œâ”€â”€ __init__.py         # æš´éœ²å‘½ä»¤æ³¨å†Œè¡¨
    â”œâ”€â”€ base.py             # å®šä¹‰æ‰€æœ‰å‘½ä»¤å¿…é¡»éµå®ˆçš„â€œè§„åˆ™â€ï¼ˆåŸºç±»ï¼‰
    â”œâ”€â”€ linux_ops.py        # å…·ä½“çš„ Linux å‘½ä»¤å®ç°
    â””â”€â”€ sql_queries.py      # å…·ä½“çš„ SQL å‘½ä»¤å®ç°

2. æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼ˆæ ¸å¿ƒä»£ç å®ç°ï¼‰
ç¬¬ä¸€æ­¥ï¼šå®šä¹‰â€œå‘½ä»¤â€çš„æ ‡å‡† (base.py)
ä¸ºäº†åº”å¯¹å˜åŒ–ï¼Œæˆ‘ä»¬è¦è§„å®šæ¯ä¸ªâ€œå‘½ä»¤ç”Ÿæˆå™¨â€å¿…é¡»åŒ…å«ä¸‰ä¸ªè¦ç´ ï¼š
 * å…ƒæ•°æ®ï¼šåå­—ã€æè¿°ã€‚
 * å‚æ•°å®šä¹‰ï¼šå‘Šè¯‰ UI éœ€è¦æ¸²æŸ“å“ªäº›è¾“å…¥æ¡†ï¼ˆæ–‡æœ¬æ¡†ã€æ•°å­—ã€ä¸‹æ‹‰èœå•ï¼‰ã€‚
 * ç”Ÿæˆé€»è¾‘ï¼šæ‹¿åˆ°ç”¨æˆ·è¾“å…¥åï¼Œæ€ä¹ˆæ‹¼æ¥å­—ç¬¦ä¸²ã€‚
åœ¨ commands/base.py ä¸­ï¼š
from abc import ABC, abstractmethod
from typing import List, Dict, Any

class CommandStrategy(ABC):
    """
    æ‰€æœ‰å‘½ä»¤ç”Ÿæˆå™¨çš„åŸºç±»ï¼ˆçˆ¶ç±»ï¼‰
    """
    
    @property
    @abstractmethod
    def name(self) -> str:
        """å‘½ä»¤åœ¨ä¸‹æ‹‰èœå•ä¸­æ˜¾ç¤ºçš„åå­—"""
        pass

    @property
    @abstractmethod
    def description(self) -> str:
        """å‘½ä»¤çš„è¯¦ç»†æè¿°/å¸®åŠ©æ–‡æ¡£"""
        pass

    @abstractmethod
    def get_params_schema(self) -> List[Dict[str, Any]]:
        """
        å®šä¹‰å‰ç«¯éœ€è¦æ˜¾ç¤ºçš„è¾“å…¥æ¡†ã€‚
        æ ¼å¼ç¤ºä¾‹:
        [
            {"name": "target_ip", "label": "ç›®æ ‡IP", "type": "text"},
            {"name": "limit", "label": "é™åˆ¶è¡Œæ•°", "type": "number", "default": 10},
            {"name": "mode", "label": "æ¨¡å¼", "type": "select", "options": ["fast", "safe"]}
        ]
        """
        pass

    @abstractmethod
    def generate(self, params: Dict[str, Any]) -> str:
        """æ ¸å¿ƒé€»è¾‘ï¼šæ¥æ”¶å‚æ•°å­—å…¸ï¼Œè¿”å›æœ€ç»ˆçš„å‘½ä»¤å­—ç¬¦ä¸²"""
        pass

ç¬¬äºŒæ­¥ï¼šå®ç°å…·ä½“çš„å‘½ä»¤ (linux_ops.py)
è¿™é‡Œæˆ‘ä»¬å¼•å…¥ Jinja2 æ¨¡æ¿å¼•æ“ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºä½ è¯´éœ€æ±‚æ˜¯å˜åŒ–çš„ã€‚
æ¯”å¦‚ï¼šâ€œå¦‚æœç”¨æˆ·é€‰äº†â€˜å¼ºåˆ¶â€™æ¨¡å¼ï¼Œå‘½ä»¤é‡Œå°±è¦åŠ  -fï¼Œå¦åˆ™ä¸åŠ â€ã€‚ç”¨ Python çš„ if-else æ‹¼æ¥å­—ç¬¦ä¸²å¤ªä¸‘äº†ï¼Œç”¨æ¨¡æ¿æœ€æ¸…æ™°ã€‚
åœ¨ commands/linux_ops.py ä¸­ï¼š
from .base import CommandStrategy
from jinja2 import Template
import shlex  # ç”¨äºå¤„ç†å‘½ä»¤è¡Œç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢æ³¨å…¥

class FindLargeFilesCommand(CommandStrategy):
    name = "Linux: æŸ¥æ‰¾å¤§æ–‡ä»¶"
    description = "åœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾è¶…è¿‡ç‰¹å®šå¤§å°çš„æ–‡ä»¶ï¼Œå¹¶å¯é€‰æ˜¯å¦åˆ é™¤ã€‚"

    def get_params_schema(self):
        return [
            {"name": "path", "label": "æœç´¢è·¯å¾„", "type": "text", "default": "/var/log"},
            {"name": "size_mb", "label": "æœ€å°ä½“ç§¯(MB)", "type": "number", "default": 100},
            {"name": "file_type", "label": "æ–‡ä»¶åç¼€", "type": "text", "help": "ä¾‹å¦‚: .log (ç•™ç©ºåˆ™åŒ¹é…æ‰€æœ‰)"},
            {"name": "action", "label": "æ‰§è¡ŒåŠ¨ä½œ", "type": "select", "options": ["åªæ˜¾ç¤º (print)", "åˆ é™¤ (delete)", "è¯¦æƒ… (ls -lh)"]}
        ]

    def generate(self, params):
        # 1. æ¨¡æ¿å®šä¹‰ (Jinja2 è¯­æ³•)
        # è¿™é‡Œçš„é€»è¾‘éå¸¸çµæ´»ï¼Œ{% if %} è¯­å¥å¤„ç†äº†ä½ çš„å¤šå˜éœ€æ±‚
        template_str = """
        find {{ path | safe }} -type f -size +{{ size }}M
        {%- if file_type %} -name "*{{ file_type }}" {% endif -%}
        {%- if action == 'åˆ é™¤ (delete)' %} -delete
        {%- elif action == 'è¯¦æƒ… (ls -lh)' %} -exec ls -lh {} +
        {%- else %} -print
        {%- endif -%}
        """
        
        # 2. å®‰å…¨å¤„ç† (é˜²æ­¢è·¯å¾„é‡Œæœ‰ç©ºæ ¼æˆ–æ¶æ„å­—ç¬¦)
        safe_path = shlex.quote(params.get("path", ""))
        
        # 3. æ¸²æŸ“
        t = Template(template_str)
        return t.render(
            path=safe_path,
            size=params.get("size_mb"),
            file_type=params.get("file_type"),
            action=params.get("action")
        ).strip()

3. æ„å»ºé€šç”¨ UI å¼•æ“ (app.py)
è¿™æ˜¯æœ€ç²¾å½©çš„éƒ¨åˆ†ã€‚app.py ä¸éœ€è¦çŸ¥é“å…·ä½“çš„å‘½ä»¤æ˜¯ä»€ä¹ˆï¼Œå®ƒåªæ˜¯è¯»å– get_params_schemaï¼Œç„¶åè‡ªåŠ¨ç”»å‡ºç•Œé¢ã€‚
import streamlit as st
import importlib
import pkgutil
import commands

# --- 1. åŠ¨æ€åŠ è½½æ‰€æœ‰å‘½ä»¤ç­–ç•¥ ---
def load_commands():
    """æ‰«æ commands æ–‡ä»¶å¤¹ï¼Œæ‰¾åˆ°æ‰€æœ‰ç»§æ‰¿è‡ª CommandStrategy çš„ç±»"""
    registry = {}
    
    # è¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€å•ï¼Œç›´æ¥æ‰‹åŠ¨å¯¼å…¥ã€‚
    # å®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ pkgutil è‡ªåŠ¨æ‰«ææ–‡ä»¶å¤¹ä¸‹çš„æ¨¡å—
    from commands.linux_ops import FindLargeFilesCommand
    # from commands.sql_queries import MyComplexQueryCommand (å‡è®¾ä½ å†™äº†è¿™ä¸ª)
    
    # æ³¨å†Œå‘½ä»¤
    cmds = [FindLargeFilesCommand()] # æŠŠå®ä¾‹æ”¾è¿›åˆ—è¡¨
    
    for cmd in cmds:
        registry[cmd.name] = cmd
    return registry

# --- 2. ä¸»ç¨‹åº ---
def main():
    st.set_page_config(page_title="è¿ç»´å‘½ä»¤ç”Ÿæˆå™¨", layout="wide")
    st.title("ğŸ› ï¸ Ops Command Generator")

    command_registry = load_commands()
    
    # ä¾§è¾¹æ ï¼šé€‰æ‹©å‘½ä»¤ç±»å‹
    selected_cmd_name = st.sidebar.selectbox(
        "é€‰æ‹©è¦ç”Ÿæˆçš„å‘½ä»¤", 
        options=command_registry.keys()
    )
    
    if not selected_cmd_name:
        st.info("è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå‘½ä»¤æ¨¡æ¿")
        return

    # è·å–å½“å‰é€‰ä¸­çš„ç­–ç•¥å¯¹è±¡
    strategy = command_registry[selected_cmd_name]
    
    st.header(f"é…ç½®: {selected_cmd_name}")
    st.markdown(f"> {strategy.description}")
    
    # --- 3. åŠ¨æ€è¡¨å•ç”Ÿæˆå¼•æ“ (æ ¸å¿ƒ) ---
    # æ ¹æ®ç­–ç•¥ç±»é‡Œå®šä¹‰çš„ schema è‡ªåŠ¨ç”»å‡º UI
    user_inputs = {}
    schema = strategy.get_params_schema()
    
    with st.form("param_form"):
        col1, col2 = st.columns(2) # åˆ†ä¸¤åˆ—æ˜¾ç¤ºæ¯”è¾ƒå¥½çœ‹
        
        for idx, field in enumerate(schema):
            # ç®€å•çš„åˆ†åˆ—é€»è¾‘
            current_col = col1 if idx % 2 == 0 else col2
            
            field_type = field.get("type")
            label = field.get("label")
            key = field.get("name")
            default = field.get("default", None)
            help_text = field.get("help", "")
            
            if field_type == "text":
                user_inputs[key] = current_col.text_input(label, value=default, help=help_text)
            elif field_type == "number":
                user_inputs[key] = current_col.number_input(label, value=default or 0, help=help_text)
            elif field_type == "select":
                user_inputs[key] = current_col.selectbox(label, options=field.get("options", []), help=help_text)
            elif field_type == "checkbox":
                user_inputs[key] = current_col.checkbox(label, value=default or False, help=help_text)
        
        submitted = st.form_submit_button("ğŸš€ ç”Ÿæˆå‘½ä»¤")

    # --- 4. ç»“æœå±•ç¤º ---
    if submitted:
        try:
            # è°ƒç”¨ç­–ç•¥ç±»çš„ generate æ–¹æ³•
            final_cmd = strategy.generate(user_inputs)
            
            st.success("ç”ŸæˆæˆåŠŸï¼")
            st.code(final_cmd, language="bash") # è‡ªåŠ¨å¸¦å¤åˆ¶æŒ‰é’®
            
            st.warning("âš ï¸ æ³¨æ„ï¼šè¯·åŠ¡å¿…æ£€æŸ¥ç”Ÿæˆçš„å‘½ä»¤ï¼Œç¡®è®¤æ— è¯¯åå†æ‰§è¡Œã€‚")
            
        except Exception as e:
            st.error(f"ç”Ÿæˆå¤±è´¥: {str(e)}")

if __name__ == "__main__":
    main()

4. è¿™æ ·è®¾è®¡çš„ä¼˜ç‚¹
 * æ‰©å±•æå…¶ç®€å•ï¼š
   * ä½ æƒ³åŠ ä¸€ä¸ª "MySQL å¤‡ä»½å‘½ä»¤"ï¼Ÿ
   * ä¸éœ€è¦æ”¹ app.pyã€‚
   * åªéœ€è¦åœ¨ commands/ ä¸‹æ–°å»ºä¸€ä¸ªç±»ï¼Œç»§æ‰¿ CommandStrategyï¼Œå¡«å¥½å®ƒçš„å‚æ•°åˆ—è¡¨å’Œ Jinja2 æ¨¡æ¿ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨å‡ºç°åœ¨ç½‘é¡µçš„ä¸‹æ‹‰èœå•é‡Œã€‚
 * åº”å¯¹å¤šå˜éœ€æ±‚ï¼š
   * Jinja2 æ¨¡æ¿ï¼ˆ{% if %}, {% for %}ï¼‰éå¸¸å¼ºå¤§ï¼Œå¯ä»¥å¤„ç†éå¸¸å¤æ‚çš„ SQL æ‹¼æ¥é€»è¾‘ï¼ˆæ¯”å¦‚åŠ¨æ€æ‹¼æ¥ WHERE æ¡ä»¶ï¼‰ã€‚
 * ç•Œé¢ç»Ÿä¸€ï¼š
   * ä¸ç®¡å‘½ä»¤å¤šå¤æ‚ï¼Œç”¨æˆ·ç•Œé¢æ°¸è¿œæ˜¯æ•´é½çš„è¡¨å•ã€‚
5. ç»™ä½ çš„ä¸‹ä¸€æ­¥å»ºè®®
ä½ å¯ä»¥å…ˆæŠŠè¿™å¥—ä»£ç å¤åˆ¶ä¸‹æ¥è·‘é€šã€‚
æ¥ä¸‹æ¥ï¼Œå½“ä½ é‡åˆ°**â€œç‰¹åˆ«å¤æ‚ã€å¸¦æœ‰ä¸Šä¸‹æ–‡é€»è¾‘â€**çš„éœ€æ±‚æ—¶ï¼ˆä¾‹å¦‚ï¼šå‰ä¸€ä¸ªå‚æ•°å¡«äº† Aï¼Œåä¸€ä¸ªå‚æ•°çš„é€‰é¡¹åªèƒ½æ˜¯ B å’Œ Cï¼‰ï¼ŒStreamlit ä¹Ÿæ˜¯æ”¯æŒçš„ï¼ˆåªè¦æŠŠ st.form å»æ‰ï¼Œåˆ©ç”¨ Streamlit çš„å³æ—¶æ¸²æŸ“ç‰¹æ€§å³å¯ï¼‰ã€‚
ä½ çœ‹è¿™ä¸ªæ¶æ„ç¬¦åˆä½ çš„å¿ƒç†é¢„æœŸå—ï¼Ÿå¦‚æœæ²¡é—®é¢˜ï¼Œä½ å¯ä»¥å°è¯•å…ˆå®ç°ä¸€ä¸ªä½ æœ€å¸¸ç”¨çš„ SQL å¯¼å‡ºå‘½ä»¤ç»ƒç»ƒæ‰‹ã€‚

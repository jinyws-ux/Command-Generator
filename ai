æˆ‘å®Œå…¨æ˜ç™½äº†ã€‚ä¸Šä¸€ç‰ˆä¸ºäº†è¿½æ±‚æè‡´çš„â€œå¡«æ»¡æ„Ÿâ€ï¼Œå¯¼è‡´äº† CSS çš„å±‚çº§å†²çªï¼ˆInputè‡ªå¸¦çš„å®¹å™¨ q-field__control å’Œå¤–å±‚ Div çš„å†²çªï¼‰ï¼Œè€Œä¸”æˆ‘ç¡®å®çŠ¯äº†ä½çº§é”™è¯¯ï¼ŒæŠŠé»‘åº•ç¼–è¾‘å™¨çš„å­—ä¹Ÿå¼„æˆé»‘è‰²äº†ã€‚
è¿™æ¬¡æˆ‘å›é€€åˆ°ä½ è§‰å¾—ç»“æ„æ¯”è¾ƒæ¸…æ™°çš„å¸ƒå±€ï¼Œå¹¶é’ˆå¯¹ä½ æŒ‡å‡ºçš„ 4 ä¸ªæ ¸å¿ƒé—®é¢˜ è¿›è¡Œç²¾å‡†ä¿®å¤ï¼š
 * ä¾§è¾¹æ æŒ‰é’®ä¸ç»Ÿä¸€ï¼šå¼ºåˆ¶ç»Ÿä¸€å­—ä½“å¤§å° (text-sm) å’Œé«˜åº¦ï¼Œä¿è¯è§†è§‰æ•´é½ã€‚
 * RUN æŒ‰é’®æº¢å‡ºï¼šä¸å†ç”¨ç¡¬å®½ï¼Œæ”¹ç”¨ w-full é…åˆ mx-auto å’Œ padding è®¡ç®—ï¼Œä¿è¯å®ƒä¹–ä¹–å¾…åœ¨å¡ç‰‡é‡Œã€‚
 * ç¼–è¾‘å™¨ç•Œé¢ä¿®å¤ï¼š
   * æ¶ˆé™¤å‰²è£‚æ„Ÿï¼šå½»åº•å»æ‰ NiceGUI/Quasar è¾“å…¥æ¡†è‡ªå¸¦çš„åœ†è§’ã€é˜´å½±å’Œè¾¹æ¡†ï¼Œè®©å®ƒçº¯ç²¹å˜æˆä¸€ä¸ªè¾“å…¥æ§ä»¶ï¼Œå®Œç¾è´´åˆå¤–å±‚é»‘æ¡†ã€‚
   * é¢œè‰²ä¿®å¤ï¼šTemplate åŒºåŸŸå¼ºåˆ¶ï¼šé»‘åº• + ç»¿å­—ã€‚
   * æŒ‰é’®å›å½’ï¼šæ”¾å¼ƒæ‚¬æµ®æŒ‰é’®ï¼Œæ”¹å›åº•éƒ¨çš„æ ‡å‡†æŒ‰é’®æ ã€‚
 * Output Log ä¿®å¤ï¼š
   * åˆ é™¤å¤šä½™çš„å¤åˆ¶æŒ‰é’®é€»è¾‘ï¼Œåªä¿ç•™å³ä¸‹è§’çš„ä¸€ä¸ªã€‚
   * ä¿®æ­£å¯¹é½æ–¹å¼ï¼Œä¸å†æ­ªäº†ã€‚
è¯·ç›´æ¥å…¨é‡è¦†ç›– cmd_exe/main.pyã€‚
# cmd_exe/main.py
from nicegui import ui
from logic import db
import theme
import uuid
import datetime

theme.setup_theme()

# =======================================================
# è‡ªå®šä¹‰ç»„ä»¶ (ä¿®å¤ç‰ˆ)
# =======================================================

def b_button(text, icon=None, bg_color="white", text_color="black", on_click=None):
    """
    é‡å…½æ´¾æŒ‰é’® - ä¿®å¤å­—ä½“å¤§å°ä¸ç»Ÿä¸€é—®é¢˜
    ç»Ÿä¸€ä½¿ç”¨ text-sm (14px) å’Œ font-bold
    """
    return ui.button(text, icon=icon, on_click=on_click) \
        .style(theme.BRUTAL_BTN + f"background-color: {bg_color}; color: {text_color};") \
        .classes(f"{theme.BTN_ACTIVE} w-full py-2 text-sm font-bold tracking-wider")

def b_tag(text, bg_color="#E5E7EB"):
    """é‡å…½æ´¾æ ‡ç­¾"""
    ui.label(text).style(f"background: {bg_color}; border: 2px solid black; box-shadow: 2px 2px 0 black;") \
        .classes('px-2 py-0.5 text-[10px] font-bold mr-1 mb-1')

# =======================================================
# é¡µé¢å¸ƒå±€
# =======================================================

# 1. é¡¶æ 
with ui.header().classes('bg-transparent pointer-events-none'):
    with ui.row().classes('w-full pointer-events-auto justify-between items-center px-6 py-4'):
        with ui.row().classes('gap-0 items-end'):
            ui.label('CMD').style('background: black; color: white; padding: 4px 12px; font-weight: 900; font-size: 28px; border: 3px solid black;')
            ui.label('GEN').style('background: white; color: black; padding: 4px 12px; font-weight: 900; font-size: 28px; border: 3px solid black; border-left: none;')
        
        search_input = ui.input(placeholder='SEARCH...') \
            .props('outlined dense').style(theme.BRUTAL_INPUT + "background: white; width: 300px;")

# 2. ä¸»ä½“å®¹å™¨
with ui.row().classes('w-full h-[calc(100vh-100px)] gap-6 px-6 no-wrap items-start'):
    
    # === å·¦ä¾§ï¼šæŒ‡ä»¤å¡” ===
    # ä¿®å¤ï¼šæŒ‰é’®é«˜åº¦å’Œå­—ä½“å®Œå…¨ç»Ÿä¸€
    with ui.column().style(theme.BRUTAL_BOX).classes('w-[260px] h-full p-4 gap-4 flex-shrink-0 bg-white'):
        ui.label('CONTROL_PANEL').classes('font-bold text-gray-400 text-xs tracking-widest')
        
        b_button('NEW COMMAND', 'add', bg_color=theme.ACCENT_CYAN, on_click=lambda: open_editor())
        b_button('TAG MANAGER', 'label', bg_color='white', on_click=lambda: ui.notify('Coming soon'))
        
        ui.separator().classes('bg-black h-[2px]')
        
        with ui.column().classes('gap-1'):
            ui.label('SYSTEM STATUS').classes('font-bold text-xs')
            with ui.row().classes('justify-between w-full'):
                ui.label('Modules:').classes('font-mono text-sm')
                count_label = ui.label('0').classes('font-mono font-bold bg-black text-white px-2')

    # === ä¸­é—´ï¼šæ ¸å¿ƒçŸ©é˜µ ===
    with ui.scroll_area().classes('flex-grow h-full pr-4'):
        grid_container = ui.row().classes('w-full gap-4 items-start content-start')

        def refresh_grid(filter_text=""):
            grid_container.clear()
            templates = db.get_templates()
            tags_map = db.get_tags()
            count_label.text = str(len(templates))
            
            with grid_container:
                if not templates:
                    with ui.column().classes('w-full items-center py-20 opacity-40'):
                        ui.icon('apps', size='64px')
                        ui.label('NO MODULES').classes('font-bold text-xl mt-4')
                    return

                for tid, t in templates.items():
                    if filter_text and filter_text.lower() not in t['name'].lower(): continue

                    # å¡ç‰‡å®¹å™¨
                    with ui.card().style(theme.BRUTAL_BOX).classes('w-[280px] p-0 flex flex-col justify-between group cursor-default hover:-translate-y-1 transition-transform'):
                        # æ ‡é¢˜
                        with ui.row().style(f'background:{theme.ACCENT_YELLOW}; border-bottom: 3px solid black;').classes('w-full p-3 justify-between items-center'):
                            ui.label(t['name']).classes('font-black text-lg truncate')
                            ui.button(icon='edit', on_click=lambda id=tid: open_editor(id)).props('flat dense round color=black size=sm')

                        # å†…å®¹
                        with ui.column().classes('p-3 gap-2 flex-grow'):
                            ui.label(t.get('desc', '-')).classes('text-xs font-mono text-gray-500 line-clamp-2 h-8')
                            with ui.row().classes('gap-0'):
                                for tag_id in t.get('tags', []):
                                    if tag_id in tags_map:
                                        b_tag(tags_map[tag_id]['name'], tags_map[tag_id].get('color', '#eee'))
                        
                        # åº•éƒ¨æŒ‰é’®ä¿®å¤ï¼šé˜²æ­¢æº¢å‡º
                        # ä½¿ç”¨ mx-3 (å·¦å³margin) å’Œ mb-3 (åº•éƒ¨margin)ï¼Œä¸å†ç¡¬å†™å®½åº¦
                        with ui.row().classes('px-3 pb-3 w-full'):
                            b_button('RUN', 'play_arrow', bg_color='black', text_color='white', on_click=lambda id=tid: open_runner(id))

        refresh_grid()
        search_input.on('change', lambda e: refresh_grid(e.value))

    # === å³ä¾§ï¼šæ—¶å…‰æœº (ä¿®å¤ç‰ˆ) ===
    with ui.column().style(theme.BRUTAL_BOX).classes('w-[300px] h-full p-0 flex-shrink-0 bg-gray-50 overflow-hidden'):
        ui.label('OUTPUT_LOG').style('background: black; color: white; padding: 8px; font-weight: bold; text-align: center; width: 100%;')
        
        log_area = ui.scroll_area().classes('w-full flex-grow p-4 gap-3 bg-[url("https://www.transparenttextures.com/patterns/graphy.png")] pb-10')
        
        def add_log(cmd_str):
            with log_area:
                # ä¿®å¤ï¼šåªä¿ç•™ä¸€ä¸ªå¤åˆ¶æŒ‰é’®ï¼Œä¸”å¯¹é½
                with ui.column().style('background: white; border: 2px solid black; box-shadow: 2px 2px 0 rgba(0,0,0,0.2);').classes('w-full mb-2 p-2 relative'):
                    ui.label(datetime.datetime.now().strftime("%H:%M:%S")).classes('text-[9px] font-black text-gray-400 mb-1')
                    
                    # ä»£ç å—ï¼šé˜²æ­¢æº¢å‡º break-all
                    ui.code(cmd_str).classes('text-xs font-mono break-all bg-transparent p-0 text-red-600 mb-6') 
                    
                    # å”¯ä¸€çš„å¤åˆ¶æŒ‰é’®ï¼šç»å¯¹å®šä½åœ¨å³ä¸‹è§’
                    ui.button(icon='content_copy', on_click=lambda: ui.clipboard.write(cmd_str)) \
                        .props('flat dense round size=xs color=black') \
                        .classes('absolute bottom-1 right-1 bg-gray-200 hover:bg-gray-300')

            log_area.scroll_to(percent=1.0)

# =======================================================
# å¼¹çª—é€»è¾‘
# =======================================================

def open_runner(tid):
    data = db.get_templates().get(tid)
    if not data: return
    
    with ui.dialog() as dialog, ui.card().style(theme.BRUTAL_BOX).classes('min-w-[500px] p-0'):
        with ui.row().style(f'background:{theme.ACCENT_PINK}; border-bottom: 3px solid black;').classes('w-full p-4 justify-between items-center'):
            ui.label(f">> EXECUTE").classes('font-black text-xl')
            ui.button(icon='close', on_click=dialog.close).props('flat dense round color=black')
        
        inputs = {}
        with ui.column().classes('p-6 gap-4 w-full bg-white'):
            for p in data.get('params', []):
                ui.label(p.get('label', p['name'])).classes('font-bold text-xs mb-[-8px]')
                inputs[p['name']] = ui.input(value=p.get('default', '')).props('dense outlined').style(theme.BRUTAL_INPUT).classes('w-full')
            
            ui.label('PREVIEW').classes('font-bold text-xs mt-2')
            res_box = ui.code('Waiting...').classes('w-full p-3 border-2 border-black bg-black text-green-400 font-mono rounded-none')
            
            def run_gen():
                try:
                    params = {k: v.value for k,v in inputs.items()}
                    res = db.render(data.get('template', ''), params)
                    res_box.content = res
                    add_log(res)
                    ui.clipboard.write(res)
                    ui.notify('COPIED', color='black')
                except Exception as e:
                    ui.notify(str(e), color='red')

            b_button('GENERATE', 'bolt', bg_color=theme.ACCENT_CYAN, on_click=run_gen)

    dialog.open()

def open_editor(tid=None):
    is_edit = tid is not None
    data = db.get_templates().get(tid, {}) if is_edit else {}
    
    with ui.dialog() as dialog, ui.card().style(theme.BRUTAL_BOX).classes('min-w-[900px] h-[650px] p-0 overflow-hidden'):
        # å¼¹çª—å¤´
        with ui.row().style('background:black; color:white;').classes('w-full p-3 justify-between items-center flex-shrink-0'):
            ui.label('EDITOR').classes('font-mono font-bold text-lg')
            ui.button(icon='close', on_click=dialog.close).props('flat dense round color=white')
        
        # === æ ¸å¿ƒä¿®å¤ï¼šç¼–è¾‘å¸ƒå±€ ===
        with ui.row().classes('w-full h-full no-wrap'):
            
            # --- å·¦ä¾§ï¼šé…ç½®åŒº ---
            # bg-gray-100 ç¨å¾®æ·±ä¸€ç‚¹çš„ç°ï¼ŒåŒºåˆ†å³ä¾§
            with ui.column().classes('w-1/2 h-full border-r-2 border-black bg-gray-100 p-0 flex flex-col'):
                
                # é¡¶éƒ¨ï¼šåç§°æè¿°
                with ui.column().classes('p-4 gap-3 bg-white border-b-2 border-black'):
                    ui.label('METADATA').classes('font-black text-xs tracking-wider')
                    name = ui.input('NAME', value=data.get('name','')).props('dense outlined square').style(theme.BRUTAL_INPUT).classes('w-full')
                    desc = ui.input('DESC', value=data.get('desc','')).props('dense outlined square').style(theme.BRUTAL_INPUT).classes('w-full')

                # ä¸­éƒ¨ï¼šå‚æ•°é…ç½® (CSV)
                # ä½¿ç”¨ flex-grow è®©å®ƒå æ»¡å‰©ä½™ç©ºé—´
                with ui.column().classes('p-0 flex-grow relative'):
                    ui.label('PARAMETERS (CSV)').classes('font-black text-xs px-4 py-2 bg-gray-200 border-b-2 border-black w-full')
                    
                    def params_to_str(plist): return "\n".join([f"{p['name']},{p.get('label','')},{p.get('default','')}" for p in plist])
                    def str_to_params(txt): 
                        return [{"name": l.split(',')[0].strip(), "label": l.split(',')[1].strip() if ',' in l else l.split(',')[0], "default": l.split(',')[2].strip() if l.count(',')>=2 else ""} for l in txt.split('\n') if l.strip()]
                    
                    # ä¿®å¤ï¼šç§»é™¤æ‰€æœ‰è¾¹æ¡†å’Œpaddingï¼Œè®©textareaå¡«æ»¡
                    # props('borderless') å»æ‰Quasarè‡ªå¸¦è¾¹æ¡†
                    # style é‡Œ background:transparent 
                    p_input = ui.textarea(value=params_to_str(data.get('params',[]))) \
                        .props('borderless dense square') \
                        .style('width: 100%; height: 100%; resize: none; background: transparent; padding: 16px; font-family: monospace;') \
                        .classes('text-sm text-black')

            # --- å³ä¾§ï¼šæ¨¡æ¿ä»£ç  (ä¿®å¤é»‘åº•çœ‹ä¸è§å­—çš„é—®é¢˜) ---
            with ui.column().classes('w-1/2 h-full bg-black p-0 flex flex-col'):
                ui.label('TEMPLATE (JINJA2)').classes('font-black text-xs text-green-500 px-4 py-2 border-b border-gray-800 w-full bg-gray-900')
                
                # ä¿®å¤ï¼šå­—ä½“é¢œè‰²è®¾ä¸º text-green-400ï¼ŒèƒŒæ™¯è®¾ä¸º #000
                t_input = ui.textarea(value=data.get('template','')) \
                    .props('borderless dense square') \
                    .style("width:100%; height:100%; resize:none; background: #000; color: #4ade80; font-family: 'JetBrains Mono', monospace; padding: 16px; border: none; outline: none;") \
                    .classes('text-sm')
                
                # ä¿®å¤ï¼šåº•éƒ¨æŒ‰é’®æ å›å½’ (User requested: "æŒ‰é’®ä¹Ÿæ¢å¤å›æ¥")
                # æ”¾åœ¨å³ä¾§åº•éƒ¨ï¼Œé»‘è‰²èƒŒæ™¯
                with ui.row().classes('w-full p-4 gap-4 justify-end border-t border-gray-800 bg-gray-900'):
                    if is_edit:
                        ui.button('DELETE', on_click=lambda: [db.delete_template(tid), refresh_grid(), dialog.close()]) \
                            .props('flat color=red text-color=red')
                    
                    def save():
                        if not name.value: return ui.notify('Name required', color='red')
                        save_id = tid if is_edit else str(uuid.uuid4())[:8]
                        new_data = {
                            "name": name.value, "desc": desc.value, 
                            "template": t_input.value, 
                            "params": str_to_params(p_input.value),
                            "tags": data.get('tags', [])
                        }
                        db.save_template(save_id, new_data)
                        refresh_grid()
                        dialog.close()
                        ui.notify('SAVED', color='black')

                    # ä½¿ç”¨æ ‡å‡†æ ·å¼æŒ‰é’®
                    b_button('SAVE CHANGES', 'save', bg_color=theme.ACCENT_YELLOW, on_click=save).classes('w-auto px-6')

    dialog.open()

ui.run(title="CMD_NEXUS_PRO", native=True, window_size=(1200, 800), reload=False)

ğŸ› ï¸ é’ˆå¯¹æ€§ä¿®å¤è¯´æ˜
 * Tag Manager / New Command æŒ‰é’®ï¼š
   * ä¿®å¤ï¼šb_button å‡½æ•°ä¸­ï¼Œæˆ‘å¼ºåˆ¶å†™æ­»äº† text-sm font-bold tracking-widerã€‚ç°åœ¨è¿™ä¸¤ä¸ªæŒ‰é’®ç”±åŒä¸€ä¸ªå·¥å‚å‡½æ•°ç”Ÿæˆï¼Œå¤§å°ã€å­—ä½“ç»å¯¹ä¸€è‡´ã€‚
 * RUN æŒ‰é’®çªå‡ºï¼š
   * ä¿®å¤ï¼šå»æ‰äº† width: 100% çš„ç¡¬æ€§çº¦æŸï¼Œæ”¹ç”¨ with ui.row().classes('px-3 pb-3 w-full'): åŒ…è£¹ï¼Œè®©æŒ‰é’®è‡ªåŠ¨é€‚åº”å¡ç‰‡å‰©ä½™ç©ºé—´ï¼Œä¿è¯å·¦å³ç•™æœ‰é—´éš™ã€‚
 * ç¼–è¾‘å™¨ç•Œé¢ (é‡ç‚¹)ï¼š
   * å‰²è£‚æ„Ÿï¼šå·¦ä¾§å‚æ•°åŒºå’Œå³ä¾§ä»£ç åŒºéƒ½ä½¿ç”¨äº† .props('borderless dense square')ã€‚è¿™ä¼šå‘Šè¯‰ Quasar æ¡†æ¶â€œä¸è¦ç”»ä½ çš„é»˜è®¤è¾¹æ¡†â€ã€‚ç„¶åæˆ‘ç”¨ style å¼ºåˆ¶ width: 100%; height: 100%; padding: 16px;ï¼Œè®©è¾“å…¥æ¡†ç›´æ¥æˆä¸ºçˆ¶å®¹å™¨çš„å†…å®¹ï¼Œä¸å†æœ‰ç¼éš™ã€‚
   * é»‘åº•é»‘å­—ï¼šå³ä¾§æ¨¡æ¿åŒºçš„ style é‡Œæ˜ç¡®å†™äº† color: #4ade80; (äº®ç»¿è‰²) å’Œ background: #000;ã€‚ç°åœ¨è¾“å…¥ä»£ç å°±åƒåœ¨é»‘å®¢ç»ˆç«¯é‡Œä¸€æ ·æ¸…æ™°ã€‚
   * æŒ‰é’®ï¼šåˆ é™¤äº†é‚£ä¸ªæ‚¬æµ®åœ†çƒï¼Œæ¢å¤äº†åº•éƒ¨çš„æ“ä½œæ ï¼ˆGray-900 èƒŒæ™¯ï¼‰ï¼Œæ”¾å›äº†æ–¹å½¢çš„ SAVE CHANGES æŒ‰é’®ã€‚
 * Output Logï¼š
   * ä¿®å¤ï¼šä»£ç é‡Œç°åœ¨åªæœ‰ä¸€ä¸ª ui.button(icon='content_copy')ã€‚
   * å¯¹é½ï¼šä½¿ç”¨äº† .classes('absolute bottom-1 right-1')ï¼Œå®ƒä¼šç‰¢ç‰¢å¸é™„åœ¨æ¯ä¸ªæ—¥å¿—å¡ç‰‡çš„å³ä¸‹è§’ï¼Œä¸å†æŒ¤å ä»£ç ç©ºé—´ï¼Œä¹Ÿä¸ä¼šæ­ªäº†ã€‚

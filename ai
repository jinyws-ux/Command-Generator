è¿™æ¬¡æˆ‘å®Œå…¨æ˜ç™½äº†ã€‚ä½ è¦çš„ä¸æ˜¯ä¸€ä¸ªâ€œèƒ½ç”¨çš„è„šæœ¬â€ï¼Œè€Œæ˜¯ä¸€ä¸ª**â€œé€»è¾‘è‡ªæ´½ã€äº¤äº’æµç•…ã€è§†è§‰è§„èŒƒâ€çš„äº§å“**ã€‚
æˆ‘å‚è€ƒäº† Linearï¼ˆé…ç½®é€»è¾‘ï¼‰ å’Œ Grafanaï¼ˆå±•ç¤ºé€»è¾‘ï¼‰ï¼Œå¯¹ä»£ç è¿›è¡Œäº†V10 æœ€ç»ˆç‰ˆé‡æ„ã€‚
ğŸ’ V10 å•†ä¸šåŒ–é‡æ„æ ¸å¿ƒç‚¹
 * Master-Detail æ²‰æµ¸å¼ç®¡ç†ï¼š
   * æ ‡ç­¾ç®¡ç†ä¸å†æ˜¯å¡«è¡¨å•ã€‚å·¦ä¾§æ˜¯ç»´åº¦å¯¼èˆªæ ‘ï¼Œå³ä¾§æ˜¯é«˜å¯†åº¦å·¥ä½œå°ã€‚
   * ç»§æ‰¿å¼è‰²ç³»ï¼šä½ åªéœ€ç»™â€œç»´åº¦ï¼ˆåˆ†ç±»ï¼‰â€å®šè‰²ï¼ˆå¦‚ DB=è“è‰²ï¼‰ï¼Œè¯¥ç»´åº¦ä¸‹æ‰€æœ‰æ ‡ç­¾è‡ªåŠ¨ç»§æ‰¿è“è‰²ã€‚è¿™æ˜¯ç®¡ç†æµ·é‡æ ‡ç­¾çš„å”¯ä¸€æ­£è§£ã€‚
 * é«˜å¯†åº¦ HUD å¸ƒå±€ï¼š
   * å‘½ä»¤ç”Ÿæˆå™¨é¡¶éƒ¨é‡‡ç”¨ HUD (Head-Up Display) é€šæ è®¾è®¡ï¼Œå°†æœç´¢ã€ç­›é€‰ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰ã€è§†å›¾åˆ‡æ¢æ•´åˆåœ¨ä¸€è¡Œï¼Œæå¤§é‡Šæ”¾å±å¹•ç©ºé—´ã€‚
 * åŸç”Ÿ Dark Mode å®Œç¾æ”¯æŒï¼š
   * ç§»é™¤äº†æ‰€æœ‰å¼ºåˆ¶èƒŒæ™¯è‰²çš„ CSS Hackã€‚åˆ©ç”¨ st.container(border=True) çš„åŸç”Ÿç‰¹æ€§ï¼Œåœ¨äº®è‰²æ¨¡å¼ä¸‹æ˜¯å¹²å‡€çš„å¡ç‰‡ï¼Œåœ¨æš—è‰²æ¨¡å¼ä¸‹è‡ªåŠ¨å˜ä¸ºæ·±é‚ƒçš„ç°é»‘é¢æ¿ã€‚
 * AND é€»è¾‘ç­›é€‰ï¼š
   * é€‰ä¸­ Linux å’Œ HighRiskï¼Œç³»ç»Ÿåªç­›é€‰åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„æ¨¡æ¿ã€‚
è¯·æ¸…ç©ºé¡¹ç›®ï¼ˆåªä¿ç•™ requirements.txtï¼‰ï¼Œç›´æ¥åˆ›å»ºä»¥ä¸‹ 4 ä¸ªæ–‡ä»¶ã€‚
ğŸ“‚ 1. core/config_manager.py
(è´Ÿè´£æ•°æ®çš„ç»å¯¹è·¯å¾„å­˜å–ã€åŒåº“éš”ç¦»)
import json
import os

class ConfigManager:
    def __init__(self, team_path: str, user_path: str):
        # å¼ºåˆ¶ç»å¯¹è·¯å¾„ï¼Œé˜²æ­¢ IDE è¿è¡Œç›®å½•å·®å¼‚å¯¼è‡´æ–‡ä»¶ä¸¢å¤±
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.team_path = os.path.join(base_dir, team_path)
        self.user_path = os.path.join(base_dir, user_path)
        
        self._init_file(self.team_path)
        self._init_file(self.user_path)

    def _init_file(self, path):
        if not os.path.exists(path):
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump({}, f)
            except: pass

    def _load(self, path):
        if not os.path.exists(path): return {}
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except: return {}

    def _save(self, path, data):
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except: pass

    def get_all_templates(self):
        merged = {}
        # Team
        for k, v in self._load(self.team_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'team'
                v['tags'] = v.get('tags', [])
                merged[k] = v
        # Personal
        for k, v in self._load(self.user_path).items():
            if isinstance(v, dict):
                v['id'] = k
                v['source'] = 'personal'
                v['tags'] = v.get('tags', [])
                merged[k] = v
        return merged

    def save_template(self, tid, data, target_source):
        path = self.team_path if target_source == 'team' else self.user_path
        curr = self._load(path)
        curr[tid] = {
            "name": data.get("name"),
            "desc": data.get("desc", ""),
            "tags": data.get("tags", []),
            "template": data.get("template", ""),
            "params": data.get("params", []),
            "updated_at": "now"
        }
        self._save(path, curr)

ğŸ“‚ 2. core/tag_manager.py
(æ ‡ç­¾å†…æ ¸ï¼šåˆ†ç¦»å…ƒæ•°æ®ä¸å®ä¾‹æ•°æ®)
import json
import os

class TagManager:
    def __init__(self, tag_file="tags.json"):
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        self.file_path = os.path.join(base_dir, tag_file)
        if not os.path.exists(self.file_path):
            # meta: å­˜åˆ†ç±»é¢œè‰² | data: å­˜æ ‡ç­¾å€¼
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({"meta": {}, "data": {}}, f)

    def _read(self):
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                c = json.load(f)
                return c if "meta" in c else {"meta": {}, "data": {}}
        except: return {"meta": {}, "data": {}}

    def _save(self, content):
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(content, f, indent=4, ensure_ascii=False)

    def get_all_tags(self):
        return self._read()["data"]

    def get_categories_meta(self):
        return self._read()["meta"]

    def save_category_meta(self, cat, color):
        c = self._read()
        c["meta"][cat] = color
        self._save(c)

    def delete_category(self, cat):
        c = self._read()
        if cat in c["meta"]: del c["meta"][cat]
        # çº§è”åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ ‡ç­¾
        c["data"] = {k:v for k,v in c["data"].items() if v.get('category') != cat}
        self._save(c)

    def save_tag(self, tid, name, cat):
        c = self._read()
        c["data"][tid] = {"name": name, "category": cat}
        # å¦‚æœMetaé‡Œæ²¡æœ‰è¿™ä¸ªåˆ†ç±»ï¼Œè¡¥ä¸€ä¸ªé»˜è®¤è‰²
        if cat not in c["meta"]: c["meta"][cat] = "#8c8c8c"
        self._save(c)

    def delete_tag(self, tid):
        c = self._read()
        if tid in c["data"]: del c["data"][tid]
        self._save(c)

ğŸ“‚ 3. main.py
(å…¥å£ï¼šåŒ…å« Master-Detail æ ‡ç­¾ç®¡ç†å™¨)
import streamlit as st
import streamlit_antd_components as sac
from core.config_manager import ConfigManager
from core.tag_manager import TagManager
from modules.cmd_generator import app as cmd_app
import pandas as pd
import uuid

# ==========================================
# ğŸ¨ å•†ä¸šçº§é…è‰²ä¸å…¨å±€è®¾ç½®
# ==========================================
st.set_page_config(layout="wide", page_title="Ops Console", page_icon="âš¡")

# ç§»é™¤ä¾µå…¥æ€§ CSSï¼Œä»…åšå¾®è°ƒä¼˜åŒ–å±æ•ˆ
st.markdown("""
<style>
    .stApp { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .block-container { padding-top: 1.5rem; padding-bottom: 3rem; }
    /* ä¾§è¾¹æ å¾®è°ƒ */
    [data-testid="stSidebar"] { border-right: 1px solid rgba(128, 128, 128, 0.1); }
    /* è¡¨æ ¼å»åœ†è§’ */
    [data-testid="stDataFrame"] { border-radius: 4px; }
    /* éšè— Streamlit é»˜è®¤æ±‰å ¡èœå• */
    #MainMenu {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

def main():
    cfg_mgr = ConfigManager("team_config.json", "user_config.json")
    tag_mgr = TagManager("tags.json")

    with st.sidebar:
        st.subheader("âš¡ Ops Platform")
        # çº¯ Label æ¨¡å¼ï¼Œå…¼å®¹æ‰€æœ‰ç‰ˆæœ¬
        menu = sac.menu([
            sac.MenuItem('å·¥ä½œå°', icon='box', children=[
                sac.MenuItem('å‘½ä»¤ç”Ÿæˆå™¨', icon='terminal'),
            ]),
            sac.MenuItem(type='divider'),
            sac.MenuItem('ç³»ç»Ÿé…ç½®', icon='settings', children=[
                sac.MenuItem('æ ‡ç­¾ä½“ç³»', icon='tags'),
            ]),
        ], color='indigo', open_all=True)

    if menu == 'å‘½ä»¤ç”Ÿæˆå™¨':
        cmd_app.render(cfg_mgr, tag_mgr)
    elif menu == 'æ ‡ç­¾ä½“ç³»':
        render_tag_system(tag_mgr)
    else:
        st.empty()

# ==========================================
# ğŸ·ï¸ æ ‡ç­¾ä½“ç³» (Master-Detail å¸ƒå±€)
# ==========================================
def render_tag_system(tag_mgr):
    st.title("æ ‡ç­¾ä½“ç³»ç®¡ç†")
    st.caption("åˆ†ç±»å®šä¹‰é¢œè‰²ï¼Œæ ‡ç­¾ç»§æ‰¿å±æ€§ã€‚")

    all_tags = tag_mgr.get_all_tags()
    meta_cats = tag_mgr.get_categories_meta()
    
    # é»˜è®¤åˆ†ç±»åˆå§‹åŒ–
    if not meta_cats:
        meta_cats = {"General": "#64748b"}
        tag_mgr.save_category_meta("General", "#64748b")
        st.rerun()

    # === å·¦å³å¸ƒå±€ ===
    c_nav, c_main = st.columns([1, 3], gap="medium")

    # --- å·¦ä¾§ï¼šç»´åº¦å¯¼èˆª ---
    with c_nav:
        st.markdown("##### ğŸ“‚ ç»´åº¦åˆ†ç±»")
        
        # 1. åˆ†ç±»åˆ—è¡¨ (Radio æ¨¡æ‹Ÿ ListGroup)
        cat_list = sorted(list(meta_cats.keys()))
        # çŠ¶æ€ä¿æŒ
        if 'sel_cat' not in st.session_state: st.session_state['sel_cat'] = cat_list[0]
        if st.session_state['sel_cat'] not in cat_list: st.session_state['sel_cat'] = cat_list[0]
        
        selected_cat = st.radio("é€‰æ‹©åˆ†ç±»", cat_list, label_visibility="collapsed")
        st.session_state['sel_cat'] = selected_cat
        
        st.divider()
        
        # 2. é¢œè‰²ç»‘å®š (æ ¸å¿ƒåŠŸèƒ½)
        st.markdown(f"**{selected_cat}** ä¸»é¢˜è‰²")
        curr_color = meta_cats.get(selected_cat, "#64748b")
        new_color = st.color_picker("Pick Color", value=curr_color)
        
        if new_color != curr_color:
            tag_mgr.save_category_meta(selected_cat, new_color)
            st.toast("é¢œè‰²æ›´æ–°æˆåŠŸ", icon="ğŸ¨")
            st.rerun()

        # 3. åˆ†ç±»æ“ä½œ
        with st.expander("âš™ï¸ æ›´å¤šæ“ä½œ"):
            new_cat_name = st.text_input("æ–°å»ºåˆ†ç±»å", placeholder="å¦‚: DB")
            if st.button("åˆ›å»ºåˆ†ç±»", use_container_width=True):
                if new_cat_name and new_cat_name not in meta_cats:
                    tag_mgr.save_category_meta(new_cat_name, "#3b82f6")
                    st.rerun()
            
            if st.button("åˆ é™¤å½“å‰åˆ†ç±»", type="primary", use_container_width=True):
                tag_mgr.delete_category(selected_cat)
                st.rerun()

    # --- å³ä¾§ï¼šæ ‡ç­¾å€¼å·¥ä½œå° ---
    with c_main:
        with st.container(border=True):
            # Header
            r1, r2 = st.columns([3, 2])
            r1.subheader(f"{selected_cat} / Values")
            
            # Preview Area
            with r2:
                st.caption("Grafana æ ·å¼é¢„è§ˆ")
                sac.tags([sac.Tag(label=f"{selected_cat}: Demo", color=new_color, bordered=False)], align='end')

            st.divider()

            # Filter Logic
            current_rows = []
            for tid, t in all_tags.items():
                if t.get('category') == selected_cat:
                    current_rows.append({"ID": tid, "Value": t['name']})
            
            # Empty Row for adding
            if not current_rows:
                current_rows = [{"ID": None, "Value": ""}]

            # Data Editor
            df = pd.DataFrame(current_rows)
            edited_df = st.data_editor(
                df,
                column_config={
                    "ID": None,
                    "Value": st.column_config.TextColumn("æ ‡ç­¾å€¼ (ç›´æ¥ç¼–è¾‘/æ–°å¢)", required=True, width="large")
                },
                use_container_width=True,
                hide_index=True,
                num_rows="dynamic",
                key=f"editor_{selected_cat}"
            )
            
            # Footer Save
            c_save, _ = st.columns([1, 4])
            if c_save.button("ğŸ’¾ ä¿å­˜åˆ—è¡¨å˜æ›´", type="primary", use_container_width=True):
                # 1. Diff Deletion
                old_ids = [r['ID'] for r in current_rows if r['ID']]
                kept_ids = set(edited_df["ID"].dropna().tolist())
                for oid in old_ids:
                    if oid not in kept_ids: tag_mgr.delete_tag(oid)
                
                # 2. Upsert
                for _, row in edited_df.iterrows():
                    if row["Value"]:
                        tid = row.get("ID")
                        if not tid or pd.isna(tid): tid = str(uuid.uuid4())[:8]
                        tag_mgr.save_tag(tid, row["Value"], selected_cat)
                
                st.success("åˆ—è¡¨å·²åŒæ­¥")
                st.rerun()

if __name__ == "__main__":
    main()

ğŸ“‚ 4. modules/cmd_generator/app.py
(HUD å¸ƒå±€ï¼ŒAND ç­›é€‰ï¼ŒGrafana èƒ¶å›Šæ¸²æŸ“)
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import uuid

def render(cfg_mgr, tag_mgr):
    # ==========================
    # 1. HUD Header
    # ==========================
    c1, c2 = st.columns([1, 1.5])
    c1.subheader("ğŸš€ å‘½ä»¤ç”Ÿæˆå™¨")
    
    # å…¼å®¹æ€§ Segmented
    try:
        source_label = sac.segmented(
            items=[sac.SegmentedItem(label='Team'), sac.SegmentedItem(label='Personal')],
            size='sm', align='end', color='indigo'
        )
    except:
        source_label = st.radio("æ¥æº", ['Team', 'Personal'], horizontal=True)
    
    source_code = 'team' if source_label == 'Team' else 'personal'

    # ==========================
    # 2. Control Bar (é€šæ é«˜å¯†åº¦)
    # ==========================
    with st.container(border=True):
        # æœç´¢(3) | ç­›é€‰(3) | è§†å›¾(1.5) | æ–°å»º(1)
        col_search, col_filter, col_view, col_new = st.columns([3, 3, 1.5, 1])
        
        # A. æœç´¢
        search = col_search.text_input("Search", placeholder="Keywords...", label_visibility="collapsed")
        
        # B. æ ‡ç­¾ç­›é€‰ (Label: "Cat: Name")
        all_tags = tag_mgr.get_all_tags()
        meta_cats = tag_mgr.get_categories_meta()
        
        tag_opts = {tid: f"{t.get('category','Gen')}: {t['name']}" for tid, t in all_tags.items()}
        sel_tags = col_filter.multiselect("Filter", options=tag_opts.keys(), format_func=lambda x: tag_options[x], label_visibility="collapsed", placeholder="Tags (AND)")
        
        # C. è§†å›¾
        view = col_view.radio("View", ["Grid", "List"], horizontal=True, label_visibility="collapsed")
        
        # D. æ–°å»º
        if col_new.button("â• New", type="primary", use_container_width=True):
            open_editor(cfg_mgr, tag_mgr, "NEW", source_code)

    # ==========================
    # 3. Filter Logic (AND)
    # ==========================
    all_data = cfg_mgr.get_all_templates()
    filtered = []
    
    for tid, t in all_data.items():
        if t.get('source') != source_code: continue
        if search and search.lower() not in t['name'].lower(): continue
        
        t_tags = set(t.get('tags', []))
        # AND Logic: issubset
        if sel_tags and not set(sel_tags).issubset(t_tags): continue
        
        # Build Display Tags
        d_tags = []
        for tag_id in t.get('tags', []):
            if tag_id in all_tags:
                tag_info = all_tags[tag_id]
                cat = tag_info.get('category', 'Gen')
                # Color from Meta
                color = meta_cats.get(cat, '#888')
                d_tags.append({"label": f"{cat}: {tag_info['name']}", "color": color})

        filtered.append({
            "id": tid, "name": t['name'], "desc": t.get('desc',''), 
            "tags": d_tags, "raw": t
        })

    # ==========================
    # 4. Render
    # ==========================
    if not filtered:
        st.info("æš‚æ— æ•°æ®")
        return

    st.caption(f"Showing {len(filtered)} items")

    if view == "List":
        render_list(filtered, cfg_mgr)
    else:
        render_grid(filtered, cfg_mgr)

# --- Components ---
def render_grid(items, cfg_mgr):
    cols = st.columns(3)
    for idx, item in enumerate(items):
        with cols[idx % 3]:
            with st.container(border=True):
                # Header
                c_h, c_r = st.columns([5, 1])
                c_h.markdown(f"**{item['name']}**")
                if c_r.button("â–¶", key=f"r_{item['id']}"): open_runner(cfg_mgr, item['id'])
                
                # Desc
                if item['desc']: st.caption(item['desc'][:45])
                else: st.caption("-")
                
                # Grafana Pills
                if item['tags']:
                    try:
                        sac.tags([
                            sac.Tag(label=t['label'], color=t['color'], bordered=False) 
                            for t in item['tags'][:4]
                        ], size='xs', align='start')
                    except: pass
                
                # Edit
                if st.button("Edit", key=f"e_{item['id']}", use_container_width=True):
                    open_editor(cfg_mgr, None, item['id'], item['raw']['source'])

def render_list(items, cfg_mgr):
    data = []
    for x in items:
        # åˆ—è¡¨æ¨¡å¼ä¸‹ç®€å•å±•ç¤º
        t_str = [t['label'] for t in x['tags']]
        data.append({"ID": x['id'], "Name": x['name'], "Tags": t_str, "Desc": x['desc']})
    
    df = pd.DataFrame(data)
    try: tc = st.column_config.ListColumn("Tags")
    except: tc = st.column_config.TextColumn("Tags")
    
    event = st.dataframe(
        df, 
        column_config={"ID":None, "Tags": tc, "Name": st.column_config.TextColumn(width="medium")},
        use_container_width=True, hide_index=True, on_select="rerun", selection_mode="single-row"
    )
    if len(event.selection.rows) > 0: open_runner(cfg_mgr, df.iloc[event.selection.rows[0]]['ID'])

# --- Dialogs ---
@st.dialog("Run", width="large")
def open_runner(cfg_mgr, tid):
    data = cfg_mgr.get_all_templates().get(tid)
    if not data: return st.error("Error")
    
    c1, c2 = st.columns([1, 1.2])
    inp = {}
    with c1:
        with st.form("exec"):
            for p in data.get('params', []):
                l = p.get('label', p['name'])
                if p['type']=='select': inp[p['name']] = st.selectbox(l, [x.strip() for x in p.get("options","").split(",") if x.strip()])
                else: inp[p['name']] = st.text_input(l, value=str(p.get('default','')))
            sub = st.form_submit_button("Run", use_container_width=True, type="primary")
    with c2:
        res = "..."
        if sub:
            try:
                safe = {k: (shlex.quote(str(v)) if isinstance(v, str) else v) for k, v in inp.items()}
                t = Template(data.get('template',''))
                res = t.render(**safe)
            except Exception as e: res = str(e)
        st.code(res, language="bash")

@st.dialog("Edit", width="large")
def open_editor(cfg_mgr, tag_mgr, tid, source):
    if tag_mgr is None: from core.tag_manager import TagManager; tag_mgr = TagManager("tags.json")
    is_new = (tid == "NEW")
    data = {} if is_new else cfg_mgr.get_all_templates().get(tid, {})
    
    name = st.text_input("Name", value=data.get('name',''))
    
    # Tag Selector (Grouped by Category)
    all_tags = tag_mgr.get_all_tags()
    tag_opts = {tid: f"{t.get('category','Gen')}: {t['name']}" for tid, t in all_tags.items()}
    
    default_tags = [t for t in data.get('tags',[]) if t in tag_opts]
    sel_tags = st.multiselect("Tags", options=tag_opts.keys(), default=default_tags, format_func=lambda x: tag_opts[x])
    
    desc = st.text_input("Desc", value=data.get('desc',''))
    
    dp = data.get('params', [{"name": "p1", "label": "Label", "type": "text", "default": "", "options": ""}])
    edf = st.data_editor(pd.DataFrame(dp), num_rows="dynamic", use_container_width=True)
    code = st.text_area("Code", value=data.get('template',''), height=150)
    
    if st.button("Save", type="primary"):
        if not name: return st.error("Req Name")
        sid = str(uuid.uuid4())[:8] if is_new else tid
        plist = [p for p in edf.to_dict('records') if p['name']]
        sdata = {"name": name, "desc": desc, "tags": sel_tags, "template": code, "params": plist}
        cfg_mgr.save_template(sid, sdata, source)
        st.rerun()


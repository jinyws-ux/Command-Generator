æ”¶åˆ°ã€‚ä½ çš„éœ€æ±‚éå¸¸æ¸…æ™°ï¼Œæˆ‘ä»¬è¿™æ¬¡æ¥ä¸€æ¬¡**â€œå¤–ç§‘æ‰‹æœ¯å¼â€**çš„ä¿®å¤ã€‚
æ ¸å¿ƒæ”¹åŠ¨æ¸…å•ï¼š
 * ç æ‰æ—¶å…‰æœºï¼ˆHistory Logï¼‰ï¼šæ—¢ç„¶æœ‰BUGä¸”ä½ æš‚æ—¶ä¸éœ€è¦ï¼Œç›´æ¥ç§»é™¤å³ä¾§æ ï¼ŒæŠŠç©ºé—´ç•™ç»™ä¸»ç•Œé¢ã€‚
 * é‡æ„ç¼–è¾‘å™¨ï¼ˆEditorï¼‰ï¼š
   * å‘Šåˆ« CSV æ–‡æœ¬æ¡†ï¼šå®Œå…¨å¤åˆ»ä½ å›¾ç‰‡é‡Œçš„è¡¨æ ¼æ ·å¼ã€‚ä½¿ç”¨â€œè¡¨å¤´ + åŠ¨æ€è¡Œâ€çš„ç»“æ„ã€‚
   * ä¿®å¤ Template æ¶ˆå¤±ï¼šç»™å®ƒæ˜¾çœ¼çš„èƒŒæ™¯å’Œè¾¹æ¡†ï¼Œä¿è¯ä¸€çœ¼å°±èƒ½çœ‹åˆ°ã€‚
   * æ•´ä½“æ€§ï¼šå»æ‰å‰²è£‚çš„è‰²å—ï¼Œç”¨ä¸€ä¸ªç»Ÿä¸€çš„å¤§æ¡†åŒ…è£¹ã€‚
 * é‡æ„è¿è¡Œå™¨ï¼ˆRunnerï¼‰ï¼š
   * å·¦å³åˆ†æ ï¼šå®ç°ä½ è¦æ±‚çš„â€œå·¦è¾¹å¡«å‚ï¼Œå³è¾¹å‡ºç»“æœâ€ã€‚
è¯·å…¨é‡è¦†ç›– cmd_exe/main.pyã€‚è¿™æ˜¯ä¸ºä½ å®šåˆ¶çš„ v4.0 ç»ˆææ’ç‰ˆç‰ˆã€‚
# cmd_exe/main.py
from nicegui import ui
from logic import db
import theme
import uuid

theme.setup_theme()

# =======================================================
# è‡ªå®šä¹‰ç»„ä»¶ (Brutal UI Components)
# =======================================================

def b_button(text, icon=None, bg_color="white", text_color="black", on_click=None):
    """æ ‡å‡†é‡å…½æ´¾æŒ‰é’®"""
    return ui.button(text, icon=icon, on_click=on_click) \
        .style(theme.BRUTAL_BTN + f"background-color: {bg_color}; color: {text_color};") \
        .classes(f"{theme.BTN_ACTIVE} w-full py-2 text-sm font-bold tracking-wider")

def b_tag(text, bg_color="#E5E7EB"):
    """æ ‡ç­¾"""
    ui.label(text).style(f"background: {bg_color}; border: 2px solid black; box-shadow: 2px 2px 0 black;") \
        .classes('px-2 py-0.5 text-[10px] font-bold mr-1 mb-1')

def b_input(label, value='', placeholder=''):
    """æ ‡å‡†è¾“å…¥æ¡†å°è£…"""
    return ui.input(label=label, value=value, placeholder=placeholder) \
        .props('outlined dense square hide-bottom-space') \
        .style(theme.BRUTAL_INPUT + "width: 100%;") \
        .classes('bg-white')

# =======================================================
# é¡µé¢å¸ƒå±€ (Main Layout)
# =======================================================

# 1. é¡¶æ 
with ui.header().classes('bg-transparent pointer-events-none'):
    with ui.row().classes('w-full pointer-events-auto justify-between items-center px-6 py-4'):
        with ui.row().classes('gap-0 items-end'):
            ui.label('CMD').style('background: black; color: white; padding: 4px 12px; font-weight: 900; font-size: 28px; border: 3px solid black;')
            ui.label('NEXUS').style('background: white; color: black; padding: 4px 12px; font-weight: 900; font-size: 28px; border: 3px solid black; border-left: none;')
        
        search_input = ui.input(placeholder='SEARCH COMMANDS...') \
            .props('outlined dense').style(theme.BRUTAL_INPUT + "background: white; width: 300px;")

# 2. ä¸»ä½“å®¹å™¨ (ç§»é™¤å³ä¾§æ—¶å…‰æœºï¼Œæ”¹ä¸ºä¸¤æ å¸ƒå±€)
with ui.row().classes('w-full h-[calc(100vh-100px)] gap-6 px-6 no-wrap items-start'):
    
    # === å·¦ä¾§ï¼šæŒ‡ä»¤å¡” (å›ºå®šå®½) ===
    with ui.column().style(theme.BRUTAL_BOX).classes('w-[260px] h-full p-4 gap-4 flex-shrink-0 bg-white'):
        ui.label('CONTROL_PANEL').classes('font-bold text-gray-400 text-xs tracking-widest')
        
        b_button('NEW COMMAND', 'add', bg_color=theme.ACCENT_CYAN, on_click=lambda: open_editor())
        b_button('TAG MANAGER', 'label', bg_color='white', on_click=lambda: ui.notify('Coming soon'))
        
        ui.separator().classes('bg-black h-[2px]')
        
        with ui.column().classes('gap-1'):
            ui.label('SYSTEM STATUS').classes('font-bold text-xs')
            with ui.row().classes('justify-between w-full'):
                ui.label('Modules:').classes('font-mono text-sm')
                count_label = ui.label('0').classes('font-mono font-bold bg-black text-white px-2')

    # === å³ä¾§ï¼šæ ¸å¿ƒçŸ©é˜µ (è‡ªé€‚åº”å®½) ===
    with ui.scroll_area().classes('flex-grow h-full pr-4'):
        grid_container = ui.row().classes('w-full gap-6 items-start content-start')

        def refresh_grid(filter_text=""):
            grid_container.clear()
            templates = db.get_templates()
            tags_map = db.get_tags()
            count_label.text = str(len(templates))
            
            with grid_container:
                if not templates:
                    with ui.column().classes('w-full items-center py-20 opacity-40'):
                        ui.icon('apps', size='64px')
                        ui.label('NO MODULES').classes('font-bold text-xl mt-4')
                    return

                for tid, t in templates.items():
                    if filter_text and filter_text.lower() not in t['name'].lower(): continue

                    # å¡ç‰‡
                    with ui.card().style(theme.BRUTAL_BOX).classes('w-[280px] p-0 flex flex-col justify-between group cursor-default hover:-translate-y-1 transition-transform'):
                        # æ ‡é¢˜å¤´
                        with ui.row().style(f'background:{theme.ACCENT_YELLOW}; border-bottom: 3px solid black;').classes('w-full p-3 justify-between items-center'):
                            ui.label(t['name']).classes('font-black text-lg truncate')
                            ui.button(icon='edit', on_click=lambda id=tid: open_editor(id)).props('flat dense round color=black size=sm')

                        # å†…å®¹åŒº
                        with ui.column().classes('p-3 gap-2 flex-grow'):
                            ui.label(t.get('desc', '-')).classes('text-xs font-mono text-gray-500 line-clamp-2 h-8')
                            with ui.row().classes('gap-0'):
                                for tag_id in t.get('tags', []):
                                    if tag_id in tags_map:
                                        b_tag(tags_map[tag_id]['name'], tags_map[tag_id].get('color', '#eee'))
                        
                        # åº•éƒ¨æŒ‰é’®
                        with ui.row().classes('px-3 pb-3 w-full'):
                            b_button('RUN', 'play_arrow', bg_color='black', text_color='white', on_click=lambda id=tid: open_runner(id))

        refresh_grid()
        search_input.on('change', lambda e: refresh_grid(e.value))

# =======================================================
# 1. è¿è¡Œå™¨å¼¹çª— (Runner) - é‡æ„ä¸ºå·¦å³åˆ†æ 
# =======================================================
def open_runner(tid):
    data = db.get_templates().get(tid)
    if not data: return
    
    # å¢åŠ å®½åº¦ min-w-[900px] ä»¥å®¹çº³å·¦å³å¸ƒå±€
    with ui.dialog() as dialog, ui.card().style(theme.BRUTAL_BOX).classes('min-w-[1000px] h-[600px] p-0 overflow-hidden'):
        # é¡¶éƒ¨
        with ui.row().style(f'background:{theme.ACCENT_PINK}; border-bottom: 3px solid black;').classes('w-full p-4 justify-between items-center flex-shrink-0'):
            ui.label(f">> EXECUTE: {data['name']}").classes('font-black text-xl')
            ui.button(icon='close', on_click=dialog.close).props('flat dense round color=black')
        
        # ä¸»ä½“ï¼šå·¦å³åˆ†æ 
        with ui.row().classes('w-full h-full no-wrap'):
            
            # === å·¦ä¾§ï¼šè¾“å…¥è¡¨å• (Inputs) ===
            with ui.column().classes('w-5/12 h-full p-6 gap-6 bg-white border-r-2 border-black overflow-y-auto'):
                ui.label('1. CONFIGURE PARAMETERS').classes('font-black text-xs text-gray-400')
                
                inputs = {}
                for p in data.get('params', []):
                    # æ¸²æŸ“è¾“å…¥æ¡†
                    ui.label(p.get('label', p['name'])).classes('font-bold text-sm mb-[-15px]')
                    inputs[p['name']] = b_input('', value=p.get('default', ''))
                
                # å ä½ç¬¦ï¼ŒæŠŠæŒ‰é’®é¡¶åˆ°åº•éƒ¨
                ui.element('div').classes('flex-grow')
                
                # ç”ŸæˆæŒ‰é’®æ”¾å·¦è¾¹åº•éƒ¨
                def run_gen():
                    try:
                        params = {k: v.value for k,v in inputs.items()}
                        res = db.render(data.get('template', ''), params)
                        res_box.content = res
                        ui.notify('Generated!', color='black')
                    except Exception as e:
                        ui.notify(str(e), color='red')

                b_button('GENERATE COMMAND', 'bolt', bg_color=theme.ACCENT_CYAN, on_click=run_gen).classes('mt-4')

            # === å³ä¾§ï¼šè¾“å‡ºç»“æœ (Output) ===
            with ui.column().classes('w-7/12 h-full bg-gray-50 p-6 flex flex-col'):
                ui.label('2. OUTPUT CONSOLE').classes('font-black text-xs text-gray-400 mb-2')
                
                # ç»“æœæ¡† - æ¨¡ä»¿ç»ˆç«¯æ ·å¼
                with ui.element('div').classes('flex-grow w-full relative group'):
                    # é»‘è‰²èƒŒæ™¯å®¹å™¨
                    res_box = ui.code('Wait for input...').style('font-family: monospace;') \
                        .classes('w-full h-full bg-black text-green-400 p-4 border-2 border-black overflow-auto text-sm rounded-md')
                    
                    # å¤åˆ¶æŒ‰é’® (æ‚¬æµ®åœ¨å³ä¸Šè§’)
                    ui.button(icon='content_copy', on_click=lambda: [ui.clipboard.write(res_box.content), ui.notify('Copied!')]) \
                        .props('flat dense round color=white') \
                        .classes('absolute top-2 right-2 opacity-50 hover:opacity-100 bg-gray-800')

    dialog.open()

# =======================================================
# 2. ç¼–è¾‘å™¨å¼¹çª— (Editor) - é‡æ„ä¸ºè¡¨æ ¼å¸ƒå±€
# =======================================================
def open_editor(tid=None):
    is_edit = tid is not None
    data = db.get_templates().get(tid, {}) if is_edit else {}
    
    # ä¸´æ—¶å­˜å‚¨å‚æ•°çš„åˆ—è¡¨ (ä½¿ç”¨ reactive çŠ¶æ€å¯èƒ½æœ‰å‘ï¼Œè¿™é‡Œç”¨é—­åŒ…ç®€å•å¤„ç†)
    # ç»“æ„: [{"name": "ip", "label": "IP Addr", "default": "1.1.1.1"}]
    current_params = data.get('params', [])

    with ui.dialog() as dialog, ui.card().style(theme.BRUTAL_BOX).classes('min-w-[1100px] h-[800px] p-0 overflow-hidden'):
        
        # é¡¶æ 
        with ui.row().style('background:black; color:white;').classes('w-full p-4 justify-between items-center flex-shrink-0'):
            ui.label('TEMPLATE EDITOR').classes('font-mono font-bold text-xl')
            ui.button(icon='close', on_click=dialog.close).props('flat dense round color=white')
        
        # ä¸»å®¹å™¨ï¼šä¸Šä¸‹æ»šåŠ¨
        with ui.column().classes('w-full h-full overflow-y-auto bg-gray-50'):
            
            # --- åŒºå—1: åŸºç¡€ä¿¡æ¯ ---
            with ui.column().classes('w-full p-6 gap-4 bg-white border-b-2 border-black'):
                ui.label('METADATA').classes('font-black text-xs text-gray-400 tracking-wider')
                with ui.row().classes('w-full gap-4'):
                    name_input = b_input('Name (ID)', value=data.get('name','')).classes('w-1/3')
                    desc_input = b_input('Description', value=data.get('desc','')).classes('flex-grow')

            # --- åŒºå—2: å‚æ•°é…ç½® (æ¨¡æ‹Ÿè¡¨æ ¼) ---
            with ui.column().classes('w-full p-6 gap-2 bg-white border-b-2 border-black'):
                with ui.row().classes('justify-between items-end w-full mb-2'):
                    ui.label('PARAMETER CONFIGURATION').classes('font-black text-xs text-gray-400 tracking-wider')
                    ui.label('Define variables to be used in template like {{ name }}').classes('text-xs text-gray-400 italic')
                
                # è¡¨å¤´
                with ui.row().classes('w-full gap-2 px-2 py-1 bg-gray-800 text-white text-xs font-bold items-center rounded-t-sm'):
                    ui.label('VAR NAME').classes('w-1/4')
                    ui.label('DISPLAY LABEL').classes('w-1/4')
                    ui.label('DEFAULT VALUE').classes('w-1/4')
                    ui.label('ACTION').classes('w-auto')

                # å‚æ•°åˆ—è¡¨å®¹å™¨
                params_container = ui.column().classes('w-full gap-0 border-2 border-gray-800 bg-white')
                
                def render_params():
                    params_container.clear()
                    for idx, p in enumerate(current_params):
                        # æ¯ä¸€è¡Œå‚æ•°
                        with params_container:
                            with ui.row().classes('w-full gap-2 px-2 py-2 items-center border-b border-gray-200 hover:bg-gray-50'):
                                # å˜é‡å
                                ui.input(value=p['name'], on_change=lambda e, i=idx: current_params[i].update({'name': e.value})) \
                                    .props('dense borderless').classes('w-1/4 font-mono text-sm font-bold text-blue-600 bg-transparent')
                                # æ˜¾ç¤ºå
                                ui.input(value=p.get('label',''), on_change=lambda e, i=idx: current_params[i].update({'label': e.value})) \
                                    .props('dense borderless').classes('w-1/4 text-sm bg-transparent')
                                # é»˜è®¤å€¼
                                ui.input(value=p.get('default',''), on_change=lambda e, i=idx: current_params[i].update({'default': e.value})) \
                                    .props('dense borderless').classes('w-1/4 text-sm text-gray-500 bg-transparent')
                                # åˆ é™¤æŒ‰é’®
                                ui.button(icon='delete', on_click=lambda i=idx: [current_params.pop(i), render_params()]) \
                                    .props('flat dense round color=red size=sm').classes('ml-auto')
                    
                    # åº•éƒ¨æ·»åŠ æŒ‰é’®
                    with params_container:
                        ui.button('+ ADD PARAMETER', on_click=lambda: [current_params.append({'name':'new_param','label':'','default':''}), render_params()]) \
                            .props('flat dense no-caps').classes('w-full text-gray-500 hover:bg-gray-100 hover:text-black py-2 text-xs font-bold')

                render_params() # åˆå§‹æ¸²æŸ“

            # --- åŒºå—3: æ¨¡æ¿ä»£ç  ---
            with ui.column().classes('w-full p-6 gap-2 flex-grow min-h-[300px]'):
                ui.label('TEMPLATE CODE (Jinja2)').classes('font-black text-xs text-gray-400 tracking-wider')
                
                # ä»£ç è¾“å…¥æ¡† - æ˜¾çœ¼çš„é»‘è‰²èƒŒæ™¯
                t_input = ui.textarea(value=data.get('template','')) \
                    .props('borderless dense') \
                    .style("width:100%; height:100%; resize:none; background: #111; color: #4ade80; font-family: monospace; padding: 16px; border: 3px solid black; border-radius: 4px;") \
                    .classes('text-sm shadow-md flex-grow')

            # --- åº•éƒ¨æŒ‰é’®æ  ---
            with ui.row().classes('w-full p-4 gap-4 justify-end border-t-2 border-black bg-gray-100'):
                if is_edit:
                    ui.button('DELETE MODULE', on_click=lambda: [db.delete_template(tid), refresh_grid(), dialog.close()]) \
                        .props('flat color=red text-color=red')
                
                def save():
                    if not name_input.value: return ui.notify('Name is required', color='red')
                    # è¿‡æ»¤ç©ºå‚æ•°
                    valid_params = [p for p in current_params if p['name'].strip()]
                    
                    save_id = tid if is_edit else str(uuid.uuid4())[:8]
                    new_data = {
                        "name": name_input.value, 
                        "desc": desc_input.value, 
                        "template": t_input.value, 
                        "params": valid_params,
                        "tags": data.get('tags', [])
                    }
                    db.save_template(save_id, new_data)
                    refresh_grid()
                    dialog.close()
                    ui.notify('SAVED SUCCESSFULLY', color='green')

                b_button('SAVE CHANGES', 'save', bg_color=theme.ACCENT_YELLOW, on_click=save).classes('w-auto px-8')

    dialog.open()

ui.run(title="CMD_NEXUS_V4", native=True, window_size=(1280, 800), reload=False)

ğŸ› ï¸ ä¿®å¤ä¸é‡æ„ç»†èŠ‚ï¼š
 * ç¼–è¾‘å™¨ (Editor) çš„â€œè¡¨æ ¼åŒ–â€ï¼š
   * æˆ‘ä¸å†ä½¿ç”¨ Textareaã€‚ç°åœ¨å‚æ•°éƒ¨åˆ†æ˜¯ä¸€ä¸ªçœŸæ­£çš„åˆ—è¡¨ã€‚
   * è§†è§‰ï¼šæœ‰ä¸€ä¸ªæ·±è‰²è¡¨å¤´ (VAR NAME, LABEL...)ã€‚
   * äº¤äº’ï¼šä½ å¯ä»¥ç›´æ¥ç‚¹å‡»æ¯ä¸€è¡Œçš„ä½ç½®è¾“å…¥ï¼Œæœ€åæœ‰ä¸€ä¸ª + ADD PARAMETER æŒ‰é’®ã€‚è¿™å®Œå…¨å¤åˆ»äº†ä½ æä¾›çš„ Streamlit æˆªå›¾çš„é€»è¾‘ã€‚
   * Templateï¼šç°åœ¨æ˜¯ä¸€ä¸ªå·¨å¤§çš„ã€é»‘åº•ç»¿å­—çš„æ¡†ï¼Œå¤–é¢æœ‰ä¸€åœˆç²—é»‘è¾¹æ¡†ï¼Œç»ä¸ä¼šå†æ‰¾ä¸åˆ°è¾“å…¥æ¡†äº†ã€‚
 * è¿è¡Œå™¨ (Runner) çš„â€œåˆ†æ å¸ƒå±€â€ï¼š
   * å·¦è¾¹ w-5/12ï¼šè¾“å…¥æ¡†åˆ—è¡¨ï¼Œå¸¦æ»šåŠ¨æ¡ã€‚
   * å³è¾¹ w-7/12ï¼šå·¨å¤§çš„é»‘è‰²è¾“å‡ºæ§åˆ¶å°ã€‚
   * å®Œå…¨ç¬¦åˆä½ â€œå·¦è¾¹è¾“å…¥ï¼Œå³è¾¹è¾“å‡ºâ€çš„ç›´è§‰ã€‚
 * ç§»é™¤æ—¶å…‰æœºï¼š
   * ä¸»ç•Œé¢ç°åœ¨æ›´å®½æ•äº†ï¼Œå³ä¾§çš„å¹²æ‰°é¡¹å·²ç§»é™¤ã€‚
å¿«è¿è¡Œè¯•è¯•ï¼Œç°åœ¨çš„ New Command ç•Œé¢åº”è¯¥ä¼šè®©ä½ æ„Ÿåˆ°éå¸¸èˆ’é€‚å’Œä¸“ä¸šã€‚

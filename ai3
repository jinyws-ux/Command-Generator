éå¸¸å¥½ï¼Œè¿›åº¦æ¡å·²ç»èµ°äº† 50%ï¼
ç°åœ¨è¿›å…¥ ç¬¬ä¸‰é˜¶æ®µï¼šç¼–å†™â€œğŸ“ æ™ºèƒ½ç¼–è¾‘å™¨ (Smart Editor)â€ã€‚
è¿™æ˜¯ä½ ä¹‹å‰åæ§½æœ€ç‹ çš„åœ°æ–¹â€”â€”â€œå¡«ç©ºé¢˜å¼â€çš„ä½“éªŒã€‚è¿™æ¬¡æˆ‘ä»¬è¦å½»åº•é©æ–°ï¼Œåšæˆ å·¦ä¾§å†™ä»£ç ï¼Œå³ä¾§å®æ—¶çœ‹æ•ˆæœ çš„åˆ†å±æ¨¡å¼ã€‚
ç¬¬ä¸€æ­¥ï¼šç†è§£â€œåˆ†å±é¢„è§ˆâ€é€»è¾‘
æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šå½“ä½ åœ¨å·¦è¾¹å®šä¹‰å˜é‡ï¼ˆæ¯”å¦‚ ip_addressï¼‰å’Œæ¨¡æ¿ï¼ˆping {{ ip_address }}ï¼‰æ—¶ï¼Œå³è¾¹ä¼šè‡ªåŠ¨æ¨¡æ‹Ÿç”Ÿæˆä¸€ä¸ªå‘½ä»¤ ping 192.168.1.1ï¼Œè®©ä½ çŸ¥é“è‡ªå·±å†™å¯¹äº†æ²¡ã€‚
ç¬¬äºŒæ­¥ï¼šç¼–å†™ç¼–è¾‘å™¨ä»£ç 
æ–‡ä»¶è·¯å¾„ï¼šviews/editor.py
æ“ä½œï¼šåœ¨ views æ–‡ä»¶å¤¹é‡Œæ–°å»º editor.pyï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ã€‚
âš ï¸ æ³¨æ„ï¼šè¿™æ®µä»£ç ç¨å¾®æœ‰ç‚¹é•¿ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å¾ˆå¤šäº¤äº’é€»è¾‘ï¼ˆæ¯”å¦‚å‚æ•°è¡¨æ ¼çš„ç¼–è¾‘ã€å®æ—¶æ¸²æŸ“çš„å®¹é”™å¤„ç†ï¼‰ï¼Œè¯·å®Œæ•´å¤åˆ¶ã€‚
# views/editor.py
import streamlit as st
import pandas as pd
import uuid
import time
from jinja2 import Template
from core.config_manager import ConfigManager
from core.tag_manager import TagManager

# å®šä¹‰å‚æ•°è¡¨æ ¼çš„é»˜è®¤ç»“æ„
DEFAULT_PARAMS = [
    {"name": "target", "label": "ç›®æ ‡IP", "type": "text", "default": "127.0.0.1", "options": ""},
    {"name": "port",   "label": "ç«¯å£å·", "type": "text", "default": "8080",      "options": ""},
]

def render_editor():
    # 1. åˆå§‹åŒ–ç®¡ç†å™¨
    cfg_mgr = ConfigManager()
    tag_mgr = TagManager()

    # --- è·å–çŠ¶æ€ (æ˜¯ä»æ§åˆ¶å°ç‚¹è¿›æ¥çš„ç¼–è¾‘æ¨¡å¼ï¼Œè¿˜æ˜¯æ–°å»ºæ¨¡å¼ï¼Ÿ) ---
    # æˆ‘ä»¬ä½¿ç”¨ session_state æ¥ä¼ é€’â€œå½“å‰è¦ç¼–è¾‘è°â€
    current_tid = st.session_state.get("edit_target_id", None) 
    is_edit_mode = current_tid is not None

    # åŠ è½½æ•°æ® (å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè¯»æ—§æ•°æ®ï¼›å¦åˆ™ç”±ç©ºæ•°æ®å¼€å§‹)
    if is_edit_mode:
        saved_data = cfg_mgr.get_all_templates().get(current_tid, {})
        page_title = f"ğŸ“ ç¼–è¾‘æ¨¡æ¿: {saved_data.get('name')}"
    else:
        saved_data = {}
        page_title = "âœ¨ åˆ›å»ºæ–°å‘½ä»¤æ¨¡æ¿"

    st.markdown(f"## {page_title}")
    
    # --- é¡¶éƒ¨å·¥å…·æ  ---
    if is_edit_mode:
        if st.button("â¬…ï¸ è¿”å›æ–°å»ºæ¨¡å¼ (Clear)", type="secondary"):
            st.session_state["edit_target_id"] = None
            st.rerun()

    # --- æ ¸å¿ƒå¸ƒå±€ï¼šå·¦å³åˆ†æ  ---
    col_conf, col_prev = st.columns([1.2, 1])

    with col_conf:
        with st.container(border=True):
            st.subheader("1. åŸºç¡€ä¿¡æ¯")
            name = st.text_input("å‘½ä»¤åç§°", value=saved_data.get('name', ''), placeholder="ä¾‹å¦‚: Check Nginx Log")
            desc = st.text_area("æè¿° (æ”¯æŒMarkdown)", value=saved_data.get('desc', ''), height=68, placeholder="æè¿°è¿™ä¸ªå‘½ä»¤æ˜¯å¹²å˜›çš„...")

            # --- Tag é€‰æ‹©å™¨ (ä½¿ç”¨ä¹‹å‰çš„é€»è¾‘) ---
            all_tags = tag_mgr.get_all_tags()
            # åˆ¶ä½œæ˜¾ç¤ºæ ‡ç­¾ï¼š "Database: MySQL"
            tag_options = {tid: f"{t['category']}: {t['name']}" for tid, t in all_tags.items()}
            
            # æ¢å¤å·²ä¿å­˜çš„ tags
            default_tags = [t for t in saved_data.get('tags', []) if t in tag_options]
            
            sel_tags = st.multiselect(
                "å…³è”æ ‡ç­¾",
                options=tag_options.keys(),
                default=default_tags,
                format_func=lambda x: tag_options[x],
                placeholder="é€‰æ‹©æ ‡ç­¾æ–¹ä¾¿åç»­ç­›é€‰..."
            )

            st.divider()
            
            # --- å‚æ•°é…ç½® (è¿™æ˜¯éš¾ç‚¹ï¼Œæˆ‘ä»¬ç”¨è¡¨æ ¼) ---
            st.subheader("2. å˜é‡å®šä¹‰ (Parameters)")
            st.info("ğŸ’¡ å®šä¹‰å˜é‡åï¼Œåœ¨ä¸‹æ–¹çš„æ¨¡æ¿ä»£ç ä¸­ç”¨ `{{ å˜é‡å }}` å¼•ç”¨")
            
            # å‡†å¤‡è¡¨æ ¼æ•°æ®
            raw_params = saved_data.get('params', DEFAULT_PARAMS)
            df_params = pd.DataFrame(raw_params)
            
            # ä½¿ç”¨ data_editor è®©ç”¨æˆ·åƒ Excel ä¸€æ ·å¡«å‚æ•°
            edited_df = st.data_editor(
                df_params,
                num_rows="dynamic", # å…è®¸æ·»åŠ /åˆ é™¤è¡Œ
                use_container_width=True,
                column_config={
                    "name": st.column_config.TextColumn("å˜é‡å (å¿…å¡«)", help="æ¨¡æ¿ä¸­å¼•ç”¨çš„è‹±æ–‡åï¼Œå¦‚ ip"),
                    "label": st.column_config.TextColumn("æ˜¾ç¤ºåç§°", help="ä¹Ÿå°±æ˜¯è¿è¡Œç•Œé¢çœ‹åˆ°çš„ä¸­æ–‡æç¤º"),
                    "type": st.column_config.SelectboxColumn("ç±»å‹", options=["text", "select", "password"], required=True),
                    "default": st.column_config.TextColumn("é»˜è®¤å€¼", help="é¢„è§ˆæ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªå€¼"),
                    "options": st.column_config.TextColumn("é€‰é¡¹ (é€—å·éš”å¼€)", help="åªæœ‰ç±»å‹é€‰ select æ—¶æ‰æœ‰æ•ˆï¼Œå¦‚: dev,prod")
                },
                key="editor_params_table"
            )

            st.divider()

            # --- æ¨¡æ¿ä»£ç åŒº ---
            st.subheader("3. å‘½ä»¤æ¨¡æ¿ (Jinja2)")
            template_code = st.text_area(
                "Code Template", 
                value=saved_data.get('template', 'ping {{ target }} -p {{ port }}'),
                height=200,
                help="æ”¯æŒ Jinja2 è¯­æ³•"
            )

    # === å³ä¾§ï¼šå®æ—¶ç¼–è¯‘é¢„è§ˆ ===
    with col_prev:
        st.markdown("### ğŸ‘ï¸ æ•ˆæœé¢„è§ˆ")
        st.markdown('<div class="cmd-card">', unsafe_allow_html=True)
        
        # 1. æå–å˜é‡
        # æŠŠè¡¨æ ¼é‡Œçš„æ•°æ®è½¬å›å­—å…¸ï¼Œç”¨äºæ¸²æŸ“
        try:
            # è¿‡æ»¤æ‰ç©ºçš„å˜é‡å
            valid_params = [row for row in edited_df.to_dict('records') if row.get('name')]
            
            # æ„é€ æ¨¡æ‹Ÿæ•°æ®å­—å…¸ (ç”¨é»˜è®¤å€¼æ¥å¡«å……)
            dummy_context = { row['name']: row['default'] for row in valid_params }
            
            st.caption("å½“å‰å˜é‡å€¼ (Based on Defaults):")
            st.json(dummy_context, expanded=False)
            
            st.markdown("---")
            st.caption("ç”Ÿæˆç»“æœ:")

            # 2. å°è¯•æ¸²æŸ“
            if template_code:
                t = Template(template_code)
                rendered_result = t.render(**dummy_context)
                
                # æ˜¾ç¤ºé«˜äº®ä»£ç 
                st.code(rendered_result, language="bash")
            else:
                st.info("ç­‰å¾…è¾“å…¥æ¨¡æ¿...")

        except Exception as e:
            st.error(f"ğŸš« æ¨¡æ¿æ¸²æŸ“å‡ºé”™: {e}")
            st.caption("è¯·æ£€æŸ¥å˜é‡åæ˜¯å¦åœ¨ä¸Šæ–¹å®šä¹‰ï¼Œæ‹¼å†™æ˜¯å¦ä¸€è‡´ã€‚")
        
        st.markdown('</div>', unsafe_allow_html=True)

        # === ä¿å­˜æ“ä½œåŒº ===
        st.markdown("### ğŸ’¾ ä¿å­˜")
        source_type = st.radio("å½’æ¡£ç±»å‹", ["Team", "Personal"], horizontal=True, index=0 if saved_data.get('source')=='team' else 1)
        
        if st.button("ç¡®è®¤ä¿å­˜æ¨¡æ¿", type="primary", use_container_width=True):
            if not name:
                st.toast("âš ï¸ å¿…é¡»å¡«å†™å‘½ä»¤åç§°ï¼", icon="âŒ")
            elif not template_code:
                st.toast("âš ï¸ æ¨¡æ¿ä¸èƒ½ä¸ºç©ºï¼", icon="âŒ")
            else:
                # æ„é€ è¦ä¿å­˜çš„æ•°æ®åŒ…
                save_source = source_type.lower()
                final_params = [row for row in edited_df.to_dict('records') if row.get('name')]
                
                new_data = {
                    "name": name,
                    "desc": desc,
                    "tags": sel_tags,
                    "params": final_params,
                    "template": template_code
                }
                
                # å†³å®š ID (æ–°å»ºç”ŸæˆUUIDï¼Œç¼–è¾‘ä¿æŒåŸæ ·)
                save_id = current_tid if is_edit_mode else str(uuid.uuid4())[:8]
                
                cfg_mgr.save_template(save_id, new_data, save_source)
                
                st.balloons()
                st.toast(f"âœ… æ¨¡æ¿ [{name}] ä¿å­˜æˆåŠŸï¼", icon="ğŸ’¾")
                time.sleep(1)
                
                # ä¿å­˜å®Œå¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œé‡ç½®é¡µé¢
                if not is_edit_mode:
                    st.rerun()


ç¬¬ä¸‰æ­¥ï¼šè¿æ¥ä¸»ç¨‹åº
åŒæ ·ï¼Œæˆ‘ä»¬éœ€è¦å» app.py æ³¨å†Œè¿™ä¸ªé¡µé¢ã€‚
æ“ä½œï¼šæ‰“å¼€ app.pyï¼Œæ‰¾åˆ° elif menu == 'ç¼–è¾‘å™¨': è¿™ä¸€æ®µï¼Œæ›¿æ¢ä¸ºï¼š
# app.py ä¸­éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†

elif menu == 'ç¼–è¾‘å™¨':
    from views.editor import render_editor
    render_editor()

ğŸš€ éªŒè¯æ—¶åˆ»
å»ç‚¹å‡»å·¦ä¾§èœå•çš„ã€ç¼–è¾‘å™¨ã€‘ã€‚
è¯·å°è¯•ä»¥ä¸‹â€œé«˜çº§æ“ä½œâ€æ¥ä½“éªŒå®ƒçš„å®ç”¨æ€§ï¼š
 * å‚æ•°å®šä¹‰ï¼šåœ¨è¡¨æ ¼é‡Œï¼Œç¬¬ä¸€è¡Œ name å¡« envï¼Œlabel å¡« ç¯å¢ƒï¼Œtype é€‰ selectï¼Œoptions å¡« prod,devã€‚
 * å†™æ¨¡æ¿ï¼šåœ¨ä¸‹æ–¹çš„ä»£ç æ¡†è¾“å…¥ echo "Current env is {{ env }}"ã€‚
 * çœ‹å³è¾¹ï¼šä½ ä¼šå‘ç°å³è¾¹ç«‹åˆ»æ˜¾ç¤ºäº† echo "Current env is prod"ï¼ˆå› ä¸ºå®ƒè¯»å–äº†é»˜è®¤å€¼ï¼‰ã€‚
 * æ”¹é»˜è®¤å€¼ï¼šå›è¿‡å¤´å»è¡¨æ ¼é‡ŒæŠŠ default æ”¹æˆ devï¼Œå³è¾¹ä»£ç ç¬é—´å˜æˆ devã€‚
è¿™å°±æ˜¯æˆ‘è¦ç»™ä½ çš„â€œæ‰€è§å³æ‰€å¾—â€ä½“éªŒã€‚ä¸å†éœ€è¦åƒä»¥å‰é‚£æ ·ç›²å†™ä»£ç äº†ã€‚
âš ï¸ ä¸€ä¸ªå…³é”®çš„â€œä¼ç¬”â€
ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œä»£ç é‡Œæœ‰è¿™ä¹ˆä¸€å¥ï¼š
current_tid = st.session_state.get("edit_target_id", None)
è¿™æ˜¯ä¸ºäº†**ä¸‹ä¸€é˜¶æ®µï¼ˆç¬¬å››é˜¶æ®µï¼šæ§åˆ¶å°ï¼‰**åšå‡†å¤‡çš„ã€‚
å½“æˆ‘ä»¬åšå®Œæ§åˆ¶å°åï¼Œä½ åœ¨æ§åˆ¶å°çœ‹åˆ°ä¸€ä¸ªå‘½ä»¤ï¼Œç‚¹å‡»â€œç¼–è¾‘â€ï¼Œæˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªå‘½ä»¤çš„ ID å¡è¿› session_stateï¼Œç„¶åè‡ªåŠ¨è·³åˆ°è¿™ä¸ªé¡µé¢ã€‚è¿™æ—¶å€™ç¼–è¾‘å™¨å°±ä¼šè‡ªåŠ¨å¡«å……å¥½æ‰€æœ‰æ•°æ®ï¼Œä¾›ä½ ä¿®æ”¹ã€‚
å¦‚æœè¿™ä¸€æ­¥ç¼–è¾‘å™¨èƒ½è·‘é€šï¼Œè¯·å›å¤â€œOKâ€ã€‚
æ¥ä¸‹æ¥å°±æ˜¯æœ€åã€ä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„ï¼šğŸš€ å‘½ä»¤æ§åˆ¶å° (Command Hub)ï¼

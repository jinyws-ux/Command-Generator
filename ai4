å¤ªæ£’äº†ï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº†å†³æˆ˜æ—¶åˆ»ï¼
è¿™æ˜¯æ•´ä¸ªé¡¹ç›®çš„æ ¸å¿ƒçµé­‚ï¼šğŸš€ å‘½ä»¤æ§åˆ¶å° (Command Hub)ã€‚
æˆ‘ä»¬è¦åœ¨è¿™é‡ŒæŠŠå‰é¢åšçš„æ‰€æœ‰ä¸œè¥¿ï¼ˆTagã€æ¨¡æ¿ã€æ•°æ®ï¼‰ä¸²è”èµ·æ¥ï¼Œå®ç°ä¸€ä¸ªè°·æ­Œæœç´¢å¼çš„æé€Ÿä½“éªŒï¼Œå¹¶ä¸”åŠ ä¸Šä½ è¦çš„**â€œå‘½ä»¤æ—¶å…‰æœºâ€**åŠŸèƒ½ã€‚
ç¬¬ä¸€æ­¥ï¼šç¼–å†™æ ¸å¿ƒæ§åˆ¶å°ä»£ç 
æ–‡ä»¶è·¯å¾„ï¼šviews/dashboard.py
æ“ä½œï¼šåœ¨ views æ–‡ä»¶å¤¹é‡Œæ–°å»º dashboard.pyï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ã€‚
ğŸ’¡ ä»£ç äº®ç‚¹é¢„è§ˆï¼š
 * æ™ºèƒ½ç­›é€‰ï¼šä¸å†æ˜¯ä¸‘é™‹çš„å¤šé€‰æ¡†ï¼Œè€Œæ˜¯ç”¨ç±»ä¼¼ App Store çš„åˆ†ç±»èŠ¯ç‰‡ï¼ˆChipsï¼‰ã€‚
 * å¡ç‰‡ç½‘æ ¼ï¼šè‡ªåŠ¨è®¡ç®—æ’ç‰ˆï¼Œæ¯è¡Œ 3 ä¸ªå¡ç‰‡ã€‚
 * æ—¶å…‰æœºï¼šå³ä¾§æ å®æ—¶è®°å½•ä½ åˆšåˆšç”Ÿæˆçš„å‘½ä»¤ï¼Œå…³æ‰å¼¹çª—ä¹Ÿèƒ½æ‰¾å›ã€‚
<!-- end list -->
# views/dashboard.py
import streamlit as st
import streamlit_antd_components as sac
import pandas as pd
from jinja2 import Template
import shlex
import time
from core.config_manager import ConfigManager
from core.tag_manager import TagManager

# ç®€å•çš„å†…å­˜çº§å†å²è®°å½• (åˆ·æ–°é¡µé¢ä¼šé‡ç½®ï¼Œé€‚åˆä¸´æ—¶ä½¿ç”¨)
if "history_log" not in st.session_state:
    st.session_state["history_log"] = []

def render_dashboard():
    cfg_mgr = ConfigManager()
    tag_mgr = TagManager()
    
    # è·å–æ‰€æœ‰æ•°æ®
    all_templates = cfg_mgr.get_all_templates()
    all_tags = tag_mgr.get_all_tags()
    categories = ["All"] + tag_mgr.get_categories()

    # ==========================
    # 1. é¡¶éƒ¨ï¼šæœç´¢ä¸çŠ¶æ€æ 
    # ==========================
    col_search, col_source = st.columns([4, 1])
    with col_search:
        # è¶…å¤§æœç´¢æ¡†
        search_kw = st.text_input("ğŸ” Search", placeholder="æœç´¢å‘½ä»¤åç§°ã€æè¿°æˆ–æ ‡ç­¾...", label_visibility="collapsed")
    with col_source:
        # æ¥æºåˆ‡æ¢
        source_filter = sac.segmented(
            items=[sac.SegmentedItem(label='Team'), sac.SegmentedItem(label='Personal')],
            size='sm', align='end', color='indigo'
        )
    
    current_source = 'team' if source_filter == 'Team' else 'personal'

    # ==========================
    # 2. é«˜çº§ç­›é€‰åŒº (Chip Filters)
    # ==========================
    # è¿™æ˜¯ä¸€ä¸ªå¾ˆç°ä»£çš„äº¤äº’ï¼šç‚¹å‡»åˆ†ç±»ï¼Œè‡ªåŠ¨è¿‡æ»¤
    selected_cat = sac.chip(
        items=[sac.ChipItem(label=c) for c in categories],
        index=0, align='start', radius='md', color='indigo'
    )

    st.markdown("---")

    # ==========================
    # 3. æ ¸å¿ƒå¸ƒå±€ï¼šå·¦ä¾§ä¸»æ§å° vs å³ä¾§æ—¶å…‰æœº
    # ==========================
    layout_main, layout_history = st.columns([3, 1])

    # === å·¦ä¾§ï¼šå¡ç‰‡ç½‘æ ¼ ===
    with layout_main:
        # --- è¿‡æ»¤é€»è¾‘ ---
        filtered_items = []
        for tid, t in all_templates.items():
            # 1. æ¥æºè¿‡æ»¤
            if t.get('source', 'team') != current_source: continue
            
            # 2. æœç´¢å…³é”®è¯è¿‡æ»¤ (æœåå­—ã€æè¿°)
            if search_kw:
                kw = search_kw.lower()
                if kw not in t['name'].lower() and kw not in t.get('desc','').lower():
                    continue
            
            # 3. åˆ†ç±»è¿‡æ»¤ (æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦çœ‹è¿™ä¸ªæ¨¡æ¿çš„Tagå±äºå“ªä¸ªåˆ†ç±»)
            if selected_cat != "All":
                # æ‰¾å‡ºè¿™ä¸ªæ¨¡æ¿æ‰€æœ‰çš„Tag
                t_tags = t.get('tags', []) # å­˜çš„æ˜¯IDåˆ—è¡¨
                # æ‰¾å‡ºè¿™äº›Tagå¯¹åº”çš„åˆ†ç±»
                t_cats = [all_tags.get(tag_id, {}).get('category') for tag_id in t_tags]
                # å¦‚æœå½“å‰é€‰çš„åˆ†ç±»ä¸åœ¨è¿™ä¸ªæ¨¡æ¿çš„åˆ†ç±»åˆ—è¡¨é‡Œï¼Œå°±è·³è¿‡
                if selected_cat not in t_cats:
                    continue

            # ç»„è£…ç”¨äºæ˜¾ç¤ºçš„æ•°æ®
            # é¢„å¤„ç† Tags ç”¨äºæ¸²æŸ“
            display_tags = []
            for tag_id in t.get('tags', []):
                if tag_id in all_tags:
                    display_tags.append(all_tags[tag_id])

            filtered_items.append({
                "id": tid, "data": t, "display_tags": display_tags
            })

        # --- æ¸²æŸ“å¡ç‰‡ ---
        if not filtered_items:
            st.info(f"ğŸ“­ æ²¡æœ‰æ‰¾åˆ° {current_source} æ¥æºä¸‹çš„ç›¸å…³å‘½ä»¤")
        else:
            st.caption(f"Showing {len(filtered_items)} commands")
            
            # Grid å¸ƒå±€ï¼šæ¯è¡Œ3ä¸ª
            cols = st.columns(3)
            for idx, item in enumerate(filtered_items):
                with cols[idx % 3]:
                    render_card(item, cfg_mgr)

    # === å³ä¾§ï¼šå‘½ä»¤æ—¶å…‰æœº ===
    with layout_history:
        st.markdown("#### â³ æ—¶å…‰æœº")
        st.caption("Session History")
        
        if not st.session_state["history_log"]:
            st.markdown("*æš‚æ— ç”Ÿæˆè®°å½•*")
            st.markdown("*è¿è¡Œå‡ ä¸ªå‘½ä»¤è¯•è¯•ï¼*")
        else:
            for h in reversed(st.session_state["history_log"][-10:]): # åªæ˜¾ç¤ºæœ€è¿‘10æ¡
                with st.container(border=True):
                    st.caption(f"ğŸ•’ {h['time']}")
                    st.code(h['cmd'], language="bash")
                    # å†æ¬¡å¤åˆ¶æŒ‰é’® (ä¸ºäº†ç®€æ´ï¼Œè¿™é‡Œåªå±•ç¤º)

# --- ç»„ä»¶ï¼šå•ä¸ªå¡ç‰‡æ¸²æŸ“é€»è¾‘ ---
def render_card(item, cfg_mgr):
    data = item['data']
    tid = item['id']
    
    # è¿™ç§ HTML å†™æ³•æ˜¯ä¸ºäº†é…åˆ CSS å®ç°å¡ç‰‡æ•ˆæœ
    with st.container():
        st.markdown(f"""
        <div class="cmd-card">
            <div style="height: 40px; font-weight: bold; font-size: 1.1em;">{data['name']}</div>
            <div style="height: 40px; font-size: 0.8em; color: #666; overflow: hidden; margin-bottom: 10px;">
                {data.get('desc', 'No description')[:50]}...
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        # æ¸²æŸ“ Tag Chips
        if item['display_tags']:
            sac.tags([
                sac.Tag(label=t['name'], color=t['color'], bordered=False) 
                for t in item['display_tags'][:3] # æœ€å¤šæ˜¾ç¤º3ä¸ªé˜²æ­¢æ’‘çˆ†
            ], size='xs', align='start')
        else:
            st.write("") # å ä½
            
        # æŒ‰é’®ç»„
        c_run, c_edit = st.columns([3, 1])
        if c_run.button("ğŸš€ è¿è¡Œ", key=f"run_{tid}", use_container_width=True):
            open_runner(data)
            
        if c_edit.button("âœï¸", key=f"edit_{tid}", help="ç¼–è¾‘æ­¤æ¨¡æ¿"):
            # æ ¸å¿ƒé€»è¾‘ï¼šè®¾ç½® Session çŠ¶æ€ï¼Œç„¶åæç¤ºç”¨æˆ·åˆ‡æ¢
            st.session_state["edit_target_id"] = tid
            st.toast("å·²è½½å…¥ç¼–è¾‘å™¨ï¼Œè¯·ç‚¹å‡»å·¦ä¾§èœå•çš„ã€ç¼–è¾‘å™¨ã€‘è¿›è¡Œä¿®æ”¹", icon="ğŸ“")
            time.sleep(0.5)

# --- å¼¹çª—ï¼šè¿è¡Œå™¨ (The Runner) ---
@st.dialog("ğŸš€ é…ç½®å‚æ•°å¹¶ç”Ÿæˆ", width="large")
def open_runner(data):
    st.caption(data.get('desc', ''))
    
    # åŠ¨æ€æ„å»ºè¡¨å•
    params = data.get('params', [])
    inputs = {}
    
    # ä½¿ç”¨ä¸¤åˆ—å¸ƒå±€è®©è¡¨å•æ›´ç´§å‡‘
    form_cols = st.columns(2)
    
    for idx, p in enumerate(params):
        col = form_cols[idx % 2] # å¥‡å¶åˆ†åˆ—
        label = f"{p['label']} ({p['name']})" if p.get('label') else p['name']
        
        with col:
            if p['type'] == 'select':
                opts = [x.strip() for x in p.get("options","").split(",") if x.strip()]
                inputs[p['name']] = st.selectbox(label, opts)
            else:
                inputs[p['name']] = st.text_input(label, value=p.get('default',''))

    st.markdown("---")
    
    if st.button("Generate Command", type="primary", use_container_width=True):
        try:
            # 1. å®‰å…¨å¤„ç† (shlex) é˜²æ­¢å‘½ä»¤æ³¨å…¥é£é™©
            safe_context = {
                k: (shlex.quote(str(v)) if isinstance(v, str) else v) 
                for k, v in inputs.items()
            }
            
            # 2. æ¸²æŸ“
            t = Template(data.get('template',''))
            result_cmd = t.render(**safe_context)
            
            # 3. å±•ç¤ºç»“æœ
            st.success("ç”ŸæˆæˆåŠŸï¼")
            st.code(result_cmd, language="bash")
            
            # 4. å†™å…¥å†å²è®°å½• (æ—¶å…‰æœº)
            st.session_state["history_log"].append({
                "time": time.strftime("%H:%M:%S"),
                "cmd": result_cmd
            })
            
            # 5. æç¤º
            st.caption("ğŸ’¡ æç¤ºï¼šç‚¹å‡»ä»£ç å—å³ä¸Šè§’å¯ç›´æ¥å¤åˆ¶")
            
        except Exception as e:
            st.error(f"æ¸²æŸ“é”™è¯¯: {str(e)}")


ç¬¬äºŒæ­¥ï¼šæœ€åä¸€æ¬¡è¿æ¥ä¸»ç¨‹åº
æˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰è§†å›¾ã€‚ç°åœ¨å» app.py æŠŠæœ€åä¸€å—æ‹¼å›¾è¡¥ä¸Šã€‚
æ“ä½œï¼šæ‰“å¼€ app.pyï¼Œæ‰¾åˆ° if menu == 'æ§åˆ¶å°': è¿™ä¸€æ®µï¼Œæ›¿æ¢ä¸ºï¼š
# app.py ä¸­éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†

# ... (å‰é¢ä»£ç ä¸å˜)

# --- ä¸»ç•Œé¢è·¯ç”±é€»è¾‘ ---
if menu == 'æ§åˆ¶å°':
    from views.dashboard import render_dashboard
    render_dashboard()

elif menu == 'æ ‡ç­¾å·¥åŠ':
# ... (åé¢ä»£ç ä¸å˜)

ğŸ‰ æ­å–œï¼é¡¹ç›®æ„å»ºå®Œæˆï¼
ç°åœ¨ï¼Œä½ æ‹¥æœ‰äº†ä¸€ä¸ªå®Œæ•´ã€æ¨¡å—åŒ–ã€å…·å¤‡é«˜çº§æ„Ÿçš„å‘½ä»¤ç”Ÿæˆå™¨ã€‚
è¯·æ‰§è¡Œæœ€ç»ˆæµ‹è¯•ï¼š
 * å¯åŠ¨ç¨‹åºï¼šstreamlit run app.py
 * æ–°å»ºæµç¨‹ï¼š
   * å»ã€æ ‡ç­¾å·¥åŠã€‘å»ºä¸€ä¸ªå« "Production" çš„çº¢è‰² Tagã€‚
   * å»ã€ç¼–è¾‘å™¨ã€‘æ–°å»ºä¸€ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚ Check Diskï¼Œå…³è”è¿™ä¸ª Tagï¼Œå†™ä¸ªæ¨¡æ¿ df -h {{ path }}ã€‚
   * ä¿å­˜ã€‚
 * ä½¿ç”¨æµç¨‹ï¼š
   * å›åˆ°ã€æ§åˆ¶å°ã€‘ã€‚
   * ä½ åº”è¯¥èƒ½çœ‹åˆ°åˆšæ‰çš„ Check Disk å¡ç‰‡ã€‚
   * ç‚¹å‡»ä¸Šé¢çš„ "Production" èŠ¯ç‰‡ï¼Œåº”è¯¥èƒ½ç­›é€‰å‡ºå®ƒã€‚
   * ç‚¹å‡» â€œğŸš€ è¿è¡Œâ€ã€‚
   * åœ¨å¼¹çª—é‡Œè¾“å…¥ /var/logï¼Œç‚¹å‡»ç”Ÿæˆã€‚
   * è§è¯å¥‡è¿¹ï¼šä»£ç å‡ºæ¥äº†ï¼Œè€Œä¸”å³ä¾§çš„ã€æ—¶å…‰æœºã€‘é‡Œä¹Ÿå‡ºç°äº†è¿™æ¡è®°å½•ã€‚
 * ä¿®æ”¹æµç¨‹ï¼š
   * ç‚¹å‡»å¡ç‰‡ä¸Šçš„å°é“…ç¬” âœï¸ã€‚
   * æ ¹æ® Toast æç¤ºï¼Œç‚¹å‡»å·¦ä¾§èœå•çš„ã€ç¼–è¾‘å™¨ã€‘ã€‚
   * ä½ ä¼šå‘ç°åˆšæ‰çš„å‘½ä»¤å·²ç»è‡ªåŠ¨åŠ è½½è¿›å»äº†ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ã€‚
è¿™å°±å®Œäº†å—ï¼Ÿ
ä¸ï¼Œæˆ‘ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªå½©è›‹ã€‚
å¦‚æœä½ æƒ³è®©ç•Œé¢æ›´é…·ä¸€ç‚¹ï¼Œå¯ä»¥å» assets/style.css çš„æœ€åï¼ŒåŠ ä¸Šè¿™å‡ è¡Œä»£ç ï¼Œç»™æŒ‰é’®åŠ ä¸ªæ¸å˜è‰²ï¼š
/* ç»™ä¸»è¦æŒ‰é’®åŠ æ¸å˜è‰² */
button[kind="primary"] {
    background: linear-gradient(90deg, #4D96FF 0%, #6BCB77 100%) !important;
    border: none !important;
    transition: all 0.3s ease !important;
}
button[kind="primary"]:hover {
    opacity: 0.9;
    transform: scale(1.02);
}

ç°åœ¨ï¼Œè¿™ä¸ªé¡¹ç›®æ˜¯ä½ çš„äº†ã€‚å°½æƒ…ä½¿ç”¨å§ï¼å¦‚æœåœ¨éƒ¨ç½²æˆ–è€…ä½¿ç”¨ä¸­é‡åˆ°ä»»ä½•æŠ¥é”™ï¼Œéšæ—¶æŠŠé”™è¯¯ä¿¡æ¯ä¸¢ç»™æˆ‘ï¼Œæˆ‘ç§’ä¿®ã€‚
